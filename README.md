# 📊 台股智能分析系統

基於真實法人數據的台股三階段分析系統，提供盤前預測、盤中量能掃描、盤後驗證的完整投資決策流程。

## ✨ 核心特色

- 🔥 **盤中量能掃描器** - 12:30即時偵測法人吸貨訊號，提前卡位尾盤
- 📊 **三階段分析流程** - 盤前預測(09:00) → 盤中掃描(12:30) → 盤後驗證(14:30)
- 📈 **真實法人數據** - 串接證交所官方API，無假資料、無模擬數據
- 💼 **個人持股管理** - 5日法人動向追蹤，提前發現風險
- 🎯 **預測準確率追蹤** - 系統化記錄預測成敗，持續優化策略
- 🗓️ **事件日曆整合** - 追蹤CPI、FOMC、財報等重要事件影響

## 🚀 快速開始

### 1. 環境設置
```bash
# 安裝依賴
pip install -r requirements.txt
```

### 2. 每日分析流程（三階段）

#### 📅 盤前分析（09:00前）
**目標**：基於時事+法人數據，預測6-10檔佈局機會

**分析權重**：
- 時事分析：40%（美股、CPI、產業新聞）
- 法人數據：40%（昨日法人買賣超TOP30）
- 技術分析：20%（支撐壓力、趨勢）

**執行方式**：
```bash
# 查詢昨日法人數據（全市場掃描）
python3 check_institutional.py ALL 20251112

# 分析持股法人動向
python3 portfolio_analyzer.py

# 輸出：data/2025-11-13/before_market_analysis.md
```

**盤前報告內容**：
- 昨日回顧與國際時事
- 全市場法人買賣超TOP30
- 今日佈局策略（6-10檔預測）
- 持股操作建議（停損、減碼）

---

#### 🔥 盤中分析（12:30）★ 最重要
**目標**：透過量能推測法人意圖，給出尾盤策略

**分析權重**：
- 量能分析：100%（爆量+小漲+法人買超 = 吸貨訊號）

**執行方式**：
```bash
# 12:30執行盤中量能掃描器
python3 intraday_scanner.py

# 輸出：data/2025-11-13/intraday_analysis.md
```

**掃描邏輯**：
```
✅ 機會訊號（進場）：
- 爆量（>3倍均量）
- 小漲（<3%）
- 昨日法人買超
→ 推測：法人吸貨中，尾盤可進

⚠️ 偏強訊號（觀望）：
- 爆量 + 中漲（3-5%）
→ 推測：已被發現，等回檔

❌ 太晚訊號（避開）：
- 爆量 + 大漲（>5%）
→ 推測：追高陷阱

❌ 出貨訊號（停損）：
- 爆量 + 下跌 + 法人賣超
→ 推測：法人出貨
```

**盤中報告內容**：
- 量能掃描結果（機會股、觀望股、避開股）
- 法人意圖推測
- 尾盤佈局策略（12:30-13:00）
- 持股盤中表現

---

#### 📊 盤後分析（14:30後）
**目標**：驗證預測、查詢今日法人、規劃明日策略

**分析權重**：
- 盤中預測驗證：60%（主要，使用隔日收盤驗證）
- 盤前預測驗證：20%（次要）
- 今日法人數據：40%（明日佈局依據）

**執行方式**：
```bash
# 查詢今日法人數據（全市場掃描）
python3 check_institutional.py ALL 20251113

# 查詢持股5日法人動向
python3 portfolio_analyzer.py

# 輸出：data/2025-11-13/after_market_analysis.md
```

**盤後報告內容**：
- 盤中預測驗證（主要60%，隔日驗證）
- 盤前預測驗證（次要20%）
- 今日法人數據（全市場TOP30）
- 買賣比指標計算
- 預測準確率統計
- 明日佈局策略

**重要**：盤中預測需使用「隔日收盤」驗證，不是當日收盤
- 案例：晟銘電11/11盤中+1.09%（預測吸貨中）
- 11/11收盤-0.36%（洗盤震盪）
- **11/12收盤+5.82%（驗證成功）** ✅

---

## 🔧 核心工具

### 1. 盤中量能掃描器（最重要）
```bash
python3 intraday_scanner.py
```

**功能**：
- 客觀掃描全市場量能異常
- 找出「法人正在佈局、但還沒大漲」的機會股
- 給出明確進場/觀望/避開訊號

**使用時機**：
- ⏰ **每日12:30執行**（最佳時機）
- 盤前分析後，需要盤中驗證法人意圖
- 尾盤佈局前，需要確認進場時機

**輸出範例**：
```
✅ 發現機會股（爆量+小漲+法人買）：
代號   名稱       漲跌%   量比   昨日投信    昨日外資
--------------------------------------------------------------
3715  定穎投控    +2.3%  5.2x    +45,000  +21,673,835
8112  至上        +1.8%  4.1x  +1,516,000   +5,220,260

→ 判斷：法人吸貨中，尾盤回檔可進場
```

**數據來源**：
- 法人數據：證交所API（前一日）
- 股價量能：Yahoo Finance（延遲15-20分鐘）

**注意事項**：
- ⚠️ 必須對照券商軟體驗證，不可盲目跟單
- ⚠️ Yahoo Finance有延遲，建議12:00-12:30執行
- ⚠️ 進場必設停損（-8%）
- ⚠️ 單檔不超過總資金20%

---

### 2. 單一股票法人查詢
```bash
# 查詢單一股票（不受TOP50限制）
python3 check_institutional.py 2330 20251112

# 查詢全市場買賣超TOP30
python3 check_institutional.py ALL 20251112
```

**功能**：
- 查詢任何股票的法人買賣超數據
- 不受「只能看TOP50」的限制
- 直接查證交所API，買賣超都能看

**使用時機**：
- 盤前查詢昨日法人數據（全市場掃描）
- 盤後查詢今日法人數據（驗證+明日策略）
- 驗證盤中掃描器的法人數據真實性

---

### 3. 持股分析與法人追蹤
```bash
python3 portfolio_analyzer.py
```

**功能**：
- 計算持股損益
- 查詢持股5日法人動向
- 給出停損/減碼/續抱建議

**輸出範例**：
```
📊 持股法人動向

玉山金 (2884):
  日期        投信      自營商    外資      三大法人
  ------------------------------------------------------------
  11/11      +449      +1,331  +30,780,520     +32,300
  11/07   -28,315          +0  -16,520,480    -44,835
  11/06   -40,860          +0  -19,079,520    -59,939
  11/05    +1,800          +0   +2,419,520      +4,219
  11/04    +3,000          +0   +7,479,520     +10,479
  ------------------------------------------------------------
  5日累計  -63,926      +1,331   +5,079,560    -57,776

→ 判斷：❌ 災難級別（5日法人逃-57,776K）
→ 建議：明日開盤立即停損
```

---

## 📁 目錄結構

```
stock/
├── src/                              # 核心模組
│   ├── main.py                       # 股票查詢分析
│   ├── portfolio_analyzer.py         # 持股分析
│   ├── data_fetcher.py               # 數據獲取
│   ├── analyzer.py                   # 分析引擎
│   ├── query_parser.py               # 查詢解析
│   └── utils.py                      # 工具函數
│
├── intraday_scanner.py               # 🔥 盤中量能掃描器（最重要）
├── check_institutional.py            # 單一股票法人查詢
│
├── portfolio/                        # 持股管理
│   ├── my_holdings.yaml              # 個人持股配置
│   └── archive/                      # 歷史記錄
│
├── data/                             # 每日分析報告
│   └── YYYY-MM-DD/
│       ├── before_market_analysis.md  # 盤前分析
│       ├── intraday_analysis.md       # 盤中分析
│       └── after_market_analysis.md   # 盤後分析
│
├── docs/                             # 系統文件
│   ├── ANALYSIS_STANDARDS_V2.md      # 三階段分析標準
│   └── PREDICTION_ACCURACY_TRACKING.md # 預測準確率追蹤
│
├── CLAUDE.md                         # 系統核心規範
├── CONVERSATION_START_CHECKLIST.md   # 對話開始檢查清單
├── config.yaml                       # 系統設定
├── requirements.txt                  # 依賴套件
└── README.md                         # 本文件
```

---

## ⚙️ 設定檔

### portfolio/my_holdings.yaml（個人持股）
```yaml
holdings:
  - symbol: "2330"           # 台積電
    name: "台積電"
    buy_price: 1000.0        # 買入價格
    quantity: 0.001          # 零股（1股 = 0.001張）
    buy_date: "2025-11-01"
    notes: "核心資產"

  - symbol: "2884"           # 玉山金
    name: "玉山金"
    buy_price: 33.848
    quantity: 1              # 1張
    buy_date: "2025-10-15"
    notes: "金融股"

  - symbol: "2883"           # 凱基金
    name: "凱基金"
    buy_price: 15.95
    quantity: 1
    buy_date: "2025-11-08"
    notes: "金融股"

# 投資策略
strategy:
  stop_loss_percent: -8      # 停損-8%
  take_profit_percent: 20    # 停利+20%
  risk_tolerance: "medium"   # 中等風險
```

### config.yaml（系統設定）
```yaml
api:
  openai_api_key: ""         # OpenAI API key（選填）
  yahoo_finance_timeout: 30

data_sources:
  taiwan_stock:
    twse_url: "https://www.twse.com.tw"
    tdcc_url: "https://www.tdcc.com.tw"

scraping:
  request_timeout: 15
  delay_between_requests: 1
  max_retries: 3

analysis:
  sentiment_analysis: true
  institutional_analysis: true
  technical_analysis: true

logging:
  level: "INFO"
  file: "stock_analyzer.log"
```

---

## 📊 分析權重說明

### 盤前分析（09:00前）
```
時事分析：40%
├─ 美股overnight表現（費半、那斯達克）
├─ 重要經濟數據（CPI、非農、Fed決議）
└─ 產業時事（法說會、財報、訂單）

法人數據：40%
├─ 昨日法人買賣超TOP30（證交所API）
├─ 投信、外資、自營商動向
└─ 產業輪動分析

技術分析：20%
├─ 支撐壓力位
├─ 趨勢判斷
└─ 量價關係
```

### 盤中分析（12:30）
```
量能分析：100%
├─ 爆量偵測（>3倍均量）
├─ 量價關係（爆量+小漲 vs 爆量+大跌）
├─ 法人意圖推測（昨日法人買超 + 今日爆量 = 吸貨中）
└─ 尾盤策略（12:30-13:00進場時機）
```

### 盤後分析（14:30後）
```
盤中預測驗證：60%（主要）
├─ 使用隔日收盤驗證（不是當日收盤）
├─ 法人吸貨需要時間，當日震盪是正常的
└─ 更新PREDICTION_ACCURACY_TRACKING.md

盤前預測驗證：20%（次要）

今日法人數據：40%
├─ 查詢今日法人買賣超TOP30
├─ 計算買賣比指標
├─ 產業輪動分析
└─ 明日佈局策略
```

---

## 🎯 核心指標

### 買賣比指標（新增2025/11/11）
```
買賣比 = 買超金額 / 賣超金額的絕對值

強勢吸貨：買賣比 > 1.5
  案例：定穎投控1.59 → +9.85%

溫和吸貨：買賣比 1.2-1.5
  案例：晟銘電1.25 + 連續買超 + 爆量 → +5.82%

弱勢/出貨：買賣比 < 1.2
```

**重要**：買賣比需配合其他因素綜合判斷
- 連續買超天數
- 成交量爆增
- 產業邏輯支撐

### 法人5日追蹤
```
目的：提前發現風險，避免玉山金災難（5日逃-53,902K）

計算方式：
  5日累計 = 投信 + 自營商 + 外資

判斷標準：
  ✅ 5日累計 > +10,000K：法人持續買超
  ⚠️ 5日累計 -5,000K ~ +5,000K：震盪觀望
  ❌ 5日累計 < -10,000K：法人逃殺，停損
```

### 量能異常偵測
```
量比 = 今日成交量 / 5日平均量

爆量：量比 > 3倍
大量：量比 > 2倍
縮量：量比 < 0.5倍
```

---

## 🚨 重要規範（必讀）

### 禁止事項
```
❌ 事後諸葛：盤中說「XX股+9%」但盤前沒預測
❌ 追高推薦：推薦已漲>5%的股票（讓用戶接最後一棒）
❌ 主觀選股：只看持股、只看熟悉股票（必須全市場掃描）
❌ 機械化規則：買賣比1.25自動判定失敗（需綜合判斷）
❌ 過早判定：盤中預測當日收盤判定失敗（需隔日驗證）
```

### 必須執行
```
✅ 盤前：全市場法人掃描TOP30（不是只看持股）
✅ 盤中：12:30執行intraday_scanner.py（最高優先級）
✅ 盤後：驗證預測+全市場法人+明日策略
✅ 預測：找「法人在買、但還沒漲」的股票
✅ 驗證：盤中預測使用隔日收盤驗證
```

### 歷史教訓（2025年）
```
2025/10/01：過度保守災難（準確率8.3%）
2025/10/13：主觀選股災難（遺漏聯電+16,866K）
2025/10/21：事後諸葛災難（創意、緯穎盤前沒預測）
2025/10/28：追高推薦災難（旺宏、華邦電已漲20%）
2025/11/11：盤中驗證改進（晟銘電T+1驗證成功）

→ 改進後準確率：70%（7/10）
```

---

## 📈 預測準確率追蹤

系統化記錄每次預測的成敗，持續優化策略。

詳見：`PREDICTION_ACCURACY_TRACKING.md`

**最新成果**（2025/11/11）：
- 整體準確率：70%（7/10）
- 盤前預測：60%（6/10）
- 盤中預測：100%（1/1，使用T+1驗證）

**關鍵改進**：
1. 盤中預測改用「隔日驗證」
2. 新增買賣比指標（>1.5強勢）
3. 法人5日追蹤（提前發現風險）
4. 全市場客觀掃描（不主觀選股）

---

## 🗓️ 事件日曆整合（新增2025/11/12）

系統自動追蹤重要事件，調整分析策略。

### 11月重要事件
- **11/13 (三) 21:30** - 美國10月CPI 🔥（最近風險點）
- **11/15 (五) 14:00** - 台積電法說會
- **11月中** - 10月營收公佈期
- **11/29 (五)** - Q3季報截止日

### 12月重要事件
- **12/11 (三)** - 美國11月CPI
- **12/17-18** - FOMC會議
- **12/15-31** - 年底作帳行情

### 產業事件
- AI伺服器出貨高峰（11-12月）
- 記憶體價格趨勢（NAND漲、DRAM震盪）
- PCB旺季效應（定穎投控、欣興）
- 半導體設備交機潮（帆宣、漢唐）

詳見：`data/最新日期/after_market_analysis.md` 第九章

---

## ⚠️ 重要注意事項

### 數據來源與限制
1. **真實數據**：100%使用證交所和Yahoo Finance真實數據，無模擬資料
2. **更新頻率**：法人數據每日14:30-15:00公布，盤中無法取得
3. **Yahoo延遲**：盤中股價延遲15-20分鐘
4. **查詢限制**：避免短時間內大量查詢，以免觸發API限制

### 投資風險警告
1. **僅供參考**：所有分析結果僅供投資參考，不構成買賣建議
2. **風險自負**：投資有風險，請根據自身狀況謹慎決策
3. **及時性**：市場變化快速，請以最新資訊為準
4. **多元分析**：建議結合多種資訊來源進行投資決策
5. **必設停損**：進場必設停損（-8%），單檔不超過總資金20%

---

## 📊 專案統計

- **總代碼行數**：~2,500行
- **核心模組**：8個Python檔案
- **分析完整度**：90%（三階段分析完成）
- **預測準確率**：70%（2025/11/11統計）
- **數據覆蓋**：全台股市場
- **重要文件**：
  - `CLAUDE.md` - 系統核心規範（369行，2025/11/12壓縮）
  - `ANALYSIS_STANDARDS_V2.md` - 三階段分析標準
  - `PREDICTION_ACCURACY_TRACKING.md` - 預測追蹤
  - `CONVERSATION_START_CHECKLIST.md` - 對話檢查清單

---

## 📞 支援與回饋

### 常見問題
**Q1: 盤中掃描器沒有找到機會股？**
```
A: 正常現象，代表今日無符合條件的機會股
   → 建議觀望為主，不強求進場
```

**Q2: Yahoo Finance數據延遲怎麼辦？**
```
A: 必須對照券商軟體驗證，不可盲目跟單
   → intraday_scanner.py僅供參考，最終以券商數據為準
```

**Q3: 如何驗證法人數據真實性？**
```
A: 使用check_institutional.py查詢證交所API
   → python3 check_institutional.py 2330 20251112
   → 手動查詢：https://www.twse.com.tw/rwd/zh/fund/T86
```

**Q4: 為什麼盤中預測要隔日驗證？**
```
A: 法人吸貨需要時間，當日震盪是正常的
   → 案例：晟銘電11/11盤中+1.09%、收盤-0.36%（洗盤）
   → 11/12收盤+5.82%（驗證成功）
```

### 使用技巧
1. **每日12:30執行盤中掃描**（最高優先級）
2. **盤前必須全市場掃描法人TOP30**（不只看持股）
3. **進場必設停損-8%**（避免玉山金災難）
4. **法人5日追蹤**（提前發現風險）
5. **參考事件日曆**（CPI、FOMC、財報風險）

---

## 📄 免責聲明

本軟體僅供教育和研究目的使用。所有投資建議僅供參考，使用者應自行承擔投資風險。開發者不對任何投資損失負責。請務必在投資前進行充分的風險評估。

**特別提醒**：
- intraday_scanner.py 的Yahoo Finance數據有15-20分鐘延遲
- 必須對照券商軟體驗證，不可盲目跟單
- 進場必設停損（-8%），單檔不超過總資金20%
- 投資有風險，決策需謹慎

---

**版本**: v2.0.0 | **更新**: 2025年11月 | **Python**: 3.9+ | **狀態**: 穩定版（三階段分析完成）

**重大更新**（2025/11/12）：
- ✅ 新增盤中量能掃描器（intraday_scanner.py）
- ✅ 完善三階段分析流程
- ✅ 新增買賣比指標
- ✅ 新增法人5日追蹤
- ✅ 新增事件日曆整合
- ✅ 預測準確率提升至70%
- ✅ CLAUDE.md壓縮優化（-41%）
