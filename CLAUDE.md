# 🚨 當前版本：v5.7（2026-01-21更新）

## ⚠️ 強制執行規範（每次分析必須遵守）

### 分析前（絕對強制）

**Step 0: 建立 TodoWrite**
```bash
# 根據分析類型載入標準模板
盤前：參考 templates/before_market_todos.json
盤中：參考 templates/intraday_todos.json
盤後：參考 templates/after_market_todos.json
```

**執行規則**：
- ✅ 必須使用 TodoWrite 追蹤每個步驟
- ✅ 完成一步，標記為 completed
- ✅ 開始下一步，標記為 in_progress
- ❌ **絕對禁止**跳步驟
- ❌ **絕對禁止**批次標記多個 completed

---

### 分析後（絕對強制）

**驗證完整性**
```bash
# 分析完成後，執行驗證腳本
python3 scripts/validate_analysis.py before_market 2026-01-21
python3 scripts/validate_analysis.py intraday 2026-01-21
python3 scripts/validate_analysis.py after_market 2026-01-21

# 返回值：
# 0 = 驗證通過 → 允許 commit
# 1 = 驗證失敗 → 禁止 commit，必須修正
```

**驗證項目**：
- ✅ 版本是否為 v5.7
- ✅ 推薦數量是否 6-8 檔
- ✅ 產業是否至少 4 個
- ✅ 單一產業是否 ≤50%
- ✅ 檔案是否完整建立

---

### v5.7 最低要求（不符合 = 不合格）

| 階段 | 最低要求 |
|------|---------|
| **盤前** | 推薦 6-8檔、掃描14產業、產業分散≥4個、單一產業≤50%、建檔 .md + tracking.json |
| **盤中** | Track A + Track B、尾盤策略、建檔 intraday_analysis.md |
| **盤後** | Track A驗證 + Track B整合 + 雙軌對比、更新 tracking + predictions、建檔 after_market_analysis.md |

**❌ 違規後果**：
- 驗證腳本返回 1 = 禁止 commit
- 必須修正後重新驗證
- 記錄至 predictions.json 作為失誤案例

---

# CLAUDE.md

台股智能分析系統開發指引

## 系統概述

基於真實法人數據的台股分析系統，提供多維度股票分析和個人持股管理。

## 🚨 每次對話開始強制流程

### 0. 時間驗證（第一步，必須最先執行）⏰

**問題**：AI經常混淆日期和星期，導致分析時間錯亂

**強制執行命令**：
```bash
date "+%Y-%m-%d %A"  # 確認系統當前日期和星期
```

**輸出範例**：
```
2025-11-25 Tuesday
```

**檢查清單**：
- [ ] 執行 `date` 命令確認當前日期
- [ ] 確認當前星期幾
- [ ] 檢查最新分析文件日期（用 `ls -lt data/2025-11-*/` 確認）
- [ ] 確認今天是否為交易日（週一至週五）
- [ ] **絕對禁止**憑感覺或推算日期

**時間相關規則**：
1. ❌ 禁止說「今天是週X」而沒有執行 `date` 命令
2. ❌ 禁止推算星期（如「11/21是週四，11/25就是週一」）← **錯誤示範**
3. ✅ 必須用系統命令驗證時間
4. ✅ 分析報告標題必須標註星期（如「2025-11-25（週二）盤前分析」）

**範例**：
```
✅ 正確：
執行 `date` → 2025-11-25 Tuesday
「今天是2025-11-25（週二）」

❌ 錯誤：
「今天是2025-11-25（週一）」（沒有驗證）← 推算錯誤
「距離上次11/21是4天，所以是週一」（推算錯誤）← 11/21是週四，+4天=週一？錯！
```

---

### 1. 🔥 歷史驗證優先原則（最重要！）

**⚠️ 重大教訓（2025-12-01）**：分析必須「歷史優先」，不能「理論優先」

### 🚨 強制分析流程（必須按順序執行）

**🔴 流程執行強制規定（2026-01-14新增）**：

1. **必須使用 TodoWrite 追蹤進度** - 絕對不能跳過
2. **必須逐步打勾** - 完成一步才能進行下一步
3. **發現問題立即停止** - 不能「先繼續再說」

**TodoWrite 範例**：
```json
[
  {"content": "Step -1: 資訊同步檢查", "status": "in_progress", "activeForm": "檢查資訊同步"},
  {"content": "Step 0: 國際市場數據", "status": "pending", "activeForm": "獲取國際數據"},
  {"content": "Step 0.5: 即時股價查詢", "status": "pending", "activeForm": "查詢即時股價"},
  {"content": "Step 1: 歷史驗證", "status": "pending", "activeForm": "驗證歷史推薦"},
  {"content": "Step 1.7: key_lessons 檢查", "status": "pending", "activeForm": "檢查昨日教訓"},
  {"content": "Step 1.8: 持股法人追蹤", "status": "pending", "activeForm": "追蹤持股法人"},
  {"content": "Step 3-6: 選股流程", "status": "pending", "activeForm": "執行選股"},
  {"content": "Step 7: 建檔", "status": "pending", "activeForm": "建立文件"}
]
```

**❌ 絕對禁止**：
- ❌ 不用 TodoWrite 就開始分析
- ❌ 跳過某個 Step
- ❌ 完成多個 Step 才一起標記 completed

---

**Step -1: 🚨 資訊同步檢查（分析前第一步）** 🆕 2026-01-14

**⚠️ 血淚教訓（2026-01-14）**：
- 問題：慧洋已賣出但分析寫「續抱」，用戶：「操你媽的 我賠錢 妳有錢賠給我嗎」
- 原因：沒有讀取最新的 intraday_analysis.md，不知道持股變動
- 後果：資訊錯誤，用戶極度不滿

**🔴 強制執行（絕對不能跳過）**：
```bash
# 1. 讀取昨日盤中/盤後分析（檢查持股變動）
cat data/$(date -d yesterday +%Y-%m-%d)/intraday_analysis.md | grep -A 10 "持股操作"
cat data/$(date -d yesterday +%Y-%m-%d)/after_market_analysis*.md | grep -A 10 "持股"

# 2. 讀取最新持股狀態
cat portfolio/my_holdings.yaml

# 3. 讀取最新 tracking（檢查推薦記錄）
cat data/tracking/tracking_$(date -d yesterday +%Y-%m-%d).json
```

**🔥 必須確認的事項（逐項打勾）**：
- [ ] 昨日是否有「賣出」操作？（intraday/after_market 中是否提到「出場」「賣出」「停損」）
- [ ] my_holdings.yaml 與昨日分析是否一致？
- [ ] 是否有「已賣出但 quantity ≠ 0」的錯誤？
- [ ] 是否有「推薦但從未建立 tracking」的遺漏？

**🔥 發現不一致時的處理**：
1. **立即停止分析**
2. **先修正** my_holdings.yaml 或 tracking.json
3. **Commit 修正**
4. **再繼續**分析

**❌ 絕對禁止**：
- ❌ 跳過此步驟「直接開始分析」
- ❌ 發現不一致但「想說等等再改」
- ❌ 憑記憶判斷持股狀態

---

**Step 0: 國際市場數據（盤前必須執行）**
```bash
# 盤前分析第一步：獲取最新國際市場數據
python3 scripts/fetch_us_asia_markets.py
```
⚠️ **禁止使用「資料更新中」** - 必須獲取真實即時數據
⚠️ **禁止硬編碼數據** - 所有國際市場數據必須即時查詢

**Step 0.5: 🚨 即時股價查詢（強制執行）** 🆕 2025-12-19血淚教訓
```python
# 必須查詢所有推薦股票的即時價格
python3 -c "
import requests
stocks = ['2303', '2330', '3037', '2337', '2883']  # 推薦股票清單
for s in stocks:
    url = f'https://query1.finance.yahoo.com/v8/finance/chart/{s}.TW?interval=1d&range=5d'
    r = requests.get(url, headers={'User-Agent': 'Mozilla/5.0'}, timeout=10)
    data = r.json()
    close = data['chart']['result'][0]['meta']['regularMarketPrice']
    print(f'{s}: 現價={close}')
"
```

**⚠️ 重大教訓（2025-12-19）**：
- 問題：使用舊 session 的記憶數據（台積電1070→實際1430）
- 原因：沒有在分析前查詢即時股價
- 後果：進場價完全錯誤，用戶無法使用

**🔴 強制規則**：
1. ❌ **絕對禁止**使用記憶中的股價
2. ❌ **絕對禁止**從上下文推斷股價
3. ✅ **必須執行** Yahoo Finance 即時查詢
4. ✅ 進場價必須基於查詢結果設定

**Step 1: 歷史成功驗證（第一優先）** 🚨 **絕對強制執行**
```bash
# 必須先查看最近推薦結果
ls data/tracking/tracking_*.json | tail -3
cat data/tracking/tracking_$(date -d yesterday +%Y-%m-%d).json  # 昨日tracking

# ⚠️ 如果tracking檔案不存在，絕對禁止進行盤前分析
# 必須先建立歷史追蹤記錄才能繼續
```

**🔥 歷史驗證強制內容**：
1. **昨日推薦股票表現** - 逐檔檢查收盤價vs推薦價
2. **成功/失敗分析** - 為什麼成功？為什麼失敗？
3. **準確率計算** - X/Y = Z%，必須明確標示
4. **延續性檢查** - 成功股票的因素今日是否持續？
5. **教訓應用** - 失敗模式今日是否要避開？

**Step 1.5: 參考 predictions 歷史教訓（強制）** 🆕
```bash
# 查看歷史預測記錄和教訓
cat data/predictions/predictions.json
```

**🔥 predictions 參考重點**：
1. **近期準確率趨勢** - 上升/下降？需要調整策略？
2. **重大教訓回顧** - 如12/10法人反轉教訓：連漲5日+狂買>30K需警惕
3. **失敗模式檢查** - 今日推薦是否觸犯歷史失敗模式？
4. **成功模式應用** - 歷史成功案例的共同特徵是什麼？

**Step 1.7: 🚨 昨日 key_lessons 主動檢查（強制執行但靈活判斷）** 🆕 2026-01-13

**⚠️ 血淚教訓（2026-01-13）**：
- 問題：昨日記錄「PCB族群爆發（下次Micron大漲要納入觀察）」但今日盤前沒有主動檢查 PCB 股票
- 盲點：記錄教訓 ≠ 應用教訓，需要主動檢查然後靈活判斷
- 結果：今日 PCB 續強（華通+5.91%、燿華+3.71%）但盤前完全沒檢查，直到盤中才發現

**🔥 強制執行流程**：
```bash
# 1. 讀取昨日 tracking.json 的 key_lessons
cat data/tracking/tracking_$(date -d yesterday +%Y-%m-%d).json | grep -A 5 "key_lessons"

# 2. 對每條教訓逐一檢查
```

**🔥 主動檢查 → 靈活判斷流程**：

對每條昨日教訓，必須執行以下步驟：

1. **判斷今日是否相關**
   - 例：昨日教訓「PCB族群爆發（下次Micron大漲要納入觀察）」
   - 檢查：今日 Micron 是否大漲？半導體時事是否延續？
   - 結論：✅ 相關 / ❌ 不相關

2. **主動查詢相關股票**
   - 例：查詢 華通(2313)、燿華(2367)、欣興(3037)
   - 使用工具：
     ```python
     python3 -c "
     import requests
     stocks = ['2313', '2367', '3037']  # PCB相關
     for s in stocks:
         url = f'https://query1.finance.yahoo.com/v8/finance/chart/{s}.TW?interval=1d&range=5d'
         r = requests.get(url, headers={'User-Agent': 'Mozilla/5.0'}, timeout=10)
         data = r.json()
         close = data['chart']['result'][0]['meta']['regularMarketPrice']
         prev = data['chart']['result'][0]['meta']['previousClose']
         change = ((close - prev) / prev) * 100
         print(f'{s}: {close}元 ({change:+.2f}%)')
     "
     ```

3. **依實際情況靈活判斷**
   - 檢查 5 日漲幅、法人態度、量價關係
   - 判斷標準：
     - 5日漲幅 <3% + 法人買超 → ✅ 可推薦（還沒大漲）
     - 5日漲幅 3-8% → ⚠️ 標註追高風險
     - 5日漲幅 >8% 或連2日漲>10% → ❌ 不推薦（已大漲）
     - 法人反轉賣超 → ❌ 不推薦（動能轉弱）

4. **記錄檢查決策**
   - 在盤前分析中必須明確標註：
     ```markdown
     ## 📋 昨日教訓檢查記錄

     ✅ 已檢查：PCB族群教訓
     - 華通(2313)：昨+9.96%，今開盤+5.91%，連2日漲15%+
     - 判斷：❌ 不推薦（已連續大漲，追高風險）
     - 決策：盤中觀察是否有回檔機會
     ```

**範例：正確流程**
```
昨日教訓："PCB族群爆發（下次Micron大漲要納入觀察）"

Step 1: 判斷相關性
→ 今日費半+1.5%，半導體時事延續
→ ✅ 相關，需要檢查 PCB

Step 2: 主動查詢
→ 華通(2313)：昨+9.96%，今+5.91%
→ 燿華(2367)：昨+4.66%，今+3.71%
→ 欣興(3037)：昨+5%，今持平

Step 3: 靈活判斷
→ 華通：連2日漲15%+ → ❌ 不追高
→ 燿華：連2日漲8%+ → ❌ 不追高
→ 欣興：已漲5%今持平 → ⚠️ 觀察，等回檔

Step 4: 記錄決策
→ 在盤前分析中標註：
   "✅ 已檢查PCB教訓：華通、燿華連日大漲，判斷不追高"
```

**範例：錯誤做法**
```
❌ 錯誤1：沒有主動檢查
→ 昨日寫了教訓，今日完全沒查 PCB 股票
→ 結果：盤中才發現 PCB 續強

❌ 錯誤2：機械式執行
→ 看到「下次Micron大漲要納入觀察」
→ 不管價格直接推薦 PCB
→ 結果：推薦已漲15%的追高股

❌ 錯誤3：檢查了但沒記錄
→ 心裡想了「PCB已經漲太多」
→ 但分析中沒寫出來
→ 用戶質疑：為什麼不關注 PCB？
```

**🔴 強制規則**：
1. ✅ **必須主動檢查**：每條昨日教訓都要檢查是否相關
2. ✅ **必須查詢實際數據**：不能憑印象判斷
3. ✅ **必須靈活判斷**：依實際情況決定，不是機械執行
4. ✅ **必須記錄決策**：在盤前分析中明確標註檢查過程和判斷結果
5. ❌ **絕對禁止**：記錄教訓但不檢查
6. ❌ **絕對禁止**：檢查了但不記錄決策過程

**Step 1.8: 🚨 用戶持股法人追蹤（強制比對）** 🆕

**⚠️ 血淚教訓（2025-12-12）**：
- 問題：12/09 群創外資狂買+31K（第一名），12/10 反轉賣超-2.8K
- 盲點：盤前只看法人 TOP10，沒有主動追蹤用戶持股的法人變化
- 結果：用戶 12/09 加碼群創，12/10 法人反轉但沒被警示

**🔥 強制執行規則**：
```bash
# 1. 讀取用戶持股
cat portfolio/my_holdings.yaml

# 2. 對每檔持股查詢「前日」和「昨日」法人數據
python3 scripts/check_institutional.py [股票代號] [前日日期]
python3 scripts/check_institutional.py [股票代號] [昨日日期]

# 3. 比對變化，標註續買/反轉
```

**🔥 持股法人比對表（盤前必須輸出）**：
```
| 股票 | 前日法人 | 昨日法人 | 變化 | 警示 |
|------|---------|---------|------|------|
| 群創 | +31,758 | -2,872 | 🔴 反轉 | ⚠️ 外資翻臉！考慮減碼 |
| 凱基金 | +24,395 | +39,765 | 🟢 續買 | ✅ 持續加碼，續抱 |
| 兆豐金 | -500 | +3,084 | 🟡 轉買 | 觀察是否延續 |
```

**🔥 警示判斷標準**：
| 變化類型 | 判斷標準 | 警示等級 | 建議 |
|---------|---------|---------|------|
| 🔴 **反轉賣** | 前日買超 → 昨日賣超 | ⚠️ 高危 | 考慮減碼或設停損 |
| 🔴 **加速賣** | 前日賣超 → 昨日賣更多 | ⚠️ 高危 | 嚴守停損 |
| 🟢 **續買** | 前日買超 → 昨日續買 | ✅ 安全 | 續抱 |
| 🟢 **轉買** | 前日賣超 → 昨日轉買 | ✅ 正向 | 觀察延續性 |
| 🟡 **減買** | 前日大買 → 昨日小買 | ⚠️ 注意 | 觀察是否反轉 |

**❌ 絕對禁止**：
1. 只列「昨日法人」，沒有比對「前日法人」
2. 用戶持股不在 TOP10 就不追蹤
3. 看到反轉訊號但沒有警示用戶

**Step 2: 基於歷史驗證調整推薦（第二優先）**
- 🔥 **延續成功模式** - 尋找類似昨日成功股票的特質
- 🔥 **避開失敗模式** - 避免重複昨日失敗股票的特質
- 🔥 **優先級調整** - 成功延續型 > 全新挖掘型

**Step 3: 🔥 時事先行 - 判斷產業催化劑（30%權重來源）** 🆕

**⚠️ 重大教訓（2025-12-17）**：
- 問題：只看法人買超TOP10 → 推薦 → 開盤就漲 → 用戶沒機會進場
- 原因：法人數據變成70-80%權重，時事只有10-20%
- 解決：**時事先行，從產業找股票，不是從法人找股票**

**🔥 時事→產業對照表 v2.0（必須使用）**：

**🚨 v5.7 重大更新（2026-01-21教訓）**：
- 問題：費半+1.56%只推薦載板，遺漏記憶體（華邦電+5.85%）
- 解決：費半利多時，**必須掃描全部5個次產業**

| 時事訊號 | 利多產業 | 次產業展開（必須全掃）| 代表股票 |
|---------|---------|---------------------|---------|
| **費半漲>1%** | **半導體** | ①晶圓代工 ②載板/PCB ③記憶體 ④封測 ⑤電源供應 | 見下方展開表 |
| 費半跌>1% | 金融（防禦）| ⚠️ **特殊規則** | 見下方金融防禦規則 |
| 輝達/AMD大漲 | AI伺服器 | - | 廣達、緯創、鴻海、技嘉、英業達 |
| 輝達/AMD大漲 | 電源供應 | - | 台達電、康舒、光寶科、群電 |
| 油價漲>2% | 航運、塑化 | - | 長榮、陽明、台塑、南亞 |
| 美元跌 | 出口股 | - | 鴻海、廣達、仁寶 |
| Fed降息/鴿派 | 營建、金融 | - | 國建、興富發、金融股 |
| 記憶體漲價 | 記憶體 | - | 南亞科、華邦電、旺宏 |
| ABF/載板需求 | PCB/載板 | - | 欣興、景碩、南電 |
| 玻纖布缺貨 | 玻璃/建材 | - | 台玻、中釉、台泥 |
| 面板漲價 | 面板 | - | 群創、友達、彩晶 |
| 鋼價上漲 | 鋼鐵 | - | 中鋼、豐興、東鋼 |
| MLCC漲價 | 被動元件 | - | 國巨、華新科、禾伸堂 |
| iPhone出貨 | 蘋概股 | - | 鴻海、大立光、可成 |

**🔥 費半利多→半導體次產業展開表（強制全掃）**：

| 次產業 | 代表股票 | 說明 |
|--------|---------|------|
| ①晶圓代工 | 台積電(2330)、聯電(2303)、世界先進(5347) | 費半直接受惠 |
| ②載板/PCB | 欣興(3037)、景碩(3189)、南電(8046)、金像電(2368) | ABF載板、AI伺服器 |
| ③記憶體 | 華邦電(2344)、南亞科(2408)、旺宏(2337)、威剛(3260) | **🆕 常遺漏！** |
| ④封測 | 日月光(3711)、力成(6239)、京元電(2449)、南茂(8150) | CoWoS、HBM封裝 |
| ⑤電源供應 | 台達電(2308)、光寶科(2301)、康舒(6282)、群電(6412) | AI伺服器電源 |

**🔴 金融防禦策略特殊規則（v5.7新增）**：

**⚠️ 重大教訓（2026-01-21）**：
- 案例：台新金+3.70%但法人-20K大賣超
- 問題：金融防禦策略「有效但短暫」，法人會快速出貨
- 結論：金融防禦股適合當沖/隔日沖，不適合波段

| 參數 | 舊規則 | **新規則（v5.7）** |
|------|--------|-------------------|
| 倉位 | 10-15% | **5%（最多）** |
| 停利 | +5-8% | **+2%立即出場** |
| 持有時間 | 3-7天 | **1天（當沖/隔日沖）** |
| 停損 | -5% | **-2%快速停損** |

**金融防禦股代表**：
- 凱基金(2883)、兆豐金(2886)、台新金(2887)、中信金(2891)

**使用情境**：
| 情境 | 是否使用金融防禦 |
|------|-----------------|
| 費半跌>2% + 美股大跌>2% | ⚠️ 可用（小倉位5%）|
| 費半跌1-2% | ❌ 不用（直接找其他產業）|
| 費半平盤或小跌<1% | ❌ 不用 |

**⚠️ 強制執行規則**：
- ❌ **絕對禁止**：費半利多時只看1-2個次產業
- ✅ **必須執行**：費半利多時掃描全部5個次產業
- ✅ **必須輸出**：每個次產業至少檢查2檔股票的法人數據

**強制執行**：
1. 先看時事 → 判斷哪個產業有催化劑
2. **展開該產業的所有次產業**
3. 列出每個次產業的股票清單
4. 再用法人數據驗證

**Step 3.5: 產業展開 - 列出目標產業股票**

根據 Step 3 判斷的產業，列出該產業**所有次產業**的主要股票：
```
範例（費半+1.56%利多半導體）：

半導體產業展開（必須全掃5個次產業）：
├─ ①晶圓代工：台積電(2330)、聯電(2303)、世界先進(5347)
├─ ②載板/PCB：欣興(3037)、景碩(3189)、南電(8046)
├─ ③記憶體：華邦電(2344)、南亞科(2408)、旺宏(2337) ← 常遺漏！
├─ ④封測：日月光(3711)、力成(6239)、京元電(2449)
└─ ⑤電源供應：台達電(2308)、光寶科(2301)、康舒(6282)

然後對每個次產業查詢法人數據，篩選「法人買超+還沒漲」的股票
```

**Step 4: 法人驗證 - 確認法人態度（30%權重來源）**

在 Step 3.5 的產業股票中，查詢法人態度：
```bash
# 方法1：查詢法人買超TOP50（快速篩選）
python3 scripts/fetch_institutional_top50.py [日期YYYYMMDD]

# 方法2：查詢單一股票（個別確認）
python3 scripts/check_institutional.py [股票代號] [日期]
```

**🔥 法人驗證重點**：
1. **不是看法人買超TOP10來選股**
2. **而是在「時事利多的產業」中，確認法人態度**
3. 優先選擇「產業利多 + 法人買超 + 還沒大漲」的股票

**Step 4.3: 🆕 籌碼深度分析（對有興趣的3-5檔）**

對 TOP50 篩選出的候選股，做籌碼深度分析：
```bash
# 查詢近10天法人買賣超歷史
python3 scripts/chip_analysis.py 2883 2887 2303
```

**🔥 籌碼分析重點**：
1. **真連續買超** - 中間有沒有賣？連買幾天？
2. **累計淨買超** - 10天加總多少？
3. **外資vs投信** - 同步買？還是對決？

**籌碼判斷標準**：
| 判斷 | 條件 | 建議 |
|------|------|------|
| ✅ 佈局 | 連續買超≥5天 + 累計淨買>0 | 可進場 |
| ✅ 買進 | 連續買超3-4天 + 累計淨買>0 | 可進場 |
| 🟡 偏多 | 買多於賣但不連續 | 觀察 |
| ⚠️ 反轉 | 累計買超但最近開始賣 | 警戒 |
| 🔴 出貨 | 累計賣超且最近在賣 | 避開 |

**Step 4.5: 價格篩選 - 排除已大漲（10%權重來源）**

**🔴 強制排除**：
| 條件 | 動作 |
|------|------|
| 5日漲幅 > 10% | ❌ 絕對不推薦 |
| 5日漲幅 > 5% | ⚠️ 降低評分，標註追高風險 |
| 5日漲幅 < 3% | ✅ 優先推薦（還沒漲） |
| 5日漲幅 < 0% | ⭐ 最佳（法人買但股價跌=悄悄吸貨）|

**佈局股判斷標準 v2.0（雙重驗證）**：

**🚨 v5.7 重大更新（2026-01-21教訓）**：
- 問題：陽明外資買超+21K、5日-0.5%，但收盤-0.36%（佈局失敗）
- 原因：只看「法人買超+還沒漲」，忽略「產業催化劑」
- 解決：佈局股必須同時滿足「法人條件 + 產業條件」

**🔥 佈局股雙重驗證（必須同時滿足）**：

| 驗證類型 | 條件 | 必要性 |
|---------|------|--------|
| **法人條件** | 連續買超≥3日 + 累計>5K張 + 5日漲幅<3% | ✅ 必要 |
| **產業條件** | 有明確產業催化劑（時事利多/漲價/訂單） | ✅ **必要（新增）** |

**佈局股評分表**：
| 條件 | 標準 | 分數 |
|------|------|------|
| 連續買超天數 | ≥3日 | +20分 |
| 累計買超量 | >5K張 | +20分 |
| 5日漲幅 | <3% | +15分 |
| 5日漲幅 | <0%（最佳）| +25分 |
| **產業催化劑** | 有明確催化劑 | **+20分（新增）** |
| **產業催化劑** | 無催化劑 | **-30分（新增）** |

**佈局股門檻**：≥60分 才能標註為「佈局股」

**範例對比**：
```
✅ 英業達（佈局成功）：
- 法人：外資連3日買+13K ✅ (+40分)
- 漲幅：5日+1.5% ✅ (+15分)
- 催化劑：AI伺服器需求 ✅ (+20分)
- 總分：75分 → 推薦佈局

❌ 陽明（佈局失敗）：
- 法人：外資買超+21K ✅ (+40分)
- 漲幅：5日-0.5% ✅ (+25分)
- 催化劑：航運題材平淡 ❌ (-30分)
- 總分：35分 → 不推薦佈局
```

**⚠️ 警告：避開「連續大買後反轉」**
- 12/10教訓：力積電連續狂買+50K → 隔日法人反轉-20K
- 規則：連續買超>5日 且 單日買超>30K → 警惕獲利了結

**⚠️ 警告：避開「只有法人買、無產業催化」**
- 01/21教訓：陽明法人買超但-0.36%
- 規則：**無產業催化劑的佈局股 = 不推薦**

**Step 5: 五維度評分（綜合評估）**
- 時事現況（30%）← **時事先行，權重提前**
- 法人數據（30%）← **驗證用，不是選股用**
- 產業邏輯（20%）
- 價格位置（10%）← **排除已大漲**
- 技術面（10%）

**Step 5.5: 🚨 產業分散檢查（強制）** 🆕

**⚠️ 重大教訓（2025-12-17）**：
- 問題：12/12-12/17 金融股佔比75-80%，產業過度集中
- 解決：強制產業分散規則

**🔴 產業分散規則（必須遵守）**：
| 規則 | 說明 |
|------|------|
| 單一產業上限 | ≤50%（如5檔推薦，金融最多2-3檔）|
| 最少產業數 | ≥2個不同產業 |
| 違反處理 | 必須從其他產業補充推薦 |

**範例**：
```
❌ 錯誤：推薦5檔，4檔金融股（80%）
✅ 正確：推薦5檔，金融2檔+半導體2檔+其他1檔
```

**Step 6: 歷史驗證加減分（最後調整）**
- ✅ **歷史成功模式加分** - 類似昨日成功股票+5-10分
- ❌ **歷史失敗模式扣分** - 類似昨日失敗股票-5-15分
- **最終決定推薦順序**

**Step 7: 🚨 強制建檔（分析完成後立即執行）**
```bash
# 6.1 建立分析報告
mkdir -p data/YYYY-MM-DD/
# 寫入 before_market_analysis.md

# 6.2 建立/更新 tracking 記錄
# 寫入 data/tracking/tracking_YYYY-MM-DD.json
```

**🔥 強制建檔規則（2025-12-12新增）**：
1. **分析完成 = 立即建檔**，不是兩個步驟，是同一個動作
2. **絕對禁止**：分析完成後等用戶問「有建檔嗎」才建檔
3. **絕對禁止**：只輸出分析內容但沒有寫入檔案
4. **必須同時建立**：
   - `data/YYYY-MM-DD/before_market_analysis.md`
   - `data/tracking/tracking_YYYY-MM-DD.json`
5. **建檔後回報**：「已建立 before_market_analysis.md 和 tracking.json」

**⚠️ 血淚教訓（2025-12-12）**：
- 問題：分析完成後沒有主動建檔，用戶問「有建file嗎」才發現漏了
- 原因：把「輸出分析」和「寫入檔案」當成兩件事
- 解決：分析完成後，**立即**執行 Write 工具建檔

### ❌ 絕對禁止的錯誤

**❌ 錯誤流程（12/03前的舊模式）**：
1. 看美股+1.84% →
2. 分析產業邏輯 →
3. 推薦理論上應該漲的股票 →
4. ❌ **完全沒有查歷史** ← 12/03盤前分析的致命錯誤

**✅ 正確流程（12/03後的新模式）**：
1. **🔥 查歷史推薦結果**（強制第一步）→
2. **🔥 延續成功、避開失敗**（調整推薦邏輯）→
3. 獲取國際市場數據 →
4. 獲取法人數據 →
5. 五維度評分 + 歷史驗證加減分 →
6. 最終推薦排序 →
7. **🚨 立即建檔**（before_market_analysis.md + tracking.json）

**核心規則提醒**：
- ✅ **時事先行 > 法人先行**（🆕 2025-12-17教訓：從產業找股票，不是從法人找股票）
- ✅ **產業分散 ≤50%**（🆕 2025-12-17教訓：單一產業不超過50%）
- ✅ **歷史驗證 > 理論分析**（最重要原則）
- ✅ **延續成功 > 尋找新標的**
- ✅ **參考 PREDICTION 歷史教訓**（避免重蹈覆轍）
- ✅ **分析完成 = 立即建檔**（不等用戶提醒）
- ❌ 絕不事後諸葛（盤前沒推薦的股票，盤中/盤後不能說「應該推薦」）
- ❌ 絕不追高推薦（近5日漲幅>5%要標註風險，>10%絕不推薦）
- ❌ 絕不只看法人買超TOP10選股（🆕 2025-12-17教訓）
- ❌ 絕不憑印象報價（必須查詢實際股價）
- ❌ 絕不忽略 PREDICTION 記錄的失敗模式
- ❌ 絕不只輸出分析而不建檔

---

## 2. 🔥 盤中雙軌分析強制流程（12:30執行）

**⚠️ 重大教訓（2025-12-05）**：Track B分析經常遺漏，導致錯過市場重要發現

### 🚨 強制分析流程（必須按順序執行）

**Step 0: 前置檢查（盤中分析第一步）**
```bash
# 確認tracking檔案存在
ls data/tracking/tracking_$(date +%Y-%m-%d).json
# ⚠️ 如果tracking檔案不存在，絕對禁止進行盤中分析
```

**檢查清單**：
- [ ] 確認tracking檔案存在
- [ ] 確認盤前推薦股票清單（通常3-8檔）
- [ ] 確認當前時間12:30-13:30
- [ ] **絕對禁止**沒有tracking就進行盤中分析

**Step 0.5: 參考 predictions 歷史教訓（強制）** 🆕
```bash
# 快速查看歷史預測記錄，用於盤中異常判斷
cat data/predictions/predictions.json | tail -100
```

**🔥 盤中參考 predictions 重點**：
1. **異常情況比對** - 盤中出現異動時，對照歷史教訓判斷
2. **法人反轉警示** - 如12/10教訓：連漲多日後法人可能反轉
3. **風險模式識別** - 盤中走勢是否符合歷史失敗模式？
4. **操作建議調整** - 根據歷史教訓調整尾盤策略

**Step 1: 執行雙軌腳本（第一優先）**
```bash
python3 scripts/intraday_dual_track.py
```

**Step 2: Track A分析（第二優先）** 🚨 **防事後諸葛**
**🔥 Track A強制內容**：
1. **逐檔推薦股分析** - 每檔都要有現價、漲跌%、量比
2. **五維度盤中評分** - 不是判斷對錯，是給操作建議
3. **尾盤策略** - 續抱/停損/加碼，明確價位
4. **量價分析** - 量比+買盤%判斷
5. **操作建議輸出** - 每檔股票給明確建議

**Step 3: Track B分析（第三優先）** 🚨 **全市場買賣量掃描**
**🔥 Track B強制內容**：
1. **成交量 TOP20 掃描** - 當日成交量最大的股票，不管漲跌
2. **量比 TOP20 掃描** - 量比最高的股票（今日量 vs 5日均量）
3. **買賣方向判斷** - 每檔大量股查內盤%/外盤%
   - 外盤比 > 55% → 買盤主導，有人在吃
   - 內盤比 > 55% → 賣盤主導，有人在倒
4. **資金流向結論** - 今天資金往哪個產業跑
5. **機會與風險標註**
   - 大量 + 外盤主導 + 漲幅小 → ✅ 可能在吸貨
   - 大量 + 內盤主導 + 下跌 → ❌ 在出貨，避開
   - 大量 + 外盤主導 + 已大漲 → ⚠️ 追高風險

**Step 3.3: 🔥 Track B 時事驗證（新增 2025-12-17）** 🆕

**⚠️ 問題**：Track B 發現爆量股後，可能推薦「沒有時事支撐」的股票

**🔥 時事驗證流程**：
對 Track B 發現的爆量股，逐一檢查：

| 檢查項目 | 是 | 否 |
|---------|----|----|
| 屬於今日時事利多產業？ | ⭐ 優先關注 | 僅記錄 |
| 有明確產業催化劑？ | ⭐ 可建議進場 | ⚠️ 觀望 |
| 符合盤前時事判斷？ | ✅ 一致性加分 | ⚠️ 需解釋原因 |

**範例**：
```
今日時事：費半+1.5% → 利多半導體

Track B 發現：
- 聯電(2303) 爆量+2% → ✅ 半導體，符合時事，優先關注
- 台新金(2887) 爆量+3% → ⚠️ 金融股，不符合今日時事，僅記錄
- 欣興(3037) 爆量+1% → ✅ 載板/半導體，符合時事，優先關注
```

**🔴 強制規則**：
1. Track B 發現的股票，必須標註「是否符合今日時事」
2. 不符合時事的爆量股：僅記錄，不建議追
3. 符合時事的爆量股：可建議尾盤進場

**Step 3.5: 🔥 盤中佈局偵測（關鍵！）** 🆕
**找「法人連續買超 + 今日爆量 + 還沒大漲」的股票**

```bash
# 盤中佈局偵測邏輯
# 1. 從盤前佈局股清單中（連續3日買超+5日漲幅<3%）
# 2. 檢查今日盤中量能（量比>1.5x = 爆量）
# 3. 檢查今日漲幅（<3% = 還沒大漲）
# 4. 符合條件 = 法人正在加碼佈局
```

**🔥 盤中佈局訊號判斷**：
| 條件組合 | 訊號 | 操作建議 |
|---------|------|---------|
| 連續買超 + 今日爆量 + 漲幅<2% | ⭐ **強佈局** | 可進場 |
| 連續買超 + 今日爆量 + 漲幅2-5% | 🟡 佈局中 | 觀察 |
| 連續買超 + 今日爆量 + 漲幅>5% | ⚠️ 已反映 | 不追高 |
| 連續買超 + 今日縮量 | 😴 休息 | 等待 |
| 連續買超 + 今日爆量下跌 | 🚨 出貨？ | 警戒 |

**範例輸出**：
```
🔍 盤中佈局偵測（12:30）
代號   連續買超   今日量比   今日漲幅   訊號
2382   3日+17M    2.5x      +0.5%     ⭐ 強佈局（可進場）
2303   3日+85M    1.8x      +1.2%     ⭐ 強佈局（可進場）
2887   3日+66M    0.8x      +0.3%     😴 縮量等待
```

**⚠️ 注意事項**：
- 盤中偵測到的佈局股 ≠ 立即追買
- 需確認「外盤比>55%」（買盤主導）
- 建議尾盤13:00-13:30進場，避免盤中假突破

**Step 4: 雙軌整合輸出（第四優先）**
- 🔥 **Track A操作建議** - 盤前推薦股的尾盤策略
- 🔥 **Track B市場發現** - 遺漏機會分析+策略驗證
- 🔥 **風險提醒** - 量能、追高、週五效應等

**Step 5: 🚨 強制建檔（分析完成後立即執行）** 🆕
```bash
# 寫入盤中分析報告
# data/YYYY-MM-DD/intraday_analysis.md

# 更新 tracking 記錄（加入盤中表現）
# data/tracking/tracking_YYYY-MM-DD.json
```

**🔥 盤中強制建檔規則（2025-12-12新增）**：
1. **分析完成 = 立即建檔**，不等用戶提醒
2. **必須建立**：`data/YYYY-MM-DD/intraday_analysis.md`
3. **必須更新**：`data/tracking/tracking_YYYY-MM-DD.json`（加入盤中價格）
4. **建檔後回報**：「已建立 intraday_analysis.md」

### ❌ 絕對禁止的錯誤

**❌ 錯誤流程（12/05前的問題）**：
1. 只做Track A分析 →
2. 忽略Track B市場發現 →
3. ❌ **遺漏重要市場信息** ← 12/05盤中分析的問題

**✅ 正確流程（12/05後的新模式）**：
1. **🔥 Step 0-4完整執行**（強制順序）→
2. **🔥 Track A + Track B都有深度分析**→
3. 雙軌整合輸出尾盤策略 →
4. 完整記錄供盤後分析使用 →
5. **🚨 立即建檔**（intraday_analysis.md + 更新tracking.json）

**核心規則提醒**：
- ✅ **Track B 先看量，再看方向，最後看漲跌**
- ✅ **量大的股票 = 資金在關注的股票**
- ✅ **外盤主導 = 買盤；內盤主導 = 賣盤**
- ✅ **盤中異常要對照 PREDICTION 歷史教訓**
- ✅ **Track B 爆量股必須做時事驗證**（🆕 2025-12-17）
- ✅ **分析完成 = 立即建檔**（不等用戶提醒）
- ❌ 絕不能只看「誰漲了」，要看「誰的量大」
- ❌ 絕不能跳過內外盤比分析
- ❌ 絕不能沒有「資金流向結論」
- ❌ 絕不能忽略歷史失敗模式警示
- ❌ 絕不只輸出分析而不建檔
- ❌ 絕不能推薦「不符合今日時事」的爆量股（🆕 2025-12-17）

---

## 3. 🔥 盤後整合驗證強制流程（14:30後執行）

**⚠️ 重大教訓（2025-12-05）**：盤後分析經常遺漏盤中雙軌發現，浪費已收集數據

### 🚨 強制分析流程（必須按順序執行）

**Step 0: 前置檢查（盤後分析第一步）**
```bash
# 確認盤中雙軌數據完成
ls data/$(date +%Y-%m-%d)/intraday_analysis.md
ls data/$(date +%Y-%m-%d)/dual_track_analysis.json
# ⚠️ 如果盤中分析未完成，絕對禁止進行盤後分析
```

**檢查清單**：
- [ ] 確認intraday_analysis.md存在
- [ ] 確認dual_track_analysis.json存在
- [ ] 確認當前時間14:30後（法人數據已公布）
- [ ] **絕對禁止**沒有盤中雙軌數據就進行盤後分析

**Step 1: Track A驗證（第一優先）**
```bash
# 讀取追蹤記錄
cat data/tracking/tracking_$(date +%Y-%m-%d).json
```

**🔥 Track A強制內容**：
1. **逐檔推薦股驗證** - 推薦價vs收盤價，計算漲跌%
2. **成功/失敗統計** - X檔成功/Y檔失敗，明確分類
3. **準確率計算** - X/Y = Z%，必須明確標示
4. **失敗原因分析** - 法人態度轉變？產業邏輯失效？
5. **成功經驗總結** - 為什麼成功？可延續到明日？

**Step 2: Track B整合（第二優先）** 🚨 **防遺漏關鍵**
```bash
# 提取盤中市場發現
grep -A 20 "Track B" data/$(date +%Y-%m-%d)/intraday_analysis.md
```

**🔥 Track B強制內容**：
1. **市場發現TOP5深度分析** - 盤前沒推薦但大漲的股票詳細檢討
2. **遺漏機會根本原因** - 必須逐一檢討：
   - 🆕 **時事判斷錯誤？** - 盤前時事→產業對應是否正確？
   - 法人數據盲點？ - 是否只看法人TOP10而忽略時事利多產業？
   - 產業邏輯不足？ - 是否遺漏某個受惠產業？
   - 評分權重問題？ - 時事30%有真的執行嗎？
3. **策略盲點檢討** - 五維度評分系統哪裡失效？
4. **產業共振驗證** - 同產業股票是否都表現好？（如記憶體族群）
5. **新發現應用** - 今日發現如何改進明日推薦策略？

**Step 2.3: 🔥 時事判斷驗證（新增 2025-12-17）** 🆕

**盤前時事判斷 vs 今日實際表現**：
```
檢討項目：
1. 盤前時事判斷：費半-0.46% → 選了什麼產業？
2. 今日實際表現：哪些產業漲？哪些跌？
3. 判斷是否正確：時事→產業對應有沒有錯？

範例：
盤前判斷：費半-0.46% → 金融防禦
今日結果：金融-1.5%，半導體+2%
結論：❌ 時事判斷錯誤，費半小跌≠要避開半導體
教訓：費半跌幅<1%時，不應全押金融防禦
```

**🔴 強制輸出**：
| 項目 | 內容 |
|------|------|
| 盤前時事判斷 | XX訊號 → 選XX產業 |
| 今日實際表現 | XX產業漲/跌X% |
| 判斷結果 | ✅正確 / ❌錯誤 |
| 錯誤原因 | （如果錯誤）為什麼判斷錯？ |
| 教訓記錄 | 下次遇到類似情況怎麼處理 |

**Step 2.5: 🔥 佈局股驗證（關鍵！）** 🆕
**驗證盤前找的「佈局股」今日表現如何**

**🔥 佈局股驗證內容**：
1. **佈局股表現統計** - 盤前找的佈局股（連續買超+還沒漲），今日收盤表現
2. **成功/失敗分類**
   - ✅ 佈局成功：今日上漲且法人續買
   - ⚠️ 佈局中：今日平盤，法人續買
   - ❌ 佈局失敗：今日下跌或法人反轉賣
3. **佈局策略準確率** - 佈局股成功率 vs 一般推薦股成功率
4. **失敗原因分析** - 為什麼法人連續買超但股價不漲？
5. **模式記錄** - 記錄成功/失敗模式到 PREDICTION

**範例輸出**：
```
🔍 佈局股驗證（盤後）
代號   盤前狀態           今日收盤   今日法人     結果
2382   連3日+17M,5日-1%   +1.5%     +3,200K     ✅ 佈局成功
2303   連3日+85M,5日+1%   +0.8%     +5,100K     ⚠️ 佈局中
2887   連3日+66M,5日+0%   -0.5%     -2,000K     ❌ 法人反轉

佈局股準確率：1/3 = 33%
一般推薦準確率：2/5 = 40%
```

**🔥 佈局成功/失敗模式記錄**（更新到 PREDICTION）：
```
✅ 佈局成功模式：
- 連續買超≥3日 + 5日漲幅<0% + 今日法人續買 → 高成功率

❌ 佈局失敗模式：
- 連續買超但外資0張 → 失敗率高
- 連續買超>5日後反轉 → 獲利了結風險
- 產業邏輯弱但法人買 → 短線誘多
```

**Step 3: 雙軌對比驗證（第三優先）**
**🔥 雙軌對比強制內容**：
1. **預測vs實際對照表** - 盤前預測vs盤中發現vs最終收盤
2. **盤中策略執行檢討** - 尾盤建議是否正確？
3. **時間軸完整驗證** - 09:00預測→12:30調整→14:30收盤的完整軌跡
4. **數據一致性檢查** - intraday_analysis.md vs dual_track_analysis.json是否一致
5. **策略有效性驗證** - 推薦成功vs避開成功vs發現遺漏的比例

**Step 4: 執行追蹤系統更新（第四優先）**
```bash
# 更新個股追蹤
python3 scripts/stock_tracker.py
```

**Step 5: 更新 predictions.json（第五優先）** 🆕
```bash
# 更新預測記錄
# 檔案位置：data/predictions/predictions.json
```

**🔥 predictions.json 強制更新內容**：
1. **新增當日記錄** - 推薦股票、收盤價、漲跌%、結果
2. **準確率統計** - accuracy 欄位
3. **重大教訓記錄** - notes 欄位記錄（如12/10法人反轉）
4. **驗證結果** - verification 欄位

**格式範例**：
```json
"2025-12-18": {
  "date": "2025-12-18",
  "predictions": [
    {
      "symbol": "2883",
      "name": "凱基金",
      "prev_close": 17.40,
      "direction": "up",
      "confidence": 0.86,
      "reasons": ["三方一致買超", "10天連買"],
      "verification": {
        "actual_close": 17.35,
        "actual_change": -0.29,
        "result": "neutral",
        "notes": "Fed觀望氛圍"
      }
    }
  ],
  "accuracy": 0.50,
  "notes": "Fed觀望日，準確率50%"
}
```

**Step 6: 明日預測調整（第六優先）**
**🔥 基於今日發現調整明日策略**：
1. **延續成功模式** - 今日成功的因素明日是否持續？
2. **避開失敗模式** - 今日失敗的原因明日如何避免？
3. **新發現整合** - Track B發現的機會明日如何應用？
4. **評分權重調整** - 五維度權重是否需要微調？
5. **明日推薦邏輯** - 結合今日所有發現制定明日策略

**Step 6.5: 🆕 深度驗證（新增 2026-01-20）** 🔥
**盤後深度分析，補充盤前快速評估遺漏的細節**

**A. 推薦股深度籌碼驗證**
```bash
# 執行 10天籌碼深度分析
python3 scripts/chip_analysis.py [推薦股代號1] [推薦股代號2] ... --days 10
```

**🔥 籌碼驗證重點**：
1. **真連續買超驗證** - 確認「連續X天買超」是否真的連續（中間有沒有賣）
2. **累計淨買超** - 10天累計多少？是否持續增加？
3. **外資vs投信** - 是否同步買？還是對決？
4. **最近趨勢** - 最近3天是加速買還是減速買？
5. **修正判斷** - 若發現盤前判斷錯誤，記錄教訓

**範例輸出**：
```markdown
### 📊 推薦股深度籌碼驗證

#### 凱基金(2883)

【近 10 日法人買賣超】
日期         三大法人    外資    投信 狀態
2026/01/20   +39.7K   +35.6K   +3.9K  🟢
2026/01/19   +35.0K   +30.2K   +4.5K  🟢
2026/01/16   +24.4K   +20.1K   +4.2K  🟢
...

【統計摘要】
累計淨買超：+159K 張
真連續買超：4 天（✅ 確認連續）
外資vs投信：同步買超（✅ 態度一致）
籌碼判斷：✅ 法人持續佈局中

**盤前vs盤後對比**：
- 盤前快速判斷：連續買超+35K ✅ 正確
- 盤後深度驗證：4天累計+159K ✅ 佈局扎實
- 結論：推薦正確，明日可延續
```

**B. 遺漏機會深度檢討**
```bash
# 分析今日大漲但盤前未推薦的股票
python3 scripts/chip_analysis.py [遺漏股代號] --days 10
```

**🔥 遺漏檢討重點**：
1. **為什麼盤前沒推薦？** - 推薦數量太少？產業盲點？籌碼誤判？
2. **10天籌碼回顧** - 是否有明顯買超訊號？
3. **產業催化劑** - 是否遺漏產業新聞？
4. **改進方向** - 如何避免明日再犯？

**範例輸出**：
```markdown
### 🔍 遺漏機會深度檢討

#### 康舒(6282) +17.28%（盤前未推薦）

【近 10 日法人買賣超】
日期         三大法人    狀態
2026/01/19   +12.0K    🟢（盤前應該看到）
2026/01/16   -8.9K     🔴
2026/01/15   +15.3K    🟢
...

【統計摘要】
累計淨買超：+85K 張（✅ 10天持續買超）
真連續買超：2 天（01/19反彈）
籌碼判斷：✅ 01/16賣超後反彈買超

**遺漏原因分析**：
1. ❌ 推薦數量太少：只推薦4檔，康舒排#10被漏掉
2. ⚠️ 籌碼誤判：因01/16賣超而謹慎，忽略01/19反彈訊號
3. ✅ 產業邏輯：AI電源供應有在時事對照表中

**改進方向**：
→ 推薦數量擴大至 6-8 檔 ✅
→ 籌碼分析看「3日趨勢」而非單日
→ 01/16賣超 → 01/19反彈買超 = 轉強訊號
```

**C. 產業輪動深度分析**
**🔥 分析今日資金流向，預測明日產業方向**：

**範例輸出**：
```markdown
### 🌊 產業輪動分析

#### 今日資金流向TOP5產業

| 產業 | 平均漲幅 | 代表股票 | 法人態度 | 明日預測 |
|------|---------|---------|---------|---------|
| 電源供應 | +17.28% | 康舒+17% | 累計+85K | ⚠️ 已大漲，等回檔 |
| 玻璃建材 | +41.83% | 台玻+46%、中釉+38% | 產業缺貨 | ⚠️ 暴漲，不追 |
| 金融證券 | +1.0% | 凱基金+0%、台新金+1% | 持續買超 | ✅ 穩健推薦 |
| 半導體 | +5.0% | 聯電+7.5% | 連續買超 | ⚠️ 已漲，觀望 |
| 塑化 | -2.5% | 南亞-6%、台塑+1% | 法人分歧 | ❌ 油價逆風 |

**明日產業策略**：
1. 電源供應、玻璃建材 → 已暴漲，不追高，等回檔10-15%
2. 金融證券 → 穩健佈局，法人持續買超
3. 半導體 → 觀望為主，等回檔再進
4. 塑化 → 避開，油價逆風
```

**Step 7: 🚨 強制建檔（分析完成後立即執行）** 🆕
```bash
# 寫入盤後分析報告
# data/YYYY-MM-DD/after_market_analysis.md

# 更新 tracking 記錄（加入收盤價、結果判定）
# data/tracking/tracking_YYYY-MM-DD.json

# 更新 predictions.json
# data/predictions/predictions.json
```

**🔥 盤後強制建檔規則（2025-12-12新增）**：
1. **分析完成 = 立即建檔**，不等用戶提醒
2. **必須建立**：`data/YYYY-MM-DD/after_market_analysis.md`
3. **必須更新**：`data/tracking/tracking_YYYY-MM-DD.json`（加入收盤價+結果）
4. **必須更新**：`data/predictions/predictions.json`（加入當日記錄）
5. **建檔後回報**：「已建立 after_market_analysis.md，已更新 tracking.json 和 predictions.json」

### ❌ 絕對禁止的錯誤

**❌ 錯誤流程（12/05前的問題）**：
1. 只驗證Track A推薦股表現 →
2. 忽略Track B盤中市場發現 →
3. 沒有深度分析遺漏機會 →
4. ❌ **浪費已收集的雙軌數據** ← 12/05盤後分析的問題

**✅ 正確流程（12/10後的新模式）**：
1. **🔥 Step 0-6完整執行**（強制順序）→
2. **🔥 Track A驗證 + Track B整合 + 雙軌對比**→
3. **更新 PREDICTION_TRACKING（每日強制）**→
4. 基於完整發現調整明日策略 →
5. 不浪費任何已收集數據 →
6. **🚨 立即建檔**（after_market_analysis.md + tracking.json + PREDICTION_TRACKING.md）

**核心規則提醒**：
- ✅ **完整驗證 > 只看推薦股**
- ✅ **數據整合 > 分散分析**
- ✅ **每日更新 PREDICTION_TRACKING**（不再遺漏）
- ✅ **驗證盤前時事判斷是否正確**（🆕 2025-12-17）
- ✅ **分析完成 = 立即建檔**（不等用戶提醒）
- ❌ 絕不能跳過Track B市場發現整合
- ❌ 絕不能沒有「遺漏機會根本原因」分析
- ❌ 絕不能沒有「時事判斷驗證」（🆕 2025-12-17）
- ❌ 絕不能沒有「雙軌對比驗證」
- ❌ 絕不能沒有「基於發現調整明日策略」
- ❌ 絕不能忘記更新 PREDICTION_TRACKING
- ❌ 絕不只輸出分析而不建檔

---

## 4. 🔥 週報強制流程（週五15:00後執行）

### 🚨 強制分析流程（必須按順序執行）

**Step 0: 數據收集（第一步，必須最先執行）**
```bash
# 強制收集本週所有分析數據
find data/$(date +%Y-%m-*) -name "*analysis.md" | sort
find data/tracking/ -name "tracking_$(date +%Y-%m-*).json" | sort

# 驗證數據完整性
ls data/$(date +%Y-%m-01)/before_market_analysis.md  # 週一盤前
ls data/$(date +%Y-%m-05)/after_market_analysis_v2.md  # 週五盤後（確保使用v2版本）
```

**Step 1: Track A績效統計（第一優先）** 🚨 **絕對強制執行**
```bash
# 讀取本週所有tracking數據
for date in $(seq -w 01 05); do
    if [ -f "data/tracking/tracking_2025-12-${date}.json" ]; then
        echo "檢查 2025-12-${date} 推薦績效..."
        # 統計當日推薦數量、成功數量、失敗數量
    fi
done
```

**🔥 Track A績效統計強制內容**：
1. **本週推薦總數** - 統計週一至週五推薦股票總數
2. **成功/失敗統計** - 明確哪些成功、哪些失敗、原因為何
3. **準確率計算** - X/Y = Z%，必須明確標示各日準確率
4. **成功模式歸納** - 本週什麼類型股票成功率高？
5. **失敗模式總結** - 本週什麼類型股票失敗率高？

**Step 2: Track B發現整合（第二優先）**
```bash
# 提取本週所有Track B發現
grep -h "Track B" data/$(date +%Y-%m-*)/intraday_analysis.md | sort | uniq
grep -h "盤中發現" data/$(date +%Y-%m-*)/intraday_analysis.md
```

**🔥 Track B整合強制內容**：
1. **本週錯失機會統計** - Track B發現但我們沒推薦的大漲股
2. **機會錯失原因分析** - 為什麼盤前沒推薦？策略盲點在哪？
3. **產業鏈發現** - Track B發現的產業關聯性（如華邦電→欣興）
4. **下週策略調整** - 基於Track B發現如何改進推薦邏輯？

**Step 3: 法人動向週度分析（第三優先）**
```bash
# 查詢本週法人買賣超數據（需要每日數據）
python3 scripts/check_institutional.py [股票代號] $(date -d "monday" +%Y%m%d)
python3 scripts/check_institutional.py [股票代號] $(date -d "friday" +%Y%m%d)
```

**Step 4: 產業輪動檢測（第四優先）**
- 🔥 **本週資金流向** - 哪些產業受資金青睞？
- 🔥 **輪動模式識別** - 記憶體→載板→封測的輪動軌跡
- 🔥 **失效策略檢測** - 原本看好但失效的產業（如金融股）

**Step 5: 下週策略制定（第五優先）**
```bash
# 獲取下週國際市場前瞻
python3 scripts/fetch_us_asia_markets.py
# 結合本週發現制定下週策略
```

### ❌ 絕對禁止的錯誤

**❌ 錯誤流程（簡化版週報）**：
1. 只看盤前推薦成功失敗 →
2. 簡單統計準確率 →
3. ❌ **完全沒有整合Track B發現** ← 週報穩定性最大風險

**✅ 正確流程（強制雙軌整合）**：
1. **🔥 Step 0-5完整執行**（強制順序）→
2. **🔥 Track A統計 + Track B整合 + 產業輪動分析**→
3. 基於完整發現制定下週策略 →
4. 不浪費本週任何雙軌數據

**核心規則提醒**：
- ✅ **雙軌整合 > 只看推薦績效**
- ✅ **週度視野 > 單日分析**
- ❌ 絕不能跳過Track B發現整合（週報最大遺漏風險）
- ❌ 絕不能沒有「錯失機會根本原因」分析
- ❌ 絕不能沒有「基於發現調整下週策略」

---

## 5. 🔥 月報強制流程（月底最後交易日執行）

### 🚨 強制分析流程（必須按順序執行）

**Step 0: 月度數據收集（第一步，必須最先執行）**
```bash
# 強制收集本月所有數據
find data/$(date +%Y-%m-*) -name "*.md" | wc -l  # 分析報告數量
find data/tracking/ -name "tracking_$(date +%Y-%m-*).json" | wc -l  # 追蹤記錄數量
find data/weekly/ -name "$(date +%Y-%m)*_weekly_report.md"  # 本月週報

# 驗證數據完整性（月報最基本要求）
echo "本月工作日數："
cal $(date +%m) $(date +%Y) | grep -o '[0-9]\+' | wc -l
echo "實際分析日數："
ls data/$(date +%Y-%m-*)/before_market_analysis.md | wc -l
```

**Step 1: 月度績效統計（第一優先）** 🚨 **絕對強制執行**
```bash
# 讀取本月所有tracking數據，統計月度績效
for week in $(ls data/weekly/$(date +%Y-%m)*_weekly_report.md); do
    echo "整合週報：$week"
    grep "準確率" $week
done
```

**🔥 月度績效統計強制內容**：
1. **月度推薦總數** - 統計整月推薦股票總數
2. **月度準確率軌跡** - 週一至週五、每週準確率變化軌跡
3. **成功案例TOP10** - 本月最成功的推薦，漲幅排行
4. **失敗案例反思** - 本月失敗推薦，失敗原因分類
5. **策略演進軌跡** - 從v4.0→v5.0的改進成效

**Step 2: 策略演進分析（第二優先）**
- 🔥 **系統升級成效** - 新強制流程vs舊模式的準確率對比
- 🔥 **歷史驗證效果** - 延續成功避開失敗的實際效果
- 🔥 **雙軌分析價值** - Track B發現為準確率提升多少？

**Step 3: 失敗教訓總結（第三優先）**
```bash
# 檢查本月失敗教訓資料庫
grep "失敗教訓" data/$(date +%Y-%m-*)/after_market_analysis*.md
```

**Step 4: 下月策略規劃（第四優先）**
- 🔥 **權重調整建議** - 五維度權重是否需要微調？
- 🔥 **新增功能規劃** - 基於本月問題提出改進方向
- 🔥 **風險控制升級** - 基於失敗案例完善風險控制

### ❌ 絕對禁止的錯誤

**❌ 錯誤流程（忘記做月報）**：
1. 月底沒有意識到需要做月報 →
2. 直接進入下個月分析 →
3. ❌ **完全沒有月度反思和策略調整** ← 月報最大風險

**✅ 正確流程（強制月度復盤）**：
1. **🔥 Step 0-4完整執行**（強制順序）→
2. **🔥 績效統計 + 策略演進 + 失敗總結 + 下月規劃**→
3. 基於月度數據調整系統參數 →
4. 為下月分析提供改進方向

**核心規則提醒**：
- ✅ **月度視野 > 週度分析**
- ✅ **系統性改進 > 單點修正**
- ❌ 絕不能忘記做月報（最大風險）
- ❌ 絕不能沒有「策略演進軌跡」分析
- ❌ 絕不能沒有「基於月度數據的系統調整」

---

## ⚠️ 預測準確率追蹤

**歷史教訓**：2025/10/01 準確率8.3%（12項僅對1項）
**改進成果**：2025/11/28 準確率83.3%（5/6）
**最新結果**：2025/12/01 準確率50%（2/4）
**關鍵發現**：歷史成功不一定延續，需每日驗證法人態度

詳見：`data/predictions/predictions.json`

---

## 核心架構

### 📁 目錄結構
```
stock/
├── src/                          # 主程式目錄
│   ├── main.py                   # 股票查詢分析入口
│   ├── portfolio_analyzer.py     # 個人持股分析
│   ├── data_fetcher.py           # 數據獲取(證交所API + Yahoo Finance)
│   ├── analyzer.py               # 多維分析引擎
│   └── utils.py                  # 工具函數
├── scripts/                      # 🆕 分析工具腳本
│   ├── stock_tracker.py          # 🔥 個股追蹤系統（每日14:30執行）
│   ├── check_institutional.py    # 單一股票法人查詢工具
│   ├── intraday_analyzer_v2.py   # 盤中五維度分析工具
│   ├── institutional_positioning_detector.py # 🔥 法人佈局偵測器（12:30執行）
│   └── archive/
│       └── archive_intraday_scanner.py # 舊版掃描器（備用）
├── portfolio/my_holdings.yaml            # 個人持股配置
├── data/
│   ├── YYYY-MM-DD/               # 每日分析報告
│   │   ├── before_market_analysis.md     # 盤前分析
│   │   ├── intraday_analysis.md          # 盤中五維度分析
│   │   ├── positioning_detection.md      # 🆕 法人佈局偵測報告
│   │   └── after_market_analysis.md      # 盤後分析
│   ├── tracking/                 # 🆕 個股追蹤數據
│   │   ├── tracking_YYYY-MM-DD.json
│   │   └── reports/              # 7日追蹤報告
│   ├── weekly/                   # 🆕 週報
│   ├── monthly/                  # 🆕 月報
│   └── backtest/                 # 🆕 策略回測（規劃中）
├── templates/                    # 🆕 分析範本
│   └── weekly_report_template.md
└── docs/                         # 規範文件
    ├── CONVERSATION_START_CHECKLIST.md
    ├── MARKET_NEWS_CHECKLIST.md
    ├── ANALYSIS_STANDARDS_V2.md
    ├── ENHANCED_ANALYSIS_SYSTEM_PLAN.md  # 🆕 強化系統規劃
    └── ENHANCED_SYSTEM_USAGE.md          # 🆕 使用指南
```

### 核心工具

**check_institutional.py** - 法人數據查詢（單日）
- 解決只能看TOP50限制
- 可查詢任何股票單日法人數據
- 用法：`python3 scripts/check_institutional.py 2330 20251111`

**fetch_institutional_top50.py** - 法人買賣超TOP50 🆕 2025-12-17（2026-01-20檔名更新）
- 執行時機：盤前分析
- 功能：查詢法人買賣超TOP50 + 5日漲幅 + 狀態標註
- 自動過濾「已大漲」股票，標註「佈局中/可進場/追高風險」
- 用法：`python3 scripts/fetch_institutional_top50.py [日期YYYYMMDD]`
- 範例：`python3 scripts/fetch_institutional_top50.py 20251216`

**chip_analysis.py** - 籌碼分析工具（N天歷史）🆕 2025-12-17 **重要**
- 執行時機：盤前選股後，對有興趣的3-5檔做深度分析
- 功能：
  - 查詢近N天法人買賣超歷史（預設10天）
  - 計算累計淨買超、買超天數、賣超天數
  - 計算「真連續買超」天數（中間有賣就停）
  - 判斷籌碼狀態：佈局/買進/偏多/出貨/反轉/觀望
- 用法：
  - `python3 scripts/chip_analysis.py 2883` - 單檔
  - `python3 scripts/chip_analysis.py 2883 2887 2303` - 多檔
  - `python3 scripts/chip_analysis.py 2883 --days 20` - 指定天數
- **解決問題**：驗證「連買N天」是否真的連續，中間有沒有賣

**holdings_analysis.py** - 法人持股水位分析 🆕 2026-01-19 **重要**
- 執行時機：盤後分析、買進/賣出決策前
- 功能：
  - 查詢外資持股量和持股比例
  - 計算賣超佔持股比例（關鍵指標）
  - 評估出場壓力（🔴高壓/🟠中高壓/🟡中壓/⚪低壓/🟢吸籌/🔥強力吸籌）
  - 預估出貨空間（還需賣出多少張）
- 用法：
  - `python3 scripts/holdings_analysis.py 2330` - 單檔
  - `python3 scripts/holdings_analysis.py 2886 1303 3481` - 多檔
  - `python3 scripts/holdings_analysis.py 2330 --days 20` - 指定天數
- **觸發關鍵詞**：「出場壓力分析」「持股水位分析」「外資持股比例」「法人手上有多少」
- **解決問題**：以前只知道法人買賣多少，現在知道「佔持股比例」判斷壓力大小

**fetch_tw_market_news.py** - 台股時事分析 🆕 2026-01-19 **重要**
- 執行時機：盤前分析、需要了解台股時事時
- 功能：
  - 掃描近期重要事件（法說會、財報、Fed決議）
  - 分析熱門題材（AI、記憶體、半導體等）
  - 查詢重大訊息（併購、訂單、擴產）
  - 整合鉅亨網/Yahoo財經新聞
- 用法：
  - `python3 scripts/fetch_tw_market_news.py` - 今日時事
  - `python3 scripts/fetch_tw_market_news.py --days 3` - 近3日
- **觸發關鍵詞**：「台股時事」「重大訊息」「法說會日期」「今天有什麼新聞」
- **解決問題**：以前只看美股時事，現在也掃描台股本地時事

**archive_intraday_scanner.py** - 舊版量能掃描器（已停用）
- 狀態：已被 institutional_positioning_detector.py 取代
- 限制：使用一票否決制、無五維度評分、範圍有限

**institutional_positioning_detector.py** - 法人佈局偵測器 🆕 **推薦使用**
- 執行時機：12:30（最佳）
- 核心邏輯：全市場掃描→量能異動分析→發現佈局機會
- **全市場偵測**：掃描500檔重點股票，不限盤前推薦
- 用法：`python3 scripts/institutional_positioning_detector.py`
- 優勢：即時機會發現、量能異動偵測、新標的挖掘

**intraday_analyzer_v2.py** - Track A測試工具 🔧 **測試專用**
- 執行時機：開發測試時
- 功能：僅Track A（追蹤推薦股表現）
- 特色：快速驗證、防事後諸葛
- 用法：`python3 scripts/intraday_analyzer_v2.py`
- ⚠️ **正式分析請用 intraday_dual_track.py**

**intraday_dual_track.py** - 正式盤中雙軌分析 🆕 **推薦使用**
- 執行時機：12:30（正式分析）
- 功能：完整雙軌系統（Track A + Track B）
- Track A：追蹤盤前推薦股表現
- Track B：全市場掃描異動、發現新機會
- 用法：`python3 scripts/intraday_dual_track.py`
- 輸出：雙軌分析結果 + 尾盤操作建議

**stock_tracker.py** - 個股追蹤系統 🆕
- 執行時機：每日盤後14:30後
- 核心邏輯：追蹤推薦股票7日表現，驗證準確率
- 功能：自動更新價格+法人數據、產生7日追蹤報告
- 用法：`python3 scripts/stock_tracker.py`

**my_holdings_analyzer.py** - 個人持股分析工具 🆕 **重要**
- 執行時機：任何時候（獨立運行）
- 核心邏輯：分析個人持股表現，整合四維度評分
- 功能：即時價格+法人數據+健康度評分+操作建議
- 用法：`python3 scripts/my_holdings_analyzer.py`
- 特色：獨立於三階段分析，專注個人持股決策

### 🎯 三套分析系統並存（2025-12-01更新）

**每日執行三套系統**：
1. **intraday_analyzer_v2.py** - 驗證盤前推薦表現
2. **institutional_positioning_detector.py** - 全市場機會發現
3. **stock_tracker.py** - 7日追蹤系統（需修復）

**為什麼需要三套？**
- **驗證系統**：檢驗推薦是否準確（防事後諸葛）
- **發現系統**：找出盤前遺漏的機會（全市場視野）
- **追蹤系統**：長期績效驗證（7日完整追蹤）

詳細使用指南：`docs/ENHANCED_SYSTEM_USAGE.md`

---

## 🆕 強化分析系統（2025-11-20新增）

### 系統概述

**問題診斷**：
- ❌ 盤前盤中盤後不夠、缺少週期性總結
- ❌ 推薦股票後沒追蹤、不知道是否成功
- ❌ 無法驗證策略有效性、憑感覺選股

**解決方案（B+C+E組合）**：
```
1️⃣ 週報/月報系統
   - 每週五產出週報
   - 統計本週推薦績效、法人動向
   - 產業輪動分析、下週展望

2️⃣ 個股追蹤系統 ⭐ (已上線)
   - 推薦後自動追蹤7日
   - 每日更新價格+法人數據
   - 7日後產生追蹤報告、驗證準確率

3️⃣ 策略回測系統 (規劃中)
   - 驗證「法人一致買超」等策略有效性
   - 量化準確率、持續改進
   - 累積30日數據後啟用
```

---

### 個股追蹤系統使用流程

**Step 1: 盤前推薦時建立追蹤記錄**
```json
// data/tracking/tracking_2025-11-20.json
{
  "recommendations": [
    {
      "stock_code": "1303",
      "stock_name": "南亞",
      "recommend_price": 52.5,
      "target_price": 58.0,
      "stop_loss": 48.3,
      "tracking_days": 7,
      "status": "tracking"
    }
  ]
}
```

**Step 2: 每日盤後自動更新**
```bash
# 執行追蹤更新（14:30後）
python3 scripts/stock_tracker.py

# 輸出範例：
✅ 南亞(1303): 56.2元 (+7.05%) - 📈 法人買超+3,421張 追蹤中 (2/7日)
```

**Step 3: 7日後產生追蹤報告**
- 報告位置：`data/tracking/reports/2025-11-20_1303_7day_report.md`
- 包含：最終漲跌幅、法人7日累計、成功/失敗分析
- 用途：驗證推薦準確率

**Step 4: 整合至盤後分析**
```markdown
## 九、追蹤中股票更新

| 股票 | 推薦日 | 推薦價 | 現價 | 漲跌% | 天數 | 狀態 |
|------|--------|--------|------|-------|------|------|
| 南亞 | 11/20 | 52.5 | 56.2 | +7.0% | 2/7 | ✅追蹤中 |
```

---

### 週報系統使用流程

**時間**：每週五15:00後

**範本**：`templates/weekly_report_template.md`

**核心內容**：
1. 本週市場總結（20%）
2. 本週法人動向（30%）- 投信/外資策略、一致買超
3. **本週推薦股票績效（30%）** - 成功/失敗案例、準確率
4. 產業輪動分析（10%）
5. 下週展望（10%）

**輸出位置**：`data/weekly/YYYY-MM-DD_weekly_report.md`

---

### 每日工作流程（整合後）

**09:00前 - 盤前分析**：
1. 執行市場時事檢查
2. 查詢法人數據、美股表現
3. 撰寫盤前分析
4. 🆕 **推薦股票時建立追蹤記錄**

**12:30 - 盤中分析（雙軌模式）**：
按照「2. 🔥 盤中雙軌分析強制流程」執行（第133-198行）
- Step 0: 前置檢查 → Step 1: 執行腳本 → Step 2: Track A → Step 3: Track B → Step 4: 整合輸出
- ⚠️ **強制執行Track B分析**，防止遺漏市場發現

**14:30後 - 盤後分析**：
按照「3. 🔥 盤後整合驗證強制流程」執行（第200-290行）
- Step 0: 前置檢查 → Step 1: Track A驗證 → Step 2: Track B整合 → Step 3: 雙軌對比 → Step 4: 追蹤更新 → Step 5: 明日調整
- ⚠️ **強制整合盤中雙軌發現**，不浪費已收集數據

**週五15:00後 - 週報**：
按照「4. 🔥 週報強制流程」執行（第292-378行）
- Step 0: 數據收集 → Step 1: Track A績效統計 → Step 2: Track B發現整合 → Step 3: 法人動向分析 → Step 4: 產業輪動檢測 → Step 5: 下週策略制定
- ⚠️ **強制整合本週所有Track A/B數據**，確保週報完整性

**月底最後交易日 - 月報**：
按照「5. 🔥 月報強制流程」執行（第379-450行）
- Step 0: 月度數據收集 → Step 1: 月度績效統計 → Step 2: 策略演進分析 → Step 3: 失敗教訓總結 → Step 4: 下月策略規劃
- ⚠️ **強制整合追蹤系統月度統計**，驗證策略有效性

**隨時可用 - 個人持股分析**：🆕
- 執行命令：`python3 scripts/my_holdings_analyzer.py`
- 功能：四維度持股分析（價格+法人+時事+產業）
- 輸出：健康度評分+操作建議+風險警示
- 特色：獨立運行，不影響三階段分析流程
- 使用時機：想了解持股狀況時隨時執行

---

### 詳細文件

**完整規劃**：`docs/ENHANCED_ANALYSIS_SYSTEM_PLAN.md`（規劃文件、系統架構）
**使用指南**：`docs/ENHANCED_SYSTEM_USAGE.md`（執行步驟、故障排除）

---

## 開發流程規範

### 代碼修改規則
1. **先列出要修改的文件** - 任何代碼修改前必須先列出具體文件清單
2. **等待審核批准** - 獲得明確同意後才能開始開發
3. **新系統架構需詢問** - 任何架構變更都需要事先討論
4. **禁止擅自行動** - 不得直接修改文件、創建新文件或改變架構

### Git 操作規則 🆕
1. **commit 後等用戶確認** - 執行 `git commit` 後，必須等用戶明確說「push」才能執行 `git push`
2. **只做用戶明確要求的事** - 不擅自延伸動作（如用戶說「好」只代表同意前一個動作，不代表同意後續所有動作）
3. **禁止連鎖操作** - 不得 `git add && git commit && git push` 一次執行，必須分步驟等用戶確認

---

## 🚨 分析前強制驗證流程（2025/11/18新增）

**血淚教訓**：2025/11/18盤前分析使用錯誤數據（11/14 vs 11/17），浪費用戶時間

### 強制執行規則

**任何盤前/盤中/盤後分析，必須先完成以下步驟，等用戶批准後才能開始撰寫**：

#### Step 1: 列出數據來源（必須）

```
我即將執行【盤前/盤中/盤後】分析：

📊 數據來源：
- 法人數據：20XX/XX/XX（證交所API）
- 美股數據：20XX/XX/XX（Yahoo Finance / 新聞）
- 台股即時：20XX/XX/XX HH:MM（Yahoo Finance）

❓ 數據確認：這是最新可用數據嗎？
```

#### Step 2: 列出分析範圍（必須）

```
📋 分析範圍：
✅ 推薦股票：X檔（股票A、股票B、股票C）
❌ 避開股票：X檔（原因：法人分歧/已大漲/投信賣超）
⚠️ 持股操作：停損X檔、續抱X檔

推薦理由簡述：
- 股票A：投信+外資一致買超、塑化龍頭
- 股票B：投信買超>10,000K、產業邏輯明確
```

#### Step 3: 等待用戶批准（必須）

```
✋ 等待批准：
請確認以上數據來源和分析範圍，我再開始撰寫完整報告。

若有問題請告知，我會立即修正。
```

### 範例：正確流程

```
用戶：「盤前分析」

我：「我即將執行盤前分析：

📊 數據來源：
- 法人數據：2025/11/18（證交所API）
- 美股數據：2025/11/17收盤（Yahoo Finance）
- 台股即時：2025/11/18 08:30（預估開盤）

📋 分析範圍：
✅ 推薦1檔：南亞(1303) - 投信+外資一致買超+18,075K
❌ 避開4檔：富邦金、旺宏、國巨、彰銀（法人激烈對決）
⚠️ 持股操作：停損玉山金、兆豐金（投信賣超）

✋ 請確認以上數據和範圍，我再開始撰寫完整報告。」

用戶：「OK」或「等等，11/18數據已經公布了嗎？」

我：（確認後）「開始撰寫盤前分析...」
```

### 禁止行為

❌ **絕對禁止**直接開始撰寫分析報告
❌ **絕對禁止**先寫完再讓用戶檢查
❌ **絕對禁止**假設用戶會接受任何數據來源

### 檢查清單

執行任何分析前，必須確認：

- [ ] 已列出所有數據來源日期
- [ ] 已確認是最新可用數據
- [ ] 已列出推薦股票及理由
- [ ] 已列出避開股票及理由
- [ ] 已等待用戶明確批准（收到「OK」或「開始」）
- [ ] 所有推薦股票都有check_institutional.py驗證數據

### 違規後果

**若未遵守此流程**：
- 用戶有權要求立即停止
- 必須重新執行驗證流程
- 記錄至 data/predictions/predictions.json 作為失誤案例

---

## 🚨 防止事後諸葛強制規範（2025-11-21新增）

### 血淚教訓

**2025/11/20 事後諸葛災難**：
- 盤前說「無股可推薦」→ 台股大漲+3.18%
- 盤後說「如果用新系統，應該推薦永豐金88分」← 事後諸葛
- 用戶質疑：「為什麼漲了才開始叫我買？這也太奇怪了吧」
- **根本原因**：沒有強制流程防止「盤前不推薦、盤後才說應該推薦」

---

### 一、盤前分析強制規範

#### ❌ 絕對禁止

**1. 禁止說「無股可推薦」「今日無推薦」**
```markdown
❌ 絕對禁止：
「今日無股票可推薦」
「法人對決嚴重，建議觀望」
「市場不明朗，等待時機」

理由：
- 即使法人對決、時事不明朗，也必須推薦3-5檔股票
- 評分低的股票標註風險即可
- 讓用戶自己決定是否進場
```

**2. 禁止使用舊系統一票否決**
```markdown
❌ 絕對禁止：
因「法人對決」就不推薦
因「外資0張」就不推薦
因「投信<10K」就不推薦

✅ 必須執行：
用五維度評分
綜合評估後給出推薦等級
```

**3. 禁止模糊推薦**
```markdown
❌ 絕對禁止：
「等回檔再說」（什麼價位？）
「觀望為主」（那要推薦什麼？）
「開盤進場」（什麼價位？倉位多少？）

✅ 必須執行：
每檔股票明確給出：進場價、倉位%、停損、目標
```

---

#### ✅ 強制執行規則

**推薦數量（必須）**：
```
建議推薦：6-8檔（避免遺漏機會）
最少推薦：6檔
最多推薦：8檔

評分分布建議：
⭐⭐⭐⭐⭐ (≥85分): 2-3檔（穩健型）
⭐⭐⭐⭐ (75-84分): 2-3檔（穩健型）
⭐⭐⭐ (65-74分): 2-3檔（爆發型/觀察型）
```

**如果真的沒有好股票怎麼辦？**
```markdown
✅ 正確做法：
1. 推薦3檔評分65-74分的股票
2. 標註「⭐⭐⭐ 可考慮小倉位5-10%、風險較高」
3. 明確說明風險：
   - 法人對決（投信+8M vs 外資-12M）
   - 產業邏輯較弱（年底作帳但外資不認同）
   - 建議小倉位試單

❌ 錯誤做法：
說「今日無股可推薦」
```

**追蹤機制（強制建立）**：
```python
# 盤前分析完成後，必須執行：
建立 data/tracking/tracking_YYYY-MM-DD.json

內容範例：
{
  "date": "2025-11-21",
  "recommendations": [
    {
      "stock_code": "2890",
      "stock_name": "永豐金",
      "recommend_price": 27.0,
      "target_price": 30.0,
      "stop_loss": 24.8,
      "position": "15-20%",
      "rating": "⭐⭐⭐⭐⭐",
      "score": 88,
      "reason": "投信+9.3M、年底作帳行情"
    }
  ]
}
```

---

### 二、盤中分析雙軌規範（2025-12-04更新）

#### 📊 雙軌並行原則

**Track A：推薦股追蹤**（防止事後諸葛）
```python
# 讀取盤前推薦記錄
tracking = read_tracking_file(date_str)
if tracking:
    analyze_tracking_stocks(tracking)  # 追蹤推薦股
```

**Track B：全市場掃描**（發現新機會）
```python
# 全市場掃描
market_scan = scan_market_opportunities()
# 找出異動股、爆量股、疑似佈局股
```

#### ✅ 執行流程

**1. 執行腳本**
```bash
python3 scripts/intraday_dual_track.py
```

**2. 雙軌分析模式**
```markdown
Track A 推薦股追蹤：
- 南亞(1303)：推薦68元 → 現價63.4元(-6.35%) → ⚠️ 檢查停損位
- 國泰金(2882)：推薦61.8元 → 現價69元(+2.07%) → ✅ 續抱觀察

Track B 全市場發現：
- 華邦電(2344)：+3.58% [盤中發現] → 記憶體反彈但不追高
- 矽力-KY(6415)：+6.97% [盤中發現] → 爆量異動，觀察
```

**3. 標註來源（關鍵）**
```markdown
✅ 正確標註：
[盤前推薦] - 可執行操作建議
[盤中發現] - 僅供觀察，非推薦

❌ 錯誤做法：
盤前沒推薦，盤中說「應該買」
```

#### 🎯 操作建議原則

**不是判斷對錯，而是給建議**：
```markdown
❌ 舊思維：南亞跌6% = 推薦失敗
✅ 新思維：南亞跌6% = 檢查支撐位，若破64元考慮停損

❌ 舊思維：華邦電漲3.5% = 錯過機會
✅ 新思維：華邦電漲3.5% = 盤中發現，但不追高
```

**尾盤策略輸出**：
```markdown
🛑 停損執行：南亞跌破64元停損
➕ 可加碼：推薦股回檔至支撐位
📌 續抱：推薦股表現正常
🔍 新發現：盤中異動股（僅觀察）
```

---

### 三、盤後分析強制規範

#### ✅ 結構規範（必須遵守）

**必須明確分為兩部分**：
```markdown
## 一、今日驗證（20%）⚠️ 僅供檢討，不是建議

### 📅 盤前預測驗證（09:00預測 vs 收盤結果）
| 股票 | 盤前推薦價 | 收盤價 | 漲跌% | 驗證 | 原因分析 |
|------|------------|--------|-------|------|-----------|
| 南亞(1303) | 68.0元 | 63.4元 | -6.35% | ❌失敗 | 塑化逆風 |
| 群創(3481) | 14.2元 | 14.35元 | +1.06% | ✅成功 | 面板復甦 |

**盤前準確率**：4/5 = 80%

### 📊 盤中預測驗證（12:30預測 vs 收盤結果）
| 股票 | 盤中預測 | 收盤結果 | 驗證 | 說明 |
|------|----------|----------|------|------|
| 南亞(1303) | ⚠️檢查停損位 | -6.35% | ✅正確 | 確實需要停損 |
| 欣興(3037) | 🔍新發現+5% | +9.50% | ✅成功 | Track B發現成功 |

**盤中準確率**：3/3 = 100%

⚠️ 以上僅供檢討學習，不是投資建議
⚠️ 不代表未來績效

---

## 二、明日預測（80%）✅ 可執行建議

【明確標註這是明日12/05的建議】

### ⭐⭐⭐⭐⭐ 強力推薦（85分以上）

1. 股票A(代號) - 總分：88分
   （完整五維度評分+進場策略）
```

---

#### ❌ 絕對禁止

**1. 禁止在檢討部分寫「應該推薦」**
```markdown
❌ 絕對禁止：
「盤前如果用新系統，應該推薦永豐金88分」
「如果推薦永豐金，可獲利+2.27%」
「盤前評估失誤，永豐金其實是好標的」

✅ 正確做法：
「盤前預測：永豐金27.0元 → 實際：27.05元（+2.27%）✅ 成功」
「準確率：3/3 = 100%」
```

**2. 禁止檢討和預測混在一起**
```markdown
❌ 絕對禁止：
在「今日驗證」章節寫明日推薦
在「明日預測」章節寫今日檢討

✅ 正確做法：
今日驗證（20%）：只寫成功/失敗、準確率
明日預測（80%）：只寫明日推薦股票
```

**3. 禁止模糊時間**
```markdown
❌ 絕對禁止：
「永豐金值得關注」（什麼時候？今天還是明天？）
「可考慮進場」（現在還是明天開盤？）

✅ 正確做法：
明確標註「明日11/22開盤27.0-27.5元進場」
```

---

### 四、追蹤機制強制規範

#### tracking.json 必須包含

```json
{
  "date": "2025-11-21",
  "market_context": {
    "us_market": "NASDAQ +0.8%",
    "major_news": ["輝達財報超預期", "台積電法說會"]
  },
  "recommendations": [
    {
      "stock_code": "2890",
      "stock_name": "永豐金",
      "recommend_price": 27.0,
      "current_price": 26.45,
      "target_price": 30.0,
      "stop_loss": 24.8,
      "position": "15-20%",
      "rating": "⭐⭐⭐⭐⭐",
      "score": 88,
      "五維度": {
        "法人數據": 27,
        "時事現況": 27,
        "產業邏輯": 14,
        "價格位置": 12,
        "技術面": 8
      },
      "reason": "投信+9.3M、年底作帳行情剛啟動",
      "status": "pending"
    }
  ],
  "avoid_stocks": [
    {
      "stock_code": "2344",
      "stock_name": "華邦電",
      "reason": "法人對決、記憶體產業弱",
      "score": 42
    }
  ]
}
```

---

### 五、違規後果

**如果違反以上規範**：

1. **用戶有權質疑**
   - 立即停止分析
   - 承認錯誤

2. **必須記錄**
   - 寫入 `data/predictions/predictions.json`
   - 標註為「失誤案例」
   - 分析失誤原因

3. **檢討改進**
   - 為什麼會違規？
   - 如何防止再犯？
   - 更新規範文件

---

### 六、檢查清單（每次分析前必查）

**盤前分析**：
- [ ] 推薦至少3檔股票？
- [ ] 每檔都有五維度評分？
- [ ] 每檔都有明確價位+倉位+停損+目標？
- [ ] 建立了tracking.json？

**盤中分析**：
- [ ] 讀取了tracking.json？
- [ ] 只分析tracking中的股票？
- [ ] 沒有提到tracking外的股票？
- [ ] 給出了尾盤策略？

**盤後分析**：
- [ ] 明確分為「今日驗證（20%）」vs「明日預測（80%）」？
- [ ] 檢討部分只寫成功/失敗？
- [ ] 預測部分推薦至少3檔？
- [ ] 每檔都建立tracking.json？

---

## 🎯 雙軌評分系統（2025-11-27新增）

### 為什麼改用雙軌？

**舊問題（五維度混在一起）**：
```
時事好 + 法人買 → 88分 → 推薦
時事好 + 法人賣 → 65分 → 不推薦
時事差 + 法人買 → 70分 → 模糊

問題：時事和法人互相稀釋，看不出真正的驅動因素
```

**新方法（雙軌分開）**：
```
📰 時事軌（50分）          🏦 法人軌（50分）
├─ 國際面 (20分)           ├─ 投信 (20分)
├─ 產業催化 (20分)         ├─ 外資 (20分)
└─ 價格位置 (10分)         └─ 一致性 (10分)

兩條線分開評估 → 更清楚知道為什麼推薦
```

---

### 雙軌評分架構

```
┌──────────────────────────────────────────────────────────┐
│                    股票分析                              │
├────────────────────────┬─────────────────────────────────┤
│   📰 時事軌（50分）    │    🏦 法人軌（50分）            │
├────────────────────────┼─────────────────────────────────┤
│ • 國際面 (20分)        │ • 投信 (20分)                   │
│   - 美股/費半/輝達     │   - 買賣超張數                  │
│                        │   - 連續天數                    │
│ • 產業催化 (20分)      │                                 │
│   - 新聞/法說/訂單     │ • 外資 (20分)                   │
│                        │   - 買賣超張數                  │
│ • 價格位置 (10分)      │   - 連續天數                    │
│   - 是否追高           │                                 │
│                        │ • 一致性 (10分)                 │
│                        │   - 投信+外資同向加分           │
└────────────────────────┴─────────────────────────────────┘
```

---

### 📰 時事軌評分細則（50分）

**國際面（20分）**
⚠️ **注意**：必須執行 `python3 scripts/fetch_us_asia_markets.py` 獲取真實數據

| 條件 | 分數 |
|------|------|
| 費半 ≥+2% | 18-20 |
| 費半 +1~2% | 14-17 |
| 費半 0~1% | 10-13 |
| 費半 負 | 5-9 |
| 輝達大漲加分 | +2 |
| 台積電ADR+2%加分 | +1 |
| 多數ADR正成長 | +1 |

**產業催化（20分）**
| 條件 | 分數 |
|------|------|
| 重大利多（法說、訂單、漲價） | 16-20 |
| 一般利多（產業趨勢） | 11-15 |
| 無明顯催化 | 6-10 |
| 利空 | 0-5 |

**價格位置（10分）**
| 條件 | 分數 |
|------|------|
| 近5日 <3% | 8-10 |
| 近5日 3-7% | 5-7 |
| 近5日 >7% | 0-4 |

---

### 🏦 法人軌評分細則（50分）

**投信（20分）**
| 條件 | 分數 |
|------|------|
| 買超 >10K 且連續≥3日 | 18-20 |
| 買超 >10K | 14-17 |
| 買超 5K-10K | 10-13 |
| 買超 <5K | 6-9 |
| 賣超 | 0-5 |

**外資（20分）**
| 條件 | 分數 |
|------|------|
| 買超 >10K 且連續≥3日 | 18-20 |
| 買超 >10K | 14-17 |
| 買超 5K-10K | 10-13 |
| 買超 <5K 或 0 | 6-9 |
| 賣超 | 0-5 |

**一致性（10分）**
| 條件 | 分數 |
|------|------|
| 投信+外資同買超 | 10 |
| 只有一方買超 | 5 |
| 激烈對決（一買一賣>10K） | 2 |
| 都賣超 | 0 |

---

### 判讀矩陣

```
┌──────────────────────────────────────────────────────────┐
│                    判讀矩陣                              │
├────────────────┬────────────────┬────────────────────────┤
│                │ 法人強 (≥35)   │ 法人弱 (<35)           │
├────────────────┼────────────────┼────────────────────────┤
│ 時事強 (≥35)  │ 🔥 雙強        │ ⚡ 時事驅動            │
│                │ 最佳機會       │ 適合當沖/短線          │
├────────────────┼────────────────┼────────────────────────┤
│ 時事弱 (<35)  │ 💰 法人驅動    │ ❌ 雙弱                │
│                │ 適合波段       │ 不推薦                 │
└────────────────┴────────────────┴────────────────────────┘
```

**類型說明**：
- 🔥 **雙強**：時事+法人都強 → 最佳機會，可重倉
- ⚡ **時事驅動**：產業催化強但法人弱 → 適合當沖/短線
- 💰 **法人驅動**：法人買超強但時事弱 → 適合波段1-3月
- ❌ **雙弱**：都弱 → 不推薦
- ⚠️ **對決型**：法人軌一致性<5分 → 風險高，小倉位

---

### 推薦輸出格式（新）

```markdown
### 永豐金(2890)

📰 時事軌：32/50
├─ 國際面：12/20（費半+2.76%）
├─ 產業催化：12/20（年底作帳，無特別催化）
└─ 價格位置：8/10（近5日+2%，未追高）

🏦 法人軌：45/50
├─ 投信：18/20（+7,475張，連續買超）
├─ 外資：17/20（+10,601張）
└─ 一致性：10/10（投信+外資同買）

📊 判讀：💰 法人驅動型（時事32 + 法人45）
→ 適合：波段操作 1-3月
→ 進場：27.0元，倉位15%，停損26.0元
```

---

### 操作建議對照表

| 類型 | 時事軌 | 法人軌 | 適合操作 | 倉位 | 停損 |
|------|--------|--------|----------|------|------|
| 🔥 雙強 | ≥35 | ≥35 | 波段+短線 | 15-20% | -5% |
| ⚡ 時事驅動 | ≥35 | <35 | 當沖/短線 | 10-15% | -3% |
| 💰 法人驅動 | <35 | ≥35 | 波段1-3月 | 15-20% | -8% |
| ⚠️ 對決型 | - | 一致性<5 | 小倉位觀察 | 5-10% | -3% |
| ❌ 雙弱 | <35 | <35 | 不推薦 | 0% | - |

---

### 詳細使用指南

完整評分標準、實戰案例 → `docs/FIVE_DIMENSIONS_SCORING.md`

---

## 🔥 雙層推薦系統（2025-11-25新增）

### 為什麼需要雙層系統？

**用戶反饋（2025/11/25）**：
```
用戶：「欣興真的獲利也不是你推薦的，我還想問為什麼推薦的都沒什麼用」

實際數據：
- 我的推薦：永豐金+0.94%、彰銀+1.00%（穩健但漲幅小）
- 用戶自選：欣興+9.50%（短線爆發）

問題診斷：
我只推薦「穩健型」（法人主導、1-3月+10%）
用戶也想要「爆發型」（產業催化、1-3天+10%）
```

**解決方案**：雙層推薦系統 = 穩健型 + 爆發型

---

### 雙層系統核心差異

| 類型 | 範例 | 漲幅 | 時間週期 | 主要驅動 | 權重分配 |
|------|------|------|----------|----------|----------|
| **穩健型** | 永豐金、彰銀 | +1-3% | 1-3個月 | 法人持續買超 | 法人30%、時事30% |
| **爆發型** | 欣興 | +10%+ | 1-3天 | 產業催化+突然爆量 | 時事35%、產業30% |

---

### 穩健型評分系統（原系統、保持不變）

**權重配置**：
```
法人數據：30%  ← 最重要（投信大買超>10K）
時事現況：30%
產業邏輯：20%
價格位置：10%
技術面：10%
```

**推薦門檻**：
```
≥85分 → 強烈推薦15-20% ⭐⭐⭐⭐⭐
75-84分 → 推薦10-15% ⭐⭐⭐⭐
65-74分 → 可考慮5-10% ⭐⭐⭐
<65分 → 不推薦
```

**目標**：1-3個月+10-20%收益、法人主導、風險低

---

### 爆發型評分系統（v2.0新增）

**權重配置**：
```
時事現況：35%  ← 最重要（產業催化劑、突發利多）
產業邏輯：30%  ← 第二重要（爆發邏輯強度）
技術面：15%    ← 量能異動（盤中爆量）
法人數據：15%  ← 降低權重（散戶也能推動）
價格位置：5%   ← 爆發股不在乎已漲5%
```

**推薦門檻**（比穩健型更嚴格）：
```
≥80分 → 強烈推薦10-15% ⭐⭐⭐⭐⭐ （風險高、倉位降低）
70-79分 → 推薦5-10% ⭐⭐⭐⭐
60-69分 → 可考慮3-5% ⭐⭐⭐ （試單）
<60分 → 不推薦
```

**目標**：1-3天+10%+收益、產業驅動、風險高

**關鍵差異**：
- **時事現況**：從30% → 35%（重大產業催化劑最重要）
- **產業邏輯**：從20% → 30%（爆發邏輯強度、不可替代性）
- **技術面**：從10% → 15%（盤中爆量+買盤%判斷散戶追價力道）
- **法人數據**：從30% → 15%（爆發型可接受法人數據較弱）
- **價格位置**：從10% → 5%（爆發型可接受小追高）

---

### 推薦數量與倉位建議

**推薦數量**：
```
穩健型：4-5檔（主力配置）
爆發型：2-3檔（彈性配置）
總計：6-8檔（避免遺漏機會）
```

**倉位分配**：
```
穩健型總倉位：40-60%（4-5檔 × 10-15%）
爆發型總倉位：15-25%（2-3檔 × 5-10%）
現金保留：20-40%（安全墊）
```

**風險控制**：
```
穩健型：
- 停損：-8%（較寬鬆）
- 時間：等1-3個月
- 法人反轉賣超才停損

爆發型：
- 停損：-3至-5%（快速停損）
- 時間：1-3天達標就獲利了結
- 產業催化劑失效立即停損
```

---

### tracking.json 格式調整

**必須新增 "type" 欄位**：

```json
{
  "date": "2025-11-26",
  "recommendations": [
    {
      "type": "stable",       ← 新增：穩健型
      "stock_code": "2890",
      "stock_name": "永豐金",
      "score": 88,
      "五維度": {
        "法人數據": 27,
        "時事現況": 27,
        "產業邏輯": 14,
        "價格位置": 12,
        "技術面": 8
      },
      "time_horizon": "1-3個月",   ← 新增：時間週期
      "target_return": "+6-8%",   ← 新增：目標收益
      ...
    },
    {
      "type": "explosive",    ← 新增：爆發型
      "stock_code": "3037",
      "stock_name": "欣興",
      "score": 84,
      "五維度": {
        "時事現況": 31,
        "產業邏輯": 28,
        "技術面": 13,
        "法人數據": 9,
        "價格位置": 3
      },
      "time_horizon": "1-3天",    ← 新增：時間週期
      "target_return": "+10%+",  ← 新增：目標收益
      ...
    }
  ]
}
```

---

### 盤前分析輸出格式（新）

```markdown
## 三、股票推薦

### 🟢 穩健型推薦（法人主導、1-3月、目標+10-20%）

#### ⭐⭐⭐⭐⭐ 強烈推薦（≥85分）

**永豐金(2890)** - 總分：88分

**產業分類**：金融 → 綜合型
**驅動因素**：年底作帳、銀行+證券綜合

**五維度評分（穩健型權重）**：
- 📊 法人數據：27/30分
- 🌍 時事現況：27/30分
- 🏭 產業邏輯：14/20分
- 💰 價格位置：12/10分
- 📈 技術面：8/10分

**推薦策略**：
- 📍 進場價：26.8-27.2元
- 💰 倉位：15-20%
- 🛑 停損：26.0元（-3%）
- 🎯 目標：28.5-29.0元（1-3月，+6-8%）
- ⏰ 時間週期：1-3個月

---

### 🔴 爆發型推薦（產業催化、1-3天、目標+10%+）

#### ⭐⭐⭐⭐⭐ 強烈推薦（≥80分）

**欣興(3037)** - 總分：84分

**產業分類**：半導體 → 載板/PCB
**驅動因素**：ABF載板供需、AI伺服器、CoWoS擴產
**催化劑**：輝達Blackwell爆單+台積電CoWoS擴產

**五維度評分（爆發型權重）**：
- 🌍 時事現況：31/35分（輝達利多+ABF缺貨）
- 🏭 產業邏輯：28/30分（龍頭+爆發邏輯）
- 📈 技術面：13/15分（盤中爆量+買盤61.8%）
- 📊 法人數據：9/15分（投信+266張）
- 💰 價格位置：3/5分（盤中+5%）

**推薦策略**：
- 📍 進場價：168-172元
- 💰 倉位：10-15%（⚠️ 風險高）
- 🛑 停損：165元（-3%，快速停損）
- 🎯 目標：185元（1-3天，+10%）
- ⏰ 時間週期：1-3天（短線）

**⚠️ 風險提示**：
- 爆發型股票波動大、需快速停損
- 建議分批進場
- 達標立即獲利了結
```

---

### 詳細使用指南

完整評分標準、範例案例、實戰應用 → `docs/FIVE_DIMENSIONS_SCORING.md` v2.0

---

## 🏭 產業分類規範（2025-11-25新增）

### 為什麼需要？

不同產業有不同的驅動因素，同一大產業下的細分類型表現可能完全不同。
例如：金融股中的「壽險型」受股市/匯率影響，「證券型」受成交量影響，「純銀行」受利差影響。

### 產業分類表

#### 半導體產業
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 晶圓代工 | 台積電(2330)、聯電(2303) | AI需求、先進製程、客戶訂單 |
| IC設計 | 聯發科(2454)、瑞昱(2379) | 手機/PC出貨、新品週期 |
| 封測 | 日月光(3711) | 封裝需求、CoWoS產能 |
| 記憶體 | 南亞科(2408)、華邦電(2344) | DRAM/NAND價格、庫存週期 |
| 載板/PCB | 欣興(3037)、景碩(3189) | ABF載板供需、AI伺服器 |
| 設備 | 弘塑(3131)、辛耘(3583) | 資本支出、擴產週期 |

#### 電子產業
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 被動元件 | 國巨(2327)、華新科(2492) | 漲價週期、庫存回補 |
| 連接器 | 鴻海(2317)、正崴(2392) | 蘋果訂單、電動車 |
| 伺服器/AI | 廣達(2382)、緯創(3231) | AI伺服器出貨、雲端資本支出 |
| 散熱 | 雙鴻(3324)、超眾(6230) | AI散熱需求 |

#### 傳產
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 塑化 | 南亞(1303)、台塑(1301) | 油價、景氣循環、中國需求 |
| 鋼鐵 | 中鋼(2002) | 鋼價、基建需求 |
| 航運 | 長榮(2603)、陽明(2609) | 運價、塞港、旺季 |
| 水泥 | 台泥(1101)、亞泥(1102) | 基建、房市 |

#### 金融產業
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 純銀行 | 彰銀(2801)、華南金(2880)、第一金(2892) | 利差、放款成長、央行政策 |
| 壽險型 | 國泰金(2882)、富邦金(2881)、新光金(2888) | 股市、匯率、利率、避險成本 |
| 證券型 | 元大金(2885)、凱基金(2883) | 成交量、ETF規模、自營績效 |
| 綜合型 | 中信金(2891)、玉山金(2884)、永豐金(2890) | 銀行+證券綜合、分散風險 |

### 分析時產業分類必填

**tracking.json 必須包含**：
```json
{
  "stock_code": "2801",
  "stock_name": "彰銀",
  "industry": {
    "sector": "金融",
    "sub_type": "純銀行",
    "drivers": ["利差", "放款成長", "央行政策"]
  },
  ...
}
```

**分析報告必須標註**：
```markdown
### 彰銀(2801) ⭐⭐⭐⭐⭐ 總分：87分

**產業分類**：金融 → 純銀行
**驅動因素**：利差改善、央行升息受惠
```

### 產業分類的分析價值

1. **理解驅動因素**：同樣是金融股，壽險型和證券型的驅動因素完全不同
2. **產業輪動**：判斷資金是否在同一產業內輪動（如從壽險轉向證券）
3. **風險分散**：推薦股票時考慮是否過度集中於同一細分產業
4. **時事關聯**：將時事新聞與對應產業連結（如央行升息→利多純銀行）

---

## 🌐 全面客觀分析原則（2025-11-28新增）

### 為什麼需要？

**問題診斷**：
- ❌ 盤前只推薦3-8檔 → 遺漏真正的機會
- ❌ 盤中「只能分析tracking中的股票」→ 視野被人為限制
- ❌ 盤後只驗證推薦股 → 無法看到市場全貌
- ❌ tracking.json 與實際推薦不一致 → 追蹤失效

**解決方案**：全市場掃描 + 客觀記錄

---

### 盤前分析：全市場法人掃描（強制）

**Step 1: 查詢全市場法人數據**
```bash
# 必須查詢前一日法人買賣超
curl "https://www.twse.com.tw/rwd/en/fund/T86?date=YYYYMMDD&selectType=ALL&response=json"
```

**Step 2: 輸出法人買超/賣超 TOP50（強制）** 🆕 2025-12-17更新
```markdown
## 📈 法人買超 TOP50（YYYY-MM-DD）

| 排名 | 代號 | 名稱 | 三大法人 | 投信 | 外資 | 5日漲幅 | 狀態 |
|------|------|------|---------|------|------|--------|------|
| 1 | 2303 | 聯電 | +22,829 | -23,547 | +43,926 | +1.4% | ✅ 可進場 |
| 2 | 2887 | 台新金 | +78,524 | +136,031 | -53,420 | +3.6% | ⚠️ 已小漲 |
| 3 | ... | ... | ... | ... | ... | ... | ... |
（完整30檔）

## 📉 法人賣超 TOP50（YYYY-MM-DD）

| 排名 | 代號 | 名稱 | 三大法人 | 投信 | 外資 | 解讀 |
|------|------|------|---------|------|------|------|
| 1 | 2317 | 鴻海 | -7,243 | -207 | -6,587 | 三大同賣 |
（完整30檔）
```

**🔥 狀態標註規則**：
| 5日漲幅 | 狀態 | 說明 |
|--------|------|------|
| < 0% | ⭐ 佈局中 | 法人買但還沒漲，最佳 |
| 0-3% | ✅ 可進場 | 小漲，可買 |
| 3-5% | ⚠️ 已小漲 | 注意追高 |
| 5-8% | 🟡 追高風險 | 考慮等回檔 |
| > 8% | 🔴 已大漲 | 不建議追 |

**Step 3: 從 TOP50 中評分推薦**
```
展示完整TOP50給用戶，用戶可自行判斷：
1. 哪些「法人買超 + 還沒漲」→ 進場機會
2. 哪些「法人買超 + 已大漲」→ 觀望或等回檔
3. 不強制只推薦3-5檔，給用戶更多選擇
```

---

### 盤中分析：全市場異動掃描（新規範）

**舊規範問題**：
```
❌ 「只能分析tracking中的股票」
→ 如果盤前漏掉，盤中就完全看不到
→ 這不是客觀，是人為限制視野
```

**新規範**：
```markdown
## 盤中異動 TOP10

| 排名 | 代號 | 名稱 | 漲跌% | 量比 | 盤前推薦 | 備註 |
|------|------|------|-------|------|---------|------|
| 1 | 3037 | 欣興 | +5.06% | 2.5x | ✅ 是 | 可執行 |
| 2 | 2454 | 聯發科 | +3.20% | 1.8x | ❌ 否 | 僅記錄、不追高 |
| 3 | ... | ... | ... | ... | ... | ... |

**說明**：
- ✅ 盤前推薦：可執行尾盤策略
- ❌ 非盤前推薦：僅客觀記錄，不建議追高
```

**關鍵改變**：
- 不再「只看tracking中的股票」
- 改為「全市場掃描，但明確標註哪些是盤前推薦」
- 盤前沒推薦的：僅記錄、不建議追高（防止事後諸葛）
- 盤前有推薦的：可執行尾盤策略

---

### 盤後分析：全市場收盤記錄（強制）

**必須輸出**：
```markdown
## 📊 今日漲幅 TOP10

| 排名 | 代號 | 名稱 | 漲跌% | 盤前推薦 | 法人 | 備註 |
|------|------|------|-------|---------|------|------|
| 1 | 3037 | 欣興 | +9.50% | ✅ 是 | +16,304 | 推薦成功 |
| 2 | 2454 | 聯發科 | +4.20% | ❌ 否 | +8,234 | 未推薦 |
（完整10檔）

## 📈 法人買超 TOP50（今日）

（完整30檔，用於明日盤前分析）
```

**目的**：
1. 客觀記錄市場表現
2. 驗證推薦準確率
3. 找出明日機會（法人今日買超 → 明日可能續漲）

---

### tracking.json 同步規範

**問題**：tracking.json 內容與實際盤前推薦不一致

**強制規範**：
```
盤前分析完成後，必須同步更新 tracking.json
- tracking.json 內容 = 盤前分析推薦股票
- 不能有「盤前推薦了A，但tracking記錄B」的情況
- 每日盤後驗證：tracking內容是否與盤前一致
```

**tracking.json 必須包含**：
```json
{
  "date": "2025-11-28",
  "sync_check": {
    "before_market_recommendations": ["2801", "2890", "2881"],
    "tracking_recommendations": ["2801", "2890", "2881"],
    "is_synced": true
  },
  "recommendations": [...]
}
```

---

### 檢查清單（每次分析必查）

**盤前分析**：
- [ ] 查詢了全市場法人數據？
- [ ] 輸出了買超TOP50 + 賣超TOP50？
- [ ] 從TOP50中標註狀態（5日漲幅）？
- [ ] tracking.json 已同步更新？

**盤中分析**：
- [ ] 輸出了異動TOP10？
- [ ] 標註了「盤前推薦」vs「非盤前推薦」？
- [ ] 非盤前推薦股票只記錄、不建議追高？

**盤後分析**：
- [ ] 輸出了漲幅TOP10？
- [ ] 輸出了法人買超TOP50（明日用）？
- [ ] 驗證了tracking與盤前推薦是否一致？

---

## 核心規範速查

### 🎯 絕對禁止（歷史血淚教訓）

| 禁令 | 錯誤案例 | 用戶反饋 |
|------|---------|---------|
| **❌ 事後諸葛** | 盤中說「創意+9.84%」但盤前沒預測 | 「爆漲的你從來沒預估成功，那你說個屁哦」 |
| **❌ 追高推薦** | 推薦已漲+20%的旺宏、+16%華邦電 | 「你說的這幾隻都正在漲欸」 |
| **❌ 主觀選股** | 只給台積電、鴻海，遺漏聯電+16K | 用戶要求全市場掃描，我卻主觀篩選 |
| **❌ 過早判定** | 盤中預測當日收盤驗證 | 晟銘電11/11收-0.36%→11/12收+5.82% |

### ✅ 必須執行（強制規範）

#### 1. 法人數據查詢（第一步）
```python
# 當用戶問「法人數據」「法人動向」時
url = 'https://www.twse.com.tw/rwd/en/fund/T86?date=YYYYMMDD&selectType=ALL&response=json'

# 必須輸出：
📈 買超TOP50（依三大法人合計排序）
📉 賣超TOP50（依三大法人合計排序）

# 絕對禁止：
❌ 只查持股中的5-10檔
❌ 只查台積電、鴻海等熟悉股票
❌ 主觀認為「這些比較重要」
```

**輸出格式**：
```
代號   名稱    三大法人   投信    自營商   外資(推)   解讀
2303  聯電    +16,866   +8,234   +523    +8,109   半導體受惠AI
```

**分析重點**：
- 哪些「跌但法人買」（機會）
- 哪些「漲但法人賣」（陷阱）
- 產業輪動方向

#### 2. 股票推薦規範（五維度評分制）

**推薦流程（必須執行）**：

**Step 1: 五維度評分**
```
對每檔潛在推薦股票進行五維度評分：
1️⃣ 法人數據（30%）
2️⃣ 時事現況（30%）
3️⃣ 產業邏輯（20%）
4️⃣ 價格位置（10%）
5️⃣ 技術面（10%）

總分 = Σ(各維度分數 × 權重)
```

**Step 2: 對照推薦門檻**
```
≥85分 → 強烈推薦15-20% ⭐⭐⭐⭐⭐
75-84分 → 推薦10-15% ⭐⭐⭐⭐
65-74分 → 可考慮5-10% ⭐⭐⭐
55-64分 → 觀望優先3-5% ⭐⭐
<55分 → 不推薦 ❌
```

**Step 3: 輸出推薦（使用新格式）**

參考「五維度評分系統」章節的輸出格式

**❌ 絕對禁止推薦**（不論評分高低）：
1. **已大漲股票（近5日>10%）** - 讓用戶接最後一棒
2. **盤中已爆發** - 事後諸葛無意義
3. **單一維度極低分（<30分）** - 即使總分高也有致命風險

**⚠️ 不再絕對禁止（改為扣分）**：
1. **法人對決** - 不是一票否決，看主導方+產業邏輯
2. **外資0張** - 扣分但不絕對否決，看投信力道+產業邏輯
3. **投信<10K** - 扣分但不絕對否決，看外資+時事

**推薦時機檢查表**：
- [ ] 已完成五維度評分？（✅）只看單一維度？（❌）
- [ ] 總分≥65分？（✅）<65分還推薦？（❌）
- [ ] 股票「還沒大漲」（近5日<10%）？（✅）已大漲？（❌）
- [ ] 有明確產業邏輯？（✅）只有法人買超？（❌）
- [ ] 給出五維度分數+進場條件+目標+停損？（✅）模糊推薦？（❌）

#### 3. 三階段分析標準

**時間軸**：
```
09:00前  盤前分析 → 時事40% + 法人40% + 技術20% → 預測今日有機會股票
12:30    盤中分析 → intraday_scanner.py → 尾盤策略
14:30後  盤後分析 → 簡短驗證(20%) + 預測明日有機會股票(80%)
```

**核心原則**：
- **盤前**：全市場掃描、預測**所有有機會**的股票（不限數量）、明確價位+倉位+停損+目標
- **盤中**：執行intraday_scanner.py、只分析盤前預測股、給尾盤策略
- **盤後**：簡短驗證今日(20%) + **預測明日所有有機會股票(80%)**、明確價位+倉位

**進場策略規範**：
- ❌ 錯誤：「等回檔至XX元」（強勢股不回檔）
- ✅ 正確：「09:00開盤XX元進場5-10%、若回檔至YY元加碼至15-20%」
- ❌ 錯誤：「開盤進場」（沒給價位）
- ✅ 正確：「開盤52-54元進場10-15%、停損-8%、目標58-60元」

**品質檢查清單**：
- [ ] 盤前：全市場掃描？**所有有機會股票**？明確價位+倉位+停損+目標？
- [ ] 盤中：執行scanner？只分析盤前預測股？尾盤策略？
- [ ] 盤後：簡短驗證(1-2段)？**預測明日所有有機會股票**？明確價位+倉位？

**詳細規範**：參考 `docs/ANALYSIS_STANDARDS_V2.md`（615行完整版）

---

## 數據時效與關鍵教訓

### 時效性
- **法人數據**：每日14:30-15:00公布，盤中無法取得
- **Yahoo Finance**：盤中延遲15-20分鐘
- **盤中分析**：量比>3倍、爆量為有效指標

### 🚨 歷史教訓（必看）

**過度保守災難（2025/10/01）**：
- 推薦股漲1.10% vs 警告股漲5.79%
- 教訓：動能比安全重要

**全市場掃描（2025/10/08）**：
- 法人10/07買超 → 10/08全漲（100%準確）
- 教訓：跟緊法人、視野要全面

**主觀選股災難（2025/10/13）**：
- 只給台積電、鴻海，遺漏聯電+16,866張（法人買超第一名）
- 教訓：**絕不主觀選股**

**事後諸葛災難（2025/10/21）**：
- 盤中說「創意+9.84%」但盤前沒預測
- 用戶反饋：「爆漲的你從來沒預估成功，那你說個屁哦」
- 教訓：**絕不事後諸葛**

**追高推薦災難（2025/10/28）**：
- 推薦已漲+20%旺宏、+16%華邦電
- 用戶反饋：「你說的這幾隻都正在漲欸」
- 教訓：**絕不追高推薦**、找「法人在買但還沒漲」的股票

**一票否決災難（2025/11/20）** ⚠️ **重大教訓**：
- 法人對決100%不推薦 → 錯過12檔股票（92.3%都上漲）
- 用戶質疑：「跌不買、漲不買，什麼時候買？」
- 錯誤原因：只看法人數據、忽略時事+產業邏輯
- 教訓：**不能一票否決**、需要**五維度綜合評分**
- 改進方案：建立五維度評分系統

**核心結論**：
```
動能 > 安全
跟緊法人 > 主觀判斷
全面掃描 > 只看熟悉股票
提前佈局 > 事後諸葛
還沒漲 > 已經漲
綜合評分 > 一票否決（新增 2025/11/20）
```

---

## 盤中量能分析工具

### 🆕 新版v2（推薦使用）- intraday_analyzer_v2.py

**執行方式**：
```bash
python3 scripts/intraday_analyzer_v2.py
```

**核心特色**：
- ✅ 防止事後諸葛：只分析tracking.json中的盤前推薦股
- ✅ 五維度評分：綜合法人+時事+產業+價格+技術
- ✅ 明確策略：給出進場價、倉位、停損、目標
- ✅ 追高警告：盤中漲幅>3%自動標註不追高

**使用流程**：
1. 盤前分析完成 → 自動建立 `tracking_YYYY-MM-DD.json`
2. 12:30執行 `python3 scripts/intraday_analyzer_v2.py`
3. 讀取tracking檔案 → 只分析盤前推薦股票
4. 五維度評分 → 給出尾盤策略

**輸出範例**：
```
⭐⭐⭐⭐⭐ 強力推薦（85分以上）- 可尾盤進場
----------------------------------------
永豐金(2890) - 總分：88分
  盤前推薦價：27.0元
  盤中價位：26.8元（+1.5%）
  量比：2.0x

  五維度評分：
    📊 法人數據：27分（昨日投信+9.3K）
    🌍 時事現況：27分
    🏭 產業邏輯：14分
    💰 價格位置：12分（盤中+1.5%，小漲可買）
    📈 技術面：8分（量比2.0x）

  🎯 尾盤策略：
    進場價：26.6-27.0元
    倉位：15-20%
    停損：26.0元（-2%）
    目標：27.5元（+2%，尾盤）
```

**防止事後諸葛機制**：
- 若tracking.json不存在 → 無法執行，提示先做盤前分析
- 只分析tracking中的股票 → 絕不提tracking外的股票
- 完全避免「盤前沒推薦、盤中說漲」的事後諸葛

---

### 舊版（保留備用）- intraday_scanner.py

**為什麼需要？**
**問題**：盤前預測常常「已經在漲了」，錯過最佳進場時機
**解決**：12:30執行，找「法人正在佈局、但還沒大漲」的機會股

**⚠️ 限制**：
- 使用一票否決制（法人對決=觀望）
- 無五維度評分
- 無追蹤機制（可能事後諸葛）

### 核心邏輯
```
昨日法人買超 + 今日爆量(3x) + 小漲(<3%) = ✅ 法人吸貨中（機會）
昨日法人買超 + 今日爆量(3x) + 大漲(>5%) = ❌ 已大漲（太晚）
昨日法人賣超 + 今日爆量(3x) + 下跌 = ❌ 法人出貨（避開）
```

### 使用流程

**Step 1: 執行掃描**
```bash
python3 intraday_scanner.py
```

**Step 2: 解讀結果**
| 結果 | 判斷 | 行動 |
|------|------|------|
| ✅ 吸貨中（機會） | 法人佈局、還沒被發現 | 尾盤12:30-13:00進場 |
| ⚠️ 偏強（觀望） | 已漲一些 | 等回檔 |
| ❌ 已大漲（太晚） | 追高陷阱 | 不進場 |
| ⚠️ 法人對決 | 投信vs外資分歧 | 等盤後數據 |

**Step 3: 驗證數據（重要）**
```bash
# 驗證昨日法人數據
python3 scripts/check_institutional.py 2883 20251111

# 對照券商軟體股價量能
```

### 數據來源與限制
- **法人數據**：證交所API（前一日）
- **股價量能**：Yahoo Finance（延遲15-20分鐘）
- **掃描範圍**：約50檔主要標的
- **⚠️ 必須驗證**：不可盲目相信，務必對照券商軟體

### 注意事項
1. **絕不盲目跟單** - 必須對照券商軟體
2. **停損紀律** - 進場必設停損-8%
3. **資金控管** - 單檔不超過總資金20%

---

## 盤中量能分析邏輯

### 量能定義
- **爆量**：成交量 > 5日均量 3倍
- **大量**：成交量 > 5日均量 2倍
- **縮量**：成交量 < 5日均量 0.5倍

### 量價關係矩陣（推測法人意圖）

| 量能 | 價格 | 昨日法人 | 推測 | 策略 |
|------|------|----------|------|------|
| 爆量 | 大漲 | 買超 | ✅ 法人續買、主升段 | 尾盤可追 |
| 爆量 | 小漲/平 | 買超 | ✅ 法人吸貨中 | 尾盤可買 |
| 爆量 | 下跌 | 買超 | ⚠️ 法人接刀失敗 | 觀望 |
| 爆量 | 下跌 | 賣超 | ❌ 法人出貨 | 避開 |
| 縮量 | 上漲 | 買超 | ⚠️ 量價背離 | 不追 |
| 縮量 | 下跌 | 賣超 | ❌ 法人棄守 | 避開 |

### 盤中分析流程

**Step 1: 只看預測的6-10檔**（絕不事後諸葛）
```
盤前預測：華邦電、鴻海、國巨、聯電、台積電、南亞科
盤中只分析這6檔
絕不說「創意+9.84%」（因為盤前沒預測）
```

**Step 2: 量能異常偵測**
```
華邦電 (2344)
├─ 成交量：爆量5倍
├─ 價格：-2.27%
├─ 昨日法人：買超+569K
└─ 推測：法人接刀失敗 → 避開觀望
```

**Step 3: 尾盤策略輸出**
```
✅ 可買：國巨（法人續買）、鴻海（AI動能）
⚠️ 觀察：華邦電（等盤後法人數據）
❌ 避開：聯電（量能不足）
```

### 絕對禁止的盤中行為
1. **事後諸葛** - ❌「創意+9.84%，因為ASIC設計受惠AI」
2. **大量解釋** - ❌「華邦電失敗原因：記憶體復甦緩慢...」（簡單說「失敗」即可）
3. **追高建議** - ❌「創意可追1,650元」（盤前沒預測）

---

## 盤前時事分析

### 時事權重：40%
時事影響市場預期，必須納入分析

### 必查來源
**國際面**：
- 美股表現（那斯達克、費半指數）
- 重大數據（CPI、非農、Fed決議）
- 地緣政治（美中科技戰、台海局勢）

**產業面**：
- 法說會/財報（台積電、聯發科、鴻海）
- 產業新聞（AI訂單、記憶體價格、設備出貨）
- 客戶動態（蘋果、輝達、特斯拉）

### 分析原則
```
✅ 正確：費半+1.58%、輝達創高 → 利多台積電、聯發科 → 今日佈局這些標的
❌ 錯誤：只看法人數據、不看時事
❌ 錯誤：摘要新聞但沒給投資判斷
❌ 錯誤：看了時事但預測股票與時事無關
```

---

## 數據驗證與品質控制

| 類別 | 範例 | 標註 |
|------|------|------|
| ✅ **可驗證** | Yahoo Finance股價、證交所法人數據 | 註明來源時間 |
| ⚠️ **無法驗證** | 市場傳言、主觀觀察 | 明確標註警告 |
| ❌ **絕對禁止** | 編造法人數據、假冒官方來源 | 用戶質疑立即修正 |

---

## 參考文件

**核心規範**（必讀）：
- `CLAUDE.md` - 本文件（主規範，包含所有核心流程）

**詳細參考**（docs/reference/）🆕：
- `docs/reference/SCORING_SYSTEM.md` - 雙軌評分+雙層推薦+佈局股驗證
- `docs/reference/TOOLS_GUIDE.md` - 腳本工具使用指南（12+工具）
- `docs/reference/INDUSTRY_NEWS_MAPPING.md` - 時事→產業對照表+14產業掃描
- `docs/reference/HISTORICAL_LESSONS.md` - 歷史血淚教訓彙整

**預測追蹤**：
- `data/predictions/predictions.json` - 預測追蹤記錄

**範本文件**：
- `templates/before_market_template.md` - 盤前分析範本
- `templates/after_market_template.md` - 盤後分析範本
- `templates/weekly_report_template.md` - 週報範本

**輔助文件**（偶爾參考）：
- `docs/ENHANCED_SYSTEM_USAGE.md` - 追蹤系統使用指南
- `docs/MARKET_NEWS_CHECKLIST.md` - 時事檢查清單

---

**最後更新**：2026-01-21
**版本**：v5.7（產業掃描優化+佈局股雙重驗證+金融防禦調整+反轉預警）🔥
**重大更新**：
- 🆕 **v5.7 產業掃描矩陣完善**（2026-01-21）
  - 問題：費半利多只推薦載板，遺漏記憶體（華邦電+5.85%）
  - 解決：費半利多時必須掃描全部5個次產業（晶圓代工/載板/記憶體/封測/電源供應）
  - 新增「費半利多→半導體次產業展開表」
- 🆕 **v5.7 佈局股雙重驗證**（2026-01-21）
  - 問題：陽明法人買超但-0.36%（只有法人買、無產業催化）
  - 解決：佈局股必須同時滿足「法人條件+產業催化劑」
  - 新增佈局股評分表（無催化劑-30分）
- 🆕 **v5.7 金融防禦策略調整**（2026-01-21）
  - 問題：台新金+3.70%但法人-20K出貨（有效但短暫）
  - 解決：金融防禦倉位從10-15%降至5%、停利從+5-8%降至+2%
  - 新增金融防禦特殊規則（當沖/隔日沖適用）
- 🆕 **v5.7 法人反轉預警工具**（2026-01-21）
  - 功能：偵測「連續買超後突然賣超」的股票
  - 教訓：力積電連續狂買+50K → 隔日反轉-20K
  - 用法：`python3 scripts/reversal_alert.py`

**v5.6更新**（2026-01-20）：
- 🆕 **fetch_tw_market_news.py 台股時事分析**
  - 功能：MOPS全市場重大訊息、法說會、熱門題材、財經新聞
  - 解決：以前只分析美股時事，現在也掃描台股本地時事
  - 觸發：「台股時事」「重大訊息」「法說會日期」
  - 用法：`python3 scripts/fetch_tw_market_news.py`

**v5.5更新**（2026-01-19）：
- 🆕 **holdings_analysis.py 法人持股水位分析**
  - 功能：查詢外資持股量、持股比例、出場壓力評估
  - 解決：以前只知道買賣超，現在知道「佔持股比例」判斷壓力大小
  - 觸發：「出場壓力分析」「持股水位分析」「外資持股比例」
  - 用法：`python3 scripts/holdings_analysis.py 2330`

**v5.4更新**（2026-01-14）：
- 🆕 **Step -1: 資訊同步檢查**（血淚教訓 2026-01-14）
  - 問題：慧洋已賣出但分析寫「續抱」，用戶極度不滿
  - 解決：分析前強制讀取昨日 intraday/after_market + my_holdings.yaml
  - 核心：**發現不一致立即停止**，絕不能「先繼續再說」
- 🆕 **強制使用 TodoWrite 追蹤**（解決執行不完整問題）
  - 問題：流程經常跳步驟、執行不完整
  - 解決：必須用 TodoWrite 追蹤每個 Step，逐步打勾
  - 核心：**絕對不能跳過、不能批次完成**

**v5.3更新**（2026-01-13）：
- 🆕 **Step 1.7: 昨日 key_lessons 主動檢查**（血淚教訓 2026-01-13）
  - 問題：記錄教訓 ≠ 應用教訓（PCB教訓沒主動檢查）
  - 解決：強制四步驟流程（判斷相關性 → 主動查詢 → 靈活判斷 → 記錄決策）
  - 核心：**主動檢查 + 靈活判斷 + 必須記錄**，避免機械執行
- 🔧 **盤前流程完善**：補上教訓檢查環節，確保歷史經驗真正應用

**v5.2更新**（2025-12-17）：
- 🆕 **籌碼分析工具**：`chip_analysis.py` 查詢N天法人歷史，驗證「真連續買超」
- 🆕 **法人TOP50篩選**：`fetch_institutional_top50.py` 自動標註5日漲幅+狀態（2026-01-20檔名更新）
- 🆕 **時事先行策略**：從產業找股票，不是從法人找股票
- 🆕 **產業分散規則**：單一產業≤50%
- 🔧 **盤前流程優化**：TOP50快速篩選 → 籌碼深度分析 → 最終推薦

**v5.1更新**（2025-12-12）：
- 個人持股分析工具：`my_holdings_analyzer.py`
- 四維度持股評分+健康度評分系統
- 出場機制設計：三層出場機制

**v5.0核心原則**（2025-12-01）：
- 🔥 **歷史驗證 > 理論分析**（最重要升級）
- ✅ **延續成功 > 尋找新標的**
- ✅ **避開失敗模式** → 準確率提升
- ✅ **強制檢查清單** → 不再遺忘歷史
- 🆕 **主動檢查教訓** → 真正應用經驗（v5.3加強）

