# CLAUDE.md

台股智能分析系統開發指引

## 系統概述

基於真實法人數據的台股分析系統，提供多維度股票分析和個人持股管理。

## 🚨 每次對話開始強制流程

**重要**：每次新對話必須先執行 → **讀取 `CONVERSATION_START_CHECKLIST.md`**

該檔案包含：
- 必讀文件清單（PREDICTION_ACCURACY_TRACKING.md、昨日分析）
- 核心規則提醒（盤中預測→隔日驗證、不事後諸葛、不追高推薦）
- 歷史教訓速查（晟銘電案例、買賣比指標應用）

---

## ⚠️ 預測準確率追蹤

**歷史教訓**：2025/10/01 準確率8.3%（12項僅對1項）
**最新成果**：2025/11/11 準確率70%（7/10）
**關鍵改善**：盤中預測改用「隔日驗證」+ 買賣比指標

詳見：`docs/archive/plans/PREDICTION_ACCURACY_TRACKING.md`

---

## 核心架構

### 📁 目錄結構
```
stock/
├── src/                          # 主程式目錄
│   ├── main.py                   # 股票查詢分析入口
│   ├── portfolio_analyzer.py     # 個人持股分析
│   ├── data_fetcher.py           # 數據獲取(證交所API + Yahoo Finance)
│   ├── analyzer.py               # 多維分析引擎
│   └── utils.py                  # 工具函數
├── check_institutional.py        # 單一股票法人查詢工具
├── intraday_scanner.py           # 🔥 盤中量能掃描器（12:30執行）
├── portfolio/my_holdings.yaml    # 個人持股配置
├── data/YYYY-MM-DD/              # 每日分析報告
│   ├── before_market_analysis.md
│   ├── intraday_analysis.md
│   └── after_market_analysis.md
└── docs/                         # 規範文件
    ├── CONVERSATION_START_CHECKLIST.md
    ├── ANALYSIS_STANDARDS_V2.md
    └── archive/plans/PREDICTION_ACCURACY_TRACKING.md
```

### 核心工具

**check_institutional.py** - 法人數據查詢
- 解決只能看TOP50限制
- 可查詢任何股票法人數據
- 用法：`python3 check_institutional.py 2330 20251111`

**intraday_scanner.py** - 盤中量能掃描器
- 執行時機：12:30（最佳）
- 核心邏輯：找「法人正在佈局、但還沒大漲」的機會股
- 篩選條件：爆量(3x) + 小漲(<3%) + 昨日法人買超
- 用法：`python3 intraday_scanner.py`

詳細使用指南：本文件「盤中量能掃描器」章節

---

## 開發流程規範

### 代碼修改規則
1. **先列出要修改的文件** - 任何代碼修改前必須先列出具體文件清單
2. **等待審核批准** - 獲得明確同意後才能開始開發
3. **新系統架構需詢問** - 任何架構變更都需要事先討論
4. **禁止擅自行動** - 不得直接修改文件、創建新文件或改變架構

---

## 核心規範速查

### 🎯 絕對禁止（歷史血淚教訓）

| 禁令 | 錯誤案例 | 用戶反饋 |
|------|---------|---------|
| **❌ 事後諸葛** | 盤中說「創意+9.84%」但盤前沒預測 | 「爆漲的你從來沒預估成功，那你說個屁哦」 |
| **❌ 追高推薦** | 推薦已漲+20%的旺宏、+16%華邦電 | 「你說的這幾隻都正在漲欸」 |
| **❌ 主觀選股** | 只給台積電、鴻海，遺漏聯電+16K | 用戶要求全市場掃描，我卻主觀篩選 |
| **❌ 過早判定** | 盤中預測當日收盤驗證 | 晟銘電11/11收-0.36%→11/12收+5.82% |

### ✅ 必須執行（強制規範）

#### 1. 法人數據查詢（第一步）
```python
# 當用戶問「法人數據」「法人動向」時
url = 'https://www.twse.com.tw/rwd/en/fund/T86?date=YYYYMMDD&selectType=ALL&response=json'

# 必須輸出：
📈 買超TOP15（依三大法人合計排序）
📉 賣超TOP15（依三大法人合計排序）

# 絕對禁止：
❌ 只查持股中的5-10檔
❌ 只查台積電、鴻海等熟悉股票
❌ 主觀認為「這些比較重要」
```

**輸出格式**：
```
代號   名稱    三大法人   投信    自營商   外資(推)   解讀
2303  聯電    +16,866   +8,234   +523    +8,109   半導體受惠AI
```

**分析重點**：
- 哪些「跌但法人買」（機會）
- 哪些「漲但法人賣」（陷阱）
- 產業輪動方向

#### 2. 股票推薦規範

**✅ 可推薦**：
1. **法人剛佈局、漲幅<5%** - 提前卡位，避免追高
2. **產業邏輯明確、等回檔** - 趨勢對但價位不對
3. **長期核心資產** - 台積電等龍頭股分批買

**❌ 絕對禁止推薦**：
1. **已大漲股票** - 讓用戶接最後一棒
2. **盤中已爆發** - 事後諸葛無意義
3. **只有法人買超、無產業邏輯** - 法人對決風險

**推薦格式**（必含以下要素）：
```markdown
### 股票名稱 (代號) ⭐⭐⭐⭐⭐
- **法人數據**：日期買超+XXK（投信+XXK）
- **產業邏輯**：具體催化劑
- **為什麼還沒漲**：解釋機會點
- **進場條件**：明確觸發條件
- **目標價**：+XX%（時間）
- **停損**：-8%
```

**推薦時機檢查表**：
- [ ] 基於「尚未公布數據」預測？（✅）還是用「已收盤數據」？（❌）
- [ ] 股票「還沒漲」？（✅）還是「已漲20%」？（❌）
- [ ] 有明確產業邏輯？（✅）只有法人買超？（❌）
- [ ] 給出進場條件、目標價、停損？（✅）模糊推薦？（❌）

#### 3. 三階段分析標準

**時間軸**：
```
09:00前  盤前分析 → 時事40% + 法人40% + 技術20% → 預測今日有機會股票
12:30    盤中分析 → intraday_scanner.py → 尾盤策略
14:30後  盤後分析 → 簡短驗證(20%) + 預測明日有機會股票(80%)
```

**核心原則**：
- **盤前**：全市場掃描、預測**所有有機會**的股票（不限數量）、明確價位+倉位+停損+目標
- **盤中**：執行intraday_scanner.py、只分析盤前預測股、給尾盤策略
- **盤後**：簡短驗證今日(20%) + **預測明日所有有機會股票(80%)**、明確價位+倉位

**進場策略規範**：
- ❌ 錯誤：「等回檔至XX元」（強勢股不回檔）
- ✅ 正確：「09:00開盤XX元進場5-10%、若回檔至YY元加碼至15-20%」
- ❌ 錯誤：「開盤進場」（沒給價位）
- ✅ 正確：「開盤52-54元進場10-15%、停損-8%、目標58-60元」

**品質檢查清單**：
- [ ] 盤前：全市場掃描？**所有有機會股票**？明確價位+倉位+停損+目標？
- [ ] 盤中：執行scanner？只分析盤前預測股？尾盤策略？
- [ ] 盤後：簡短驗證(1-2段)？**預測明日所有有機會股票**？明確價位+倉位？

**詳細規範**：參考 `docs/ANALYSIS_STANDARDS_V2.md`（615行完整版）

---

## 數據時效與關鍵教訓

### 時效性
- **法人數據**：每日14:30-15:00公布，盤中無法取得
- **Yahoo Finance**：盤中延遲15-20分鐘
- **盤中分析**：量比>3倍、爆量為有效指標

### 🚨 歷史教訓（必看）

**過度保守災難（2025/10/01）**：
- 推薦股漲1.10% vs 警告股漲5.79%
- 教訓：動能比安全重要

**全市場掃描（2025/10/08）**：
- 法人10/07買超 → 10/08全漲（100%準確）
- 教訓：跟緊法人、視野要全面

**主觀選股災難（2025/10/13）**：
- 只給台積電、鴻海，遺漏聯電+16,866張（法人買超第一名）
- 教訓：**絕不主觀選股**

**事後諸葛災難（2025/10/21）**：
- 盤中說「創意+9.84%」但盤前沒預測
- 用戶反饋：「爆漲的你從來沒預估成功，那你說個屁哦」
- 教訓：**絕不事後諸葛**

**追高推薦災難（2025/10/28）**：
- 推薦已漲+20%旺宏、+16%華邦電
- 用戶反饋：「你說的這幾隻都正在漲欸」
- 教訓：**絕不追高推薦**、找「法人在買但還沒漲」的股票

**核心結論**：
```
動能 > 安全
跟緊法人 > 主觀判斷
全面掃描 > 只看熟悉股票
提前佈局 > 事後諸葛
還沒漲 > 已經漲
```

---

## 盤中量能掃描器

### 為什麼需要？
**問題**：盤前預測常常「已經在漲了」，錯過最佳進場時機
**解決**：12:30執行，找「法人正在佈局、但還沒大漲」的機會股

### 核心邏輯
```
昨日法人買超 + 今日爆量(3x) + 小漲(<3%) = ✅ 法人吸貨中（機會）
昨日法人買超 + 今日爆量(3x) + 大漲(>5%) = ❌ 已大漲（太晚）
昨日法人賣超 + 今日爆量(3x) + 下跌 = ❌ 法人出貨（避開）
```

### 使用流程

**Step 1: 執行掃描**
```bash
python3 intraday_scanner.py
```

**Step 2: 解讀結果**
| 結果 | 判斷 | 行動 |
|------|------|------|
| ✅ 吸貨中（機會） | 法人佈局、還沒被發現 | 尾盤12:30-13:00進場 |
| ⚠️ 偏強（觀望） | 已漲一些 | 等回檔 |
| ❌ 已大漲（太晚） | 追高陷阱 | 不進場 |
| ⚠️ 法人對決 | 投信vs外資分歧 | 等盤後數據 |

**Step 3: 驗證數據（重要）**
```bash
# 驗證昨日法人數據
python3 check_institutional.py 2883 20251111

# 對照券商軟體股價量能
```

### 數據來源與限制
- **法人數據**：證交所API（前一日）
- **股價量能**：Yahoo Finance（延遲15-20分鐘）
- **掃描範圍**：約50檔主要標的
- **⚠️ 必須驗證**：不可盲目相信，務必對照券商軟體

### 注意事項
1. **絕不盲目跟單** - 必須對照券商軟體
2. **停損紀律** - 進場必設停損-8%
3. **資金控管** - 單檔不超過總資金20%

---

## 盤中量能分析邏輯

### 量能定義
- **爆量**：成交量 > 5日均量 3倍
- **大量**：成交量 > 5日均量 2倍
- **縮量**：成交量 < 5日均量 0.5倍

### 量價關係矩陣（推測法人意圖）

| 量能 | 價格 | 昨日法人 | 推測 | 策略 |
|------|------|----------|------|------|
| 爆量 | 大漲 | 買超 | ✅ 法人續買、主升段 | 尾盤可追 |
| 爆量 | 小漲/平 | 買超 | ✅ 法人吸貨中 | 尾盤可買 |
| 爆量 | 下跌 | 買超 | ⚠️ 法人接刀失敗 | 觀望 |
| 爆量 | 下跌 | 賣超 | ❌ 法人出貨 | 避開 |
| 縮量 | 上漲 | 買超 | ⚠️ 量價背離 | 不追 |
| 縮量 | 下跌 | 賣超 | ❌ 法人棄守 | 避開 |

### 盤中分析流程

**Step 1: 只看預測的6-10檔**（絕不事後諸葛）
```
盤前預測：華邦電、鴻海、國巨、聯電、台積電、南亞科
盤中只分析這6檔
絕不說「創意+9.84%」（因為盤前沒預測）
```

**Step 2: 量能異常偵測**
```
華邦電 (2344)
├─ 成交量：爆量5倍
├─ 價格：-2.27%
├─ 昨日法人：買超+569K
└─ 推測：法人接刀失敗 → 避開觀望
```

**Step 3: 尾盤策略輸出**
```
✅ 可買：國巨（法人續買）、鴻海（AI動能）
⚠️ 觀察：華邦電（等盤後法人數據）
❌ 避開：聯電（量能不足）
```

### 絕對禁止的盤中行為
1. **事後諸葛** - ❌「創意+9.84%，因為ASIC設計受惠AI」
2. **大量解釋** - ❌「華邦電失敗原因：記憶體復甦緩慢...」（簡單說「失敗」即可）
3. **追高建議** - ❌「創意可追1,650元」（盤前沒預測）

---

## 盤前時事分析

### 時事權重：40%
時事影響市場預期，必須納入分析

### 必查來源
**國際面**：
- 美股表現（那斯達克、費半指數）
- 重大數據（CPI、非農、Fed決議）
- 地緣政治（美中科技戰、台海局勢）

**產業面**：
- 法說會/財報（台積電、聯發科、鴻海）
- 產業新聞（AI訂單、記憶體價格、設備出貨）
- 客戶動態（蘋果、輝達、特斯拉）

### 分析原則
```
✅ 正確：費半+1.58%、輝達創高 → 利多台積電、聯發科 → 今日佈局這些標的
❌ 錯誤：只看法人數據、不看時事
❌ 錯誤：摘要新聞但沒給投資判斷
❌ 錯誤：看了時事但預測股票與時事無關
```

---

## 數據驗證與品質控制

| 類別 | 範例 | 標註 |
|------|------|------|
| ✅ **可驗證** | Yahoo Finance股價、證交所法人數據 | 註明來源時間 |
| ⚠️ **無法驗證** | 市場傳言、主觀觀察 | 明確標註警告 |
| ❌ **絕對禁止** | 編造法人數據、假冒官方來源 | 用戶質疑立即修正 |

---

## 參考文件

**核心規範**（必讀）：
- `CONVERSATION_START_CHECKLIST.md` - 每次對話開始檢查清單
- `CLAUDE.md` - 本文件（核心規範速查）

**詳細規範**（執行時參考）：
- `docs/ANALYSIS_STANDARDS_V2.md` - 完整分析規範（615行）
- `docs/archive/plans/PREDICTION_ACCURACY_TRACKING.md` - 預測追蹤記錄

**範本文件**：
- `templates/before_market_template.md` - 盤前分析範本
- `templates/intraday_template.md` - 盤中分析範本
- `templates/after_market_template.md` - 盤後分析範本

---

**最後更新**：2025-11-12
**版本**：v3.0（激進壓縮版）
**壓縮成果**：628行 → 398行（-37%）

