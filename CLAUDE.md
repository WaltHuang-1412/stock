# CLAUDE.md

台股智能分析系統開發指引

## 系統概述

基於真實法人數據的台股分析系統，提供多維度股票分析和個人持股管理。

## ⚠️ 重要警告：預測準確率極低（<10%）
**實測證明**：2025/10/01 預測12項只對1項，準確率8.3%
- 詳見 PREDICTION_ACCURACY_TRACKING.md 追蹤記錄
- 本系統不應用於預測，僅供數據整理參考

## 核心架構

### 📁 目錄結構
```
stock/
├── src/                          # 主程式目錄
│   ├── main.py                   # 股票查詢分析入口
│   ├── portfolio_analyzer.py     # 個人持股分析
│   ├── data_fetcher.py           # 數據獲取(證交所API + Yahoo Finance)
│   ├── analyzer.py               # 多維分析引擎(法人40% + 技術30% + 新聞20% + 基本面10%)
│   ├── query_parser.py           # 自然語言查詢解析
│   ├── utils.py                  # 工具函數
│   └── examples.py               # 使用範例腳本
├── check_institutional.py        # 單一股票法人查詢工具（不受TOP50限制）
├── portfolio/
│   └── my_holdings.yaml          # 個人持股配置
├── data/                         # 每日分析報告存放處
│   ├── YYYY-MM-DD/
│   │   ├── before_market_analysis.md    # 盤前分析
│   │   ├── intraday_analysis.md         # 盤中分析
│   │   └── after_market_analysis.md     # 盤後分析
├── config.yaml                   # 系統設定
├── requirements.txt              # 依賴套件
└── CLAUDE.md                     # 本文件
```

### 主要模組說明

#### 核心分析系統（src/）
- **main.py** - 股票查詢分析入口，支援自然語言查詢
- **portfolio_analyzer.py** - 個人持股分析，計算損益並提供離場建議
- **data_fetcher.py** - 數據獲取模組，串接證交所API和Yahoo Finance
- **analyzer.py** - 多維分析引擎，整合法人、技術、新聞、基本面分析
- **query_parser.py** - 查詢解析器，支援自然語言理解
- **utils.py** - 工具函數集合
- **examples.py** - 使用範例和測試腳本

#### 獨立工具
- **check_institutional.py** - 單一股票法人買賣超查詢工具
  - 解決只能看TOP50的限制
  - 可查詢任何股票的法人數據
  - 直接查證交所API，買賣超都能看

#### 設定與數據
- **portfolio/my_holdings.yaml** - 個人持股配置檔案
- **config.yaml** - 系統設定（分析權重、數據來源等）
- **data/** - 每日分析報告自動存放目錄

### 基本使用
```bash
# 安裝依賴
pip install -r requirements.txt

# 股票分析（需加 src/ 路徑）
python3 src/main.py -q "台積電法人分析"

# 持股分析
python3 src/portfolio_analyzer.py

# 查詢單一股票法人數據（新工具）
python3 check_institutional.py 2208 20251001
```

## 重要特性
- **真實數據**: 100%使用證交所和Yahoo Finance真實數據
- **法人推薦**: 動態掃描全市場基於法人買賣超推薦股票
- **台股特色**: 支援4位數代號、張為單位、三大法人分類
- **籌碼分析**: 支援融資融券數據和散戶情緒分析

## 開發流程規範

### 代碼修改規則
1. **先列出要修改的文件** - 任何代碼修改前必須先列出具體文件清單
2. **等待審核批准** - 獲得明確同意後才能開始開發
3. **新系統架構需詢問** - 任何架構變更都需要事先討論
4. **禁止擅自行動** - 不得直接修改文件、創建新文件或改變架構

## 分析與回答規範

### 核心要求
| 類別 | 必須做 | 絕對禁止 |
|------|--------|---------|
| **數據** | 只用Yahoo Finance/證交所等可驗證來源 | ❌編造法人數據、假冒官方來源 |
| **客觀性** | 平衡分析正反面、承認不確定性 | ❌一面倒推薦、情緒化用詞 |
| **時間** | 明確標註數據時間與延遲 | ❌質疑系統時間 |
| **策略** | 平衡風險與機會、擁抱動能 | ❌過度保守、忽視上漲趨勢 |
| **架構** | 在現有框架內增強功能 | ❌擅自整合雙系統 |
| **法人查詢** | **立即全市場掃描TOP15買賣超** | ❌只看持股、❌只看熟悉股票、❌主觀選股 |

### 🔍 法人數據查詢標準流程（強制執行）

**當用戶詢問「法人數據」「今天法人」「法人動向」等關鍵字時**：

#### ✅ 必須立即執行（第一步）
```python
# 查詢證交所API，取得全市場法人買賣超
url = 'https://www.twse.com.tw/rwd/en/fund/T86?date=YYYYMMDD&selectType=ALL&response=json'
# 排序後輸出：
1. 買超 TOP 15（依三大法人合計排序）
2. 賣超 TOP 15（依三大法人合計排序）
```

#### ❌ 絕對禁止（第一步就犯錯）
- ❌ 只查持股中的5-10檔
- ❌ 只查台積電、鴻海等熟悉股票
- ❌ 主觀認為「這些比較重要」就只查這些
- ❌ 用戶問了很多次才補充全市場數據

#### 📊 輸出格式要求
```
📈 買超TOP15：代號、名稱、三大法人、投信、自營商、外資（推算）
📉 賣超TOP15：代號、名稱、三大法人、投信、自營商、外資（推算）

接著分析：
- 哪些「跌但法人買」（機會）
- 哪些「漲但法人賣」（陷阱）
- 產業輪動方向
```

#### 🎯 2025/10/13 實戰案例
- ❌ 錯誤：只給台積電、鴻海、台船、聯發科、富邦金
- ✅ 正確：全市場掃描後發現「聯電+16,866張」才是法人買超第一名
- 💡 教訓：客觀數據 > 主觀判斷

## 數據時效與關鍵教訓

### 時效性提醒
- **法人數據**：每日14:30-15:00公布，盤中無法取得
- **Yahoo Finance**：盤中延遲15-20分鐘
- **盤中分析**：量比>3倍、>500萬大單為有效指標

### 🚨 歷史教訓（必看）
- **過度保守災難**（2025/10/01）：推薦股1.10% vs 警告股5.79%
- **全市場掃描**（2025/10/08）：法人10/07買超→10/08全漲（100%準確）
- **主觀選股災難**（2025/10/13）：用戶要求客觀法人數據，我卻只給台積電、鴻海等5檔熟悉股票，遺漏真正法人買超第一名「聯電+16,866張」
- **核心結論**：動能比安全重要、跟緊法人、視野要全面、**絕不主觀選股**

## 三階段分析標準（盤前→盤中→盤後）

### 時間軸與數據流
```
09:00前  盤前分析 → 基於前日法人，預測6-10檔
11:00    盤中分析 → 驗證盤前預測，全市場掃描
14:30後  盤後分析 → 完整驗證+全市場深度分析
         └─ 更新PREDICTION_ACCURACY_TRACKING.md
```

### 統一規範（適用三階段）

| 階段 | 必須執行 | 報告內容 | 禁止行為 |
|------|---------|---------|---------|
| **盤前** | 查前日法人TOP20買賣超<br>預測6-10檔並記錄<br>分析持股法人動向 | 昨日回顧<br>法人動向分析<br>今日研判<br>持股操作建議<br>預測記錄 | ❌只看持股<br>❌模糊預測<br>❌不查法人 |
| **盤中** | 驗證盤前預測準確率<br>掃描漲跌TOP10<br>追蹤爆量股(量比>3倍) | 盤前預測驗證<br>市場概況<br>強弱股分析<br>持股盤中表現<br>尾盤觀察重點 | ❌不驗證預測<br>❌忽視延遲<br>❌追高建議 |
| **盤後** | 全市場掃描TOP30<br>法人數據逐一查證<br>產業輪動分析<br>明日佈局策略 | 漲跌榜真相<br>資金流向追蹤<br>法人意圖解讀<br>明日策略<br>風險陷阱 | ❌只看預測股<br>❌列數字不解釋<br>❌忽視產業鏈 |

### 品質檢查清單（通用）
- [ ] 查詢法人數據並註明來源？
- [ ] 全市場掃描而非只看持股？
- [ ] 預測有依據且供驗證？
- [ ] 產業邏輯清晰解釋？
- [ ] 提出具體價格策略？
- [ ] 更新預測追蹤記錄？

### 檔案命名規範
```
data/YYYY-MM-DD/
├── before_market_analysis.md   # 盤前
├── intraday_analysis.md         # 盤中
├── after_market_analysis.md     # 盤後
└── market_deep_analysis.md      # 深度分析（重點）
```

## 數據驗證與品質控制

| 類別 | 範例 | 標註 |
|------|------|------|
| ✅ **可驗證** | Yahoo Finance股價、計算技術指標、公開新聞 | 註明來源時間 |
| ⚠️ **無法驗證** | 法人具體數字、市場傳言、主觀觀察 | 明確標註警告 |
| ❌ **絕對禁止** | 編造法人數據、假冒官方來源、虛構數字 | 用戶質疑立即修正 |