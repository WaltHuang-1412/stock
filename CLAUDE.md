# CLAUDE.md

台股智能分析系統開發指引

## 系統概述

基於真實法人數據的台股分析系統，提供多維度股票分析和個人持股管理。

## ⚠️ 重要警告：預測準確率極低（<10%）
**實測證明**：2025/10/01 預測12項只對1項，準確率8.3%
- 詳見 PREDICTION_ACCURACY_TRACKING.md 追蹤記錄
- 本系統不應用於預測，僅供數據整理參考

## 核心架構

### 📁 目錄結構
```
stock/
├── src/                          # 主程式目錄
│   ├── main.py                   # 股票查詢分析入口
│   ├── portfolio_analyzer.py     # 個人持股分析
│   ├── data_fetcher.py           # 數據獲取(證交所API + Yahoo Finance)
│   ├── analyzer.py               # 多維分析引擎(盤前:時事40%+法人40%+技術20% | 盤中:量能100%)
│   ├── query_parser.py           # 自然語言查詢解析
│   ├── utils.py                  # 工具函數
│   └── examples.py               # 使用範例腳本
├── check_institutional.py        # 單一股票法人查詢工具（不受TOP50限制）
├── portfolio/
│   └── my_holdings.yaml          # 個人持股配置
├── data/                         # 每日分析報告存放處
│   ├── YYYY-MM-DD/
│   │   ├── before_market_analysis.md    # 盤前分析
│   │   ├── intraday_analysis.md         # 盤中分析
│   │   └── after_market_analysis.md     # 盤後分析
├── config.yaml                   # 系統設定
├── requirements.txt              # 依賴套件
└── CLAUDE.md                     # 本文件
```

### 主要模組說明

#### 核心分析系統（src/）
- **main.py** - 股票查詢分析入口，支援自然語言查詢
- **portfolio_analyzer.py** - 個人持股分析，計算損益並提供離場建議
- **data_fetcher.py** - 數據獲取模組，串接證交所API和Yahoo Finance
- **analyzer.py** - 多維分析引擎（盤前：時事40%+法人40%+技術20% | 盤中：量能100%）
- **query_parser.py** - 查詢解析器，支援自然語言理解
- **utils.py** - 工具函數集合
- **examples.py** - 使用範例和測試腳本

#### 獨立工具
- **check_institutional.py** - 單一股票法人買賣超查詢工具
  - 解決只能看TOP50的限制
  - 可查詢任何股票的法人數據
  - 直接查證交所API，買賣超都能看

#### 設定與數據
- **portfolio/my_holdings.yaml** - 個人持股配置檔案
- **config.yaml** - 系統設定（分析權重、數據來源等）
- **data/** - 每日分析報告自動存放目錄

### 基本使用
```bash
# 安裝依賴
pip install -r requirements.txt

# 股票分析（需加 src/ 路徑）
python3 src/main.py -q "台積電法人分析"

# 持股分析
python3 src/portfolio_analyzer.py

# 查詢單一股票法人數據（新工具）
python3 check_institutional.py 2208 20251001
```

## 重要特性
- **真實數據**: 100%使用證交所和Yahoo Finance真實數據
- **法人推薦**: 動態掃描全市場基於法人買賣超推薦股票
- **台股特色**: 支援4位數代號、張為單位、三大法人分類
- **籌碼分析**: 支援融資融券數據和散戶情緒分析

## 開發流程規範

### 代碼修改規則
1. **先列出要修改的文件** - 任何代碼修改前必須先列出具體文件清單
2. **等待審核批准** - 獲得明確同意後才能開始開發
3. **新系統架構需詢問** - 任何架構變更都需要事先討論
4. **禁止擅自行動** - 不得直接修改文件、創建新文件或改變架構

## 分析與回答規範

### 核心要求
| 類別 | 必須做 | 絕對禁止 |
|------|--------|---------|
| **數據** | 只用Yahoo Finance/證交所等可驗證來源 | ❌編造法人數據、假冒官方來源 |
| **客觀性** | 平衡分析正反面、承認不確定性 | ❌一面倒推薦、情緒化用詞 |
| **時間** | 明確標註數據時間與延遲 | ❌質疑系統時間 |
| **策略** | 平衡風險與機會、擁抱動能 | ❌過度保守、忽視上漲趨勢 |
| **架構** | 在現有框架內增強功能 | ❌擅自整合雙系統 |
| **法人查詢** | **立即全市場掃描TOP15買賣超** | ❌只看持股、❌只看熟悉股票、❌主觀選股 |
| **預測推薦** | **找法人佈局但還沒漲的股票** | ❌推薦已漲20%股票、❌用已收盤數據當預測、❌追高推薦 |

### 🔍 法人數據查詢標準流程（強制執行）

**當用戶詢問「法人數據」「今天法人」「法人動向」等關鍵字時**：

#### ✅ 必須立即執行（第一步）
```python
# 查詢證交所API，取得全市場法人買賣超
url = 'https://www.twse.com.tw/rwd/en/fund/T86?date=YYYYMMDD&selectType=ALL&response=json'
# 排序後輸出：
1. 買超 TOP 15（依三大法人合計排序）
2. 賣超 TOP 15（依三大法人合計排序）
```

#### ❌ 絕對禁止（第一步就犯錯）
- ❌ 只查持股中的5-10檔
- ❌ 只查台積電、鴻海等熟悉股票
- ❌ 主觀認為「這些比較重要」就只查這些
- ❌ 用戶問了很多次才補充全市場數據

#### 📊 輸出格式要求
```
📈 買超TOP15：代號、名稱、三大法人、投信、自營商、外資（推算）
📉 賣超TOP15：代號、名稱、三大法人、投信、自營商、外資（推算）

接著分析：
- 哪些「跌但法人買」（機會）
- 哪些「漲但法人賣」（陷阱）
- 產業輪動方向
```

#### 🎯 2025/10/13 實戰案例
- ❌ 錯誤：只給台積電、鴻海、台船、聯發科、富邦金
- ✅ 正確：全市場掃描後發現「聯電+16,866張」才是法人買超第一名
- 💡 教訓：客觀數據 > 主觀判斷

---

### 📈 股票推薦規範（強制執行）

**當用戶詢問「哪些股票可以進場」「有什麼推薦」「本週買什麼」等關鍵字時**：

#### ✅ 可以推薦的股票

1. **法人剛開始佈局、但還沒大漲**
   - 條件：法人買超+10K以上、漲幅<5%
   - 範例：康舒法人買超+36K、鴻海法人買超+21K（2025/10/27數據）
   - 理由：提前卡位，避免追高

2. **有產業邏輯支撐、等回檔進場**
   - 條件：產業趨勢明確、短線過熱需修正
   - 範例：旺宏NAND Flash漲價、但已漲+20%→等回檔至35元
   - 理由：產業邏輯對，但價位不對

3. **長期核心資產**
   - 條件：產業龍頭、長期趨勢明確
   - 範例：台積電1460-1480元分批買（AI+車用晶片雙引擎）
   - 理由：長期持有，不受短期波動影響

#### ❌ 絕對禁止推薦的股票

1. **已經大漲的股票（追高陷阱）**
   - ❌ 錯誤：推薦已漲+20%的旺宏、+16%的華邦電
   - ❌ 錯誤：用當日收盤價當「預測」
   - 理由：讓用戶接最後一棒

2. **盤中已爆發的股票（事後諸葛）**
   - ❌ 錯誤：盤中說「創意+9.84%可追」但盤前沒預測
   - ❌ 錯誤：解釋「因為AI需求所以漲」（已經漲完了）
   - 理由：沒意義的分析

3. **只有法人買超、無產業邏輯**
   - ❌ 錯誤：金融股只有投信買超，無產業催化劑
   - 理由：法人對決風險高、缺乏持續動能

#### 📊 推薦格式範本

**正確範例**：
```markdown
## 本週進場建議（基於10/27法人數據）

### 優先推薦：康舒 (6282) ⭐⭐⭐⭐⭐
- **法人數據**：10/27買超+36,457K（外資+6,961K）
- **產業邏輯**：AI伺服器電源供應、輝達GB200需求
- **為什麼還沒漲**：知名度低、法人剛開始佈局
- **進場條件**：若10/28法人續買超→隔日進場
- **目標價**：+20-30%（3個月）
- **停損**：-8%
- **催化劑**：本週美股財報（微軟、Meta AI支出）
```

**錯誤範例**：
```markdown
❌ 旺宏推薦買進（現價36.45、已漲+20%）→ 追高陷阱
❌ 創意盤中+9.84%可追（盤前沒預測）→ 事後諸葛
❌ 台新新光金法人買超推薦（無產業邏輯）→ 法人對決風險
```

#### 🎯 核心原則

```
提前佈局 > 事後諸葛
法人剛買 > 已經大漲
產業邏輯 > 法人買超
等回檔 > 追高
```

#### 📅 推薦時機檢查表

- [ ] 是基於「尚未公布的數據」做預測？（✅ 正確）
- [ ] 還是用「已收盤數據」當預測？（❌ 錯誤）
- [ ] 股票是「還沒漲」的機會股？（✅ 正確）
- [ ] 還是「已經漲20%」的追高股？（❌ 錯誤）
- [ ] 有明確產業邏輯支撐？（✅ 正確）
- [ ] 只有法人買超、無產業邏輯？（❌ 錯誤）
- [ ] 給出明確進場條件、目標價、停損？（✅ 正確）
- [ ] 模糊推薦「可以關注」？（❌ 錯誤）

## 數據時效與關鍵教訓

### 時效性提醒
- **法人數據**：每日14:30-15:00公布，盤中無法取得
- **Yahoo Finance**：盤中延遲15-20分鐘
- **盤中分析**：量比>3倍、>500萬大單為有效指標

### 🚨 歷史教訓（必看）
- **過度保守災難**（2025/10/01）：推薦股1.10% vs 警告股5.79%
- **全市場掃描**（2025/10/08）：法人10/07買超→10/08全漲（100%準確）
- **主觀選股災難**（2025/10/13）：用戶要求客觀法人數據，我卻只給台積電、鴻海等5檔熟悉股票，遺漏真正法人買超第一名「聯電+16,866張」
- **事後諸葛災難**（2025/10/21）：盤中說「創意+9.84%、緯穎+6.31%」但盤前根本沒預測，預測的10檔有6檔失敗，卻花大量篇幅解釋沒預測的股票為什麼漲
  - 用戶反饋：「**爆漲的你從來沒預估成功，那你說個屁哦**」
  - 核心錯誤：事後諸葛、沒意義的分析
- **追高推薦災難**（2025/10/28）：推薦旺宏、華邦電等已經漲20%+16%的股票，讓用戶追高接最後一棒
  - 用戶反饋：「**你說的這幾隻都正在漲欸**」
  - 核心錯誤：用已收盤數據當「預測」、推薦已大漲股票
  - 正確做法：找「法人在買、但還沒漲」的股票（康舒、鴻海等）
- **核心結論**：動能比安全重要、跟緊法人、視野要全面、**絕不主觀選股**、**絕不事後諸葛**、**絕不追高推薦**

## 三階段分析標準（盤前→盤中→盤後）

### 🎯 核心理念：提前佈局，而非事後諸葛

**絕對禁止**：
- ❌ 盤中說「XX股票+9.84%」卻盤前沒預測到 → **事後諸葛，說個屁**
- ❌ 解釋「因為AI需求所以漲」→ **已經漲完了，沒意義**
- ❌ 預測失敗後大量解釋原因 → **錯了就是錯了，不要狡辯**

**必須做到**：
- ✅ 盤前：基於時事+法人，明確預測6-10檔+價位
- ✅ 盤中：看量能推測法人佈局，給尾盤策略
- ✅ 盤後：驗證成敗，基於今日法人給明日佈局

---

### 時間軸與數據流
```
09:00前  盤前分析 → 時事（40%）+ 法人（40%）+ 技術（20%）→ 佈局6-10檔
11:00    盤中分析 → 量能推測法人意圖 → 尾盤策略
14:30後  盤後分析 → 驗證成敗 + 全市場法人 + 明日佈局
         └─ 更新PREDICTION_ACCURACY_TRACKING.md
```

---

### 統一規範（適用三階段）

| 階段 | 分析權重 | 必須執行 | 報告內容 | 禁止行為 |
|------|----------|---------|---------|---------|
| **盤前** | 時事40%<br>法人40%<br>技術20% | 國際時事掃描<br>產業時事分析<br>前日法人TOP30<br>預測6-10檔+明確價位<br>持股法人動向 | 昨日回顧<br>國際時事解讀<br>產業時事分析<br>法人動向分析<br>今日佈局策略<br>持股操作建議 | ❌只看法人不看時事<br>❌模糊預測<br>❌沒給明確價位<br>❌預測超過10檔 |
| **盤中** | 量能100% | **只分析預測的6-10檔**<br>量能異常偵測<br>對照昨日法人數據<br>推測法人意圖<br>給出尾盤策略 | 盤前預測驗證<br>量能異常股分析<br>法人意圖推測<br>尾盤佈局策略<br>持股盤中表現 | ❌**事後諸葛**<br>❌分析沒預測的股票<br>❌解釋為什麼漲跌<br>❌追高建議 |
| **盤後** | 法人60%<br>驗證40% | 全市場法人TOP30<br>預測成敗驗證<br>產業輪動分析<br>明日佈局策略 | 預測驗證（成功率）<br>今日法人數據<br>產業資金流向<br>明日佈局策略<br>風險陷阱 | ❌只看預測股<br>❌失敗不檢討<br>❌忽視產業鏈 |

### 品質檢查清單（通用）
- [ ] 查詢法人數據並註明來源？
- [ ] 全市場掃描而非只看持股？
- [ ] 預測有依據且供驗證？
- [ ] 產業邏輯清晰解釋？
- [ ] 提出具體價格策略？
- [ ] 更新預測追蹤記錄？

---

### 🔥 盤中量能分析邏輯（核心重點）

**目的**：透過量能推測法人/外資佈局意圖，提前卡位尾盤

#### 量能異常定義
- **爆量**: 成交量 > 5日均量 3倍
- **大量**: 成交量 > 5日均量 2倍
- **縮量**: 成交量 < 5日均量 0.5倍

#### 量價關係矩陣（推測法人意圖）

| 量能 | 價格 | 昨日法人 | 推測 | 策略 |
|------|------|----------|------|------|
| **爆量** | **大漲** | 買超 | ✅ 法人續買，主升段 | 尾盤可追，隔日續強 |
| **爆量** | **大漲** | 賣超 | ⚠️ 散戶搶反彈 | 不追，等盤後法人數據 |
| **爆量** | **小漲/平** | 買超 | ✅ 法人吸貨中 | 尾盤可買，佈局機會 |
| **爆量** | **下跌** | 買超 | ⚠️ 法人接刀失敗 | 觀望，產業可能有問題 |
| **爆量** | **下跌** | 賣超 | ❌ 法人出貨 | 避開，持有者停損 |
| **縮量** | **上漲** | 買超 | ⚠️ 量價背離 | 不追，假突破可能 |
| **縮量** | **下跌** | 賣超 | ❌ 法人棄守 | 避開，趨勢轉弱 |

#### 盤中分析標準流程

**Step 1: 只看預測的6-10檔**
```
例：盤前預測華邦電、鴻海、國巨、聯電、台積電、南亞科
→ 盤中只分析這6檔的量能
→ 絕對不要說「創意+9.84%」（因為盤前沒預測）
```

**Step 2: 量能異常偵測**
```
華邦電 (2344)
├── 成交量：46,741,529股（爆量5倍）
├── 價格：45.30元（-2.27%）
├── 昨日法人：買超569億
└── 推測：法人接刀失敗，記憶體產業仍弱勢
    → 策略：避開，觀望
```

**Step 3: 法人意圖推測**
```
國巨 (2327)
├── 成交量：88,883,766股（爆量6倍）
├── 價格：204.00元（+4.08%）
├── 昨日法人：買超62億，連3日買超253億
└── 推測：法人續買，主升段確立
    → 策略：尾盤回檔至202可追，目標210
```

**Step 4: 尾盤策略輸出**
```
✅ 可買：國巨（法人續買）、鴻海（AI動能）
⚠️ 觀察：華邦電（等盤後法人數據）
❌ 避開：聯電（量能不足）
```

#### 絕對禁止的盤中行為

1. **事後諸葛型**
   - ❌ 「創意+9.84%，因為ASIC設計受惠AI」
   - ❌ 「緯穎+6.31%，AI伺服器龍頭」
   - ✅ 正確：不提沒預測的股票

2. **大量解釋型**
   - ❌ 「華邦電預測失敗原因：記憶體產業復甦緩慢...」
   - ✅ 正確：「華邦電預測失敗，策略改為觀望」

3. **追高建議型**
   - ❌ 「創意可追價1,650~1,680元」（盤前沒預測）
   - ✅ 正確：只給預測股的尾盤策略

#### 盤中報告範例（正確版）

```markdown
## 盤中分析 (12:00)

### 預測驗證
- 成功：國巨+4.08%（預測看漲）✅
- 失敗：華邦電-2.27%（預測看漲）❌
- 成功率：1/6 = 16.7%

### 量能分析（預測股）

#### 國巨 (2327) - 法人續買
- 量能：爆量6倍
- 價格：+4.08%
- 推測：法人主升段
- 策略：尾盤回202可追

#### 華邦電 (2344) - 接刀失敗
- 量能：爆量5倍
- 價格：-2.27%
- 推測：記憶體仍弱
- 策略：避開觀望

### 尾盤策略
✅ 可買：國巨、鴻海
❌ 避開：華邦電、聯電
```

---

### 🌍 盤前時事分析來源（新增40%權重）

**目的**：時事影響市場預期，必須納入分析

#### 國際時事來源
1. **美股盤後表現**
   - 那斯達克、費城半導體指數
   - 輝達、AMD、台積電ADR等

2. **重大經濟數據**
   - 美國CPI、非農就業
   - Fed升降息決議
   - GDP成長率

3. **地緣政治**
   - 美中科技戰
   - 台海局勢
   - 國際貿易協議

#### 產業時事來源
1. **法說會/財報**
   - 台積電法說會
   - 聯發科、鴻海財報
   - 重要客戶展望

2. **產業新聞**
   - AI訂單動向
   - 記憶體價格走勢
   - 半導體設備出貨

3. **客戶動態**
   - 蘋果、輝達訂單
   - 特斯拉供應鏈
   - 微軟、Google AI投資

#### 時事分析範例

**正確範例**：
```markdown
## 昨日重大時事

### 國際面
- 費城半導體+1.58%，輝達創新高
- → 判斷：AI需求持續，利多台積電、聯發科

### 產業面
- 台積電法說會上調2025年營收成長至30%
- → 判斷：半導體供應鏈受惠，佈局日月光、欣興

### 結論
基於時事+法人數據，今日佈局：台積電、聯發科、日月光
```

**錯誤範例**：
```markdown
❌ 只看法人數據，不看時事
❌ 時事只是摘要新聞，沒給投資判斷
❌ 看了時事但預測股票與時事無關
```

---

### 檔案命名規範
```
data/YYYY-MM-DD/
├── before_market_analysis.md   # 盤前
├── intraday_analysis.md         # 盤中
├── after_market_analysis.md     # 盤後
└── market_deep_analysis.md      # 深度分析（重點）
```

## 數據驗證與品質控制

| 類別 | 範例 | 標註 |
|------|------|------|
| ✅ **可驗證** | Yahoo Finance股價、計算技術指標、公開新聞 | 註明來源時間 |
| ⚠️ **無法驗證** | 法人具體數字、市場傳言、主觀觀察 | 明確標註警告 |
| ❌ **絕對禁止** | 編造法人數據、假冒官方來源、虛構數字 | 用戶質疑立即修正 |