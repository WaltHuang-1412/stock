# CLAUDE.md

台股智能分析系統開發指引

## 系統概述

基於真實法人數據的台股分析系統，提供多維度股票分析和個人持股管理。

## 🚨 每次對話開始強制流程

### 0. 時間驗證（第一步，必須最先執行）⏰

**問題**：AI經常混淆日期和星期，導致分析時間錯亂

**強制執行命令**：
```bash
date "+%Y-%m-%d %A"  # 確認系統當前日期和星期
```

**輸出範例**：
```
2025-11-25 Tuesday
```

**檢查清單**：
- [ ] 執行 `date` 命令確認當前日期
- [ ] 確認當前星期幾
- [ ] 檢查最新分析文件日期（用 `ls -lt data/2025-11-*/` 確認）
- [ ] 確認今天是否為交易日（週一至週五）
- [ ] **絕對禁止**憑感覺或推算日期

**時間相關規則**：
1. ❌ 禁止說「今天是週X」而沒有執行 `date` 命令
2. ❌ 禁止推算星期（如「11/21是週四，11/25就是週一」）← **錯誤示範**
3. ✅ 必須用系統命令驗證時間
4. ✅ 分析報告標題必須標註星期（如「2025-11-25（週二）盤前分析」）

**範例**：
```
✅ 正確：
執行 `date` → 2025-11-25 Tuesday
「今天是2025-11-25（週二）」

❌ 錯誤：
「今天是2025-11-25（週一）」（沒有驗證）← 推算錯誤
「距離上次11/21是4天，所以是週一」（推算錯誤）← 11/21是週四，+4天=週一？錯！
```

---

### 1. 核心規則速查（每次對話必讀）

**時間驗證完成後，快速回顧以下核心規則**：

**必讀文件**：
- `docs/PREDICTION_ACCURACY_TRACKING.md` - 歷史預測記錄
- 昨日盤後分析 - 確認推薦股票表現

**核心規則提醒**：
- ✅ 盤中預測 → **隔日驗證**（不是當日收盤驗證）
- ❌ 絕不事後諸葛（盤前沒推薦的股票，盤中/盤後不能說「應該推薦」）
- ❌ 絕不追高推薦（近5日漲幅>10%不推薦）
- ✅ 全市場掃描 → 輸出TOP15（不是只看熟悉股票）

**歷史教訓速查**：
- 晟銘電案例：11/11收-0.36%→11/12收+5.82%（不能當日驗證）
- 買賣比>60%：散戶追價力道強，可搭配產業催化判斷

---

## ⚠️ 預測準確率追蹤

**歷史教訓**：2025/10/01 準確率8.3%（12項僅對1項）
**最新成果**：2025/11/11 準確率70%（7/10）
**關鍵改善**：盤中預測改用「隔日驗證」+ 買賣比指標

詳見：`docs/PREDICTION_ACCURACY_TRACKING.md`

---

## 核心架構

### 📁 目錄結構
```
stock/
├── src/                          # 主程式目錄
│   ├── main.py                   # 股票查詢分析入口
│   ├── portfolio_analyzer.py     # 個人持股分析
│   ├── data_fetcher.py           # 數據獲取(證交所API + Yahoo Finance)
│   ├── analyzer.py               # 多維分析引擎
│   └── utils.py                  # 工具函數
├── scripts/                      # 🆕 分析工具腳本
│   └── stock_tracker.py          # 🔥 個股追蹤系統（每日14:30執行）
├── check_institutional.py        # 單一股票法人查詢工具
├── intraday_scanner.py           # 🔥 盤中量能掃描器（12:30執行）
├── portfolio/my_holdings.yaml    # 個人持股配置
├── data/
│   ├── YYYY-MM-DD/               # 每日分析報告
│   │   ├── before_market_analysis.md
│   │   ├── intraday_analysis.md
│   │   └── after_market_analysis.md
│   ├── tracking/                 # 🆕 個股追蹤數據
│   │   ├── tracking_YYYY-MM-DD.json
│   │   └── reports/              # 7日追蹤報告
│   ├── weekly/                   # 🆕 週報
│   ├── monthly/                  # 🆕 月報
│   └── backtest/                 # 🆕 策略回測（規劃中）
├── templates/                    # 🆕 分析範本
│   └── weekly_report_template.md
└── docs/                         # 規範文件
    ├── CONVERSATION_START_CHECKLIST.md
    ├── MARKET_NEWS_CHECKLIST.md
    ├── ANALYSIS_STANDARDS_V2.md
    ├── ENHANCED_ANALYSIS_SYSTEM_PLAN.md  # 🆕 強化系統規劃
    ├── ENHANCED_SYSTEM_USAGE.md          # 🆕 使用指南
    └── archive/plans/PREDICTION_ACCURACY_TRACKING.md
```

### 核心工具

**check_institutional.py** - 法人數據查詢
- 解決只能看TOP50限制
- 可查詢任何股票法人數據
- 用法：`python3 check_institutional.py 2330 20251111`

**intraday_scanner.py** - 盤中量能掃描器（舊版，保留備用）
- 執行時機：12:30（最佳）
- 核心邏輯：找「法人正在佈局、但還沒大漲」的機會股
- 篩選條件：爆量(3x) + 小漲(<3%) + 昨日法人買超
- 用法：`python3 intraday_scanner.py`
- ⚠️ 限制：使用一票否決制、無五維度評分

**intraday_analyzer_v2.py** - 盤中五維度分析工具 🆕 **推薦使用**
- 執行時機：12:30（最佳）
- 核心邏輯：讀取盤前推薦記錄→五維度評分→給出尾盤策略
- **防止事後諸葛**：只分析tracking.json中的股票
- 用法：`python3 intraday_analyzer_v2.py`
- 優勢：五維度評分、明確倉位、防止追高

詳細使用指南：本文件「盤中量能分析工具」章節

**stock_tracker.py** - 個股追蹤系統 🆕
- 執行時機：每日盤後14:30後
- 核心邏輯：追蹤推薦股票7日表現，驗證準確率
- 功能：自動更新價格+法人數據、產生7日追蹤報告
- 用法：`python3 scripts/stock_tracker.py`

詳細使用指南：`docs/ENHANCED_SYSTEM_USAGE.md`

---

## 🆕 強化分析系統（2025-11-20新增）

### 系統概述

**問題診斷**：
- ❌ 盤前盤中盤後不夠、缺少週期性總結
- ❌ 推薦股票後沒追蹤、不知道是否成功
- ❌ 無法驗證策略有效性、憑感覺選股

**解決方案（B+C+E組合）**：
```
1️⃣ 週報/月報系統
   - 每週五產出週報
   - 統計本週推薦績效、法人動向
   - 產業輪動分析、下週展望

2️⃣ 個股追蹤系統 ⭐ (已上線)
   - 推薦後自動追蹤7日
   - 每日更新價格+法人數據
   - 7日後產生追蹤報告、驗證準確率

3️⃣ 策略回測系統 (規劃中)
   - 驗證「法人一致買超」等策略有效性
   - 量化準確率、持續改進
   - 累積30日數據後啟用
```

---

### 個股追蹤系統使用流程

**Step 1: 盤前推薦時建立追蹤記錄**
```json
// data/tracking/tracking_2025-11-20.json
{
  "recommendations": [
    {
      "stock_code": "1303",
      "stock_name": "南亞",
      "recommend_price": 52.5,
      "target_price": 58.0,
      "stop_loss": 48.3,
      "tracking_days": 7,
      "status": "tracking"
    }
  ]
}
```

**Step 2: 每日盤後自動更新**
```bash
# 執行追蹤更新（14:30後）
python3 scripts/stock_tracker.py

# 輸出範例：
✅ 南亞(1303): 56.2元 (+7.05%) - 📈 法人買超+3,421張 追蹤中 (2/7日)
```

**Step 3: 7日後產生追蹤報告**
- 報告位置：`data/tracking/reports/2025-11-20_1303_7day_report.md`
- 包含：最終漲跌幅、法人7日累計、成功/失敗分析
- 用途：驗證推薦準確率

**Step 4: 整合至盤後分析**
```markdown
## 九、追蹤中股票更新

| 股票 | 推薦日 | 推薦價 | 現價 | 漲跌% | 天數 | 狀態 |
|------|--------|--------|------|-------|------|------|
| 南亞 | 11/20 | 52.5 | 56.2 | +7.0% | 2/7 | ✅追蹤中 |
```

---

### 週報系統使用流程

**時間**：每週五15:00後

**範本**：`templates/weekly_report_template.md`

**核心內容**：
1. 本週市場總結（20%）
2. 本週法人動向（30%）- 投信/外資策略、一致買超
3. **本週推薦股票績效（30%）** - 成功/失敗案例、準確率
4. 產業輪動分析（10%）
5. 下週展望（10%）

**輸出位置**：`data/weekly/YYYY-MM-DD_weekly_report.md`

---

### 每日工作流程（整合後）

**09:00前 - 盤前分析**：
1. 執行市場時事檢查
2. 查詢法人數據、美股表現
3. 撰寫盤前分析
4. 🆕 **推薦股票時建立追蹤記錄**

**12:30 - 盤中分析**：
1. 執行 intraday_scanner.py
2. 分析盤前預測股票
3. 給出尾盤策略

**14:30後 - 盤後分析**：
1. 查詢今日法人數據
2. 🆕 **執行 stock_tracker.py 更新追蹤**
3. 撰寫盤後分析
4. 🆕 **新增「追蹤中股票更新」章節**

**週五15:00後 - 週報**：
1. 🆕 **統計本週推薦績效**
2. 🆕 **法人動向總結、產業輪動**
3. 🆕 **下週展望**

---

### 詳細文件

**完整規劃**：`docs/ENHANCED_ANALYSIS_SYSTEM_PLAN.md`（規劃文件、系統架構）
**使用指南**：`docs/ENHANCED_SYSTEM_USAGE.md`（執行步驟、故障排除）

---

## 開發流程規範

### 代碼修改規則
1. **先列出要修改的文件** - 任何代碼修改前必須先列出具體文件清單
2. **等待審核批准** - 獲得明確同意後才能開始開發
3. **新系統架構需詢問** - 任何架構變更都需要事先討論
4. **禁止擅自行動** - 不得直接修改文件、創建新文件或改變架構

---

## 🚨 分析前強制驗證流程（2025/11/18新增）

**血淚教訓**：2025/11/18盤前分析使用錯誤數據（11/14 vs 11/17），浪費用戶時間

### 強制執行規則

**任何盤前/盤中/盤後分析，必須先完成以下步驟，等用戶批准後才能開始撰寫**：

#### Step 1: 列出數據來源（必須）

```
我即將執行【盤前/盤中/盤後】分析：

📊 數據來源：
- 法人數據：20XX/XX/XX（證交所API）
- 美股數據：20XX/XX/XX（Yahoo Finance / 新聞）
- 台股即時：20XX/XX/XX HH:MM（Yahoo Finance）

❓ 數據確認：這是最新可用數據嗎？
```

#### Step 2: 列出分析範圍（必須）

```
📋 分析範圍：
✅ 推薦股票：X檔（股票A、股票B、股票C）
❌ 避開股票：X檔（原因：法人分歧/已大漲/投信賣超）
⚠️ 持股操作：停損X檔、續抱X檔

推薦理由簡述：
- 股票A：投信+外資一致買超、塑化龍頭
- 股票B：投信買超>10,000K、產業邏輯明確
```

#### Step 3: 等待用戶批准（必須）

```
✋ 等待批准：
請確認以上數據來源和分析範圍，我再開始撰寫完整報告。

若有問題請告知，我會立即修正。
```

### 範例：正確流程

```
用戶：「盤前分析」

我：「我即將執行盤前分析：

📊 數據來源：
- 法人數據：2025/11/18（證交所API）
- 美股數據：2025/11/17收盤（Yahoo Finance）
- 台股即時：2025/11/18 08:30（預估開盤）

📋 分析範圍：
✅ 推薦1檔：南亞(1303) - 投信+外資一致買超+18,075K
❌ 避開4檔：富邦金、旺宏、國巨、彰銀（法人激烈對決）
⚠️ 持股操作：停損玉山金、兆豐金（投信賣超）

✋ 請確認以上數據和範圍，我再開始撰寫完整報告。」

用戶：「OK」或「等等，11/18數據已經公布了嗎？」

我：（確認後）「開始撰寫盤前分析...」
```

### 禁止行為

❌ **絕對禁止**直接開始撰寫分析報告
❌ **絕對禁止**先寫完再讓用戶檢查
❌ **絕對禁止**假設用戶會接受任何數據來源

### 檢查清單

執行任何分析前，必須確認：

- [ ] 已列出所有數據來源日期
- [ ] 已確認是最新可用數據
- [ ] 已列出推薦股票及理由
- [ ] 已列出避開股票及理由
- [ ] 已等待用戶明確批准（收到「OK」或「開始」）
- [ ] 所有推薦股票都有check_institutional.py驗證數據

### 違規後果

**若未遵守此流程**：
- 用戶有權要求立即停止
- 必須重新執行驗證流程
- 記錄至PREDICTION_ACCURACY_TRACKING.md作為失誤案例

---

## 🚨 防止事後諸葛強制規範（2025-11-21新增）

### 血淚教訓

**2025/11/20 事後諸葛災難**：
- 盤前說「無股可推薦」→ 台股大漲+3.18%
- 盤後說「如果用新系統，應該推薦永豐金88分」← 事後諸葛
- 用戶質疑：「為什麼漲了才開始叫我買？這也太奇怪了吧」
- **根本原因**：沒有強制流程防止「盤前不推薦、盤後才說應該推薦」

---

### 一、盤前分析強制規範

#### ❌ 絕對禁止

**1. 禁止說「無股可推薦」「今日無推薦」**
```markdown
❌ 絕對禁止：
「今日無股票可推薦」
「法人對決嚴重，建議觀望」
「市場不明朗，等待時機」

理由：
- 即使法人對決、時事不明朗，也必須推薦3-5檔股票
- 評分低的股票標註風險即可
- 讓用戶自己決定是否進場
```

**2. 禁止使用舊系統一票否決**
```markdown
❌ 絕對禁止：
因「法人對決」就不推薦
因「外資0張」就不推薦
因「投信<10K」就不推薦

✅ 必須執行：
用五維度評分
綜合評估後給出推薦等級
```

**3. 禁止模糊推薦**
```markdown
❌ 絕對禁止：
「等回檔再說」（什麼價位？）
「觀望為主」（那要推薦什麼？）
「開盤進場」（什麼價位？倉位多少？）

✅ 必須執行：
每檔股票明確給出：進場價、倉位%、停損、目標
```

---

#### ✅ 強制執行規則

**推薦數量（必須）**：
```
最少推薦：3檔
最多推薦：8檔

評分分布建議：
⭐⭐⭐⭐⭐ (≥85分): 1-2檔
⭐⭐⭐⭐ (75-84分): 2-3檔
⭐⭐⭐ (65-74分): 1-3檔
```

**如果真的沒有好股票怎麼辦？**
```markdown
✅ 正確做法：
1. 推薦3檔評分65-74分的股票
2. 標註「⭐⭐⭐ 可考慮小倉位5-10%、風險較高」
3. 明確說明風險：
   - 法人對決（投信+8M vs 外資-12M）
   - 產業邏輯較弱（年底作帳但外資不認同）
   - 建議小倉位試單

❌ 錯誤做法：
說「今日無股可推薦」
```

**追蹤機制（強制建立）**：
```python
# 盤前分析完成後，必須執行：
建立 data/tracking/tracking_YYYY-MM-DD.json

內容範例：
{
  "date": "2025-11-21",
  "recommendations": [
    {
      "stock_code": "2890",
      "stock_name": "永豐金",
      "recommend_price": 27.0,
      "target_price": 30.0,
      "stop_loss": 24.8,
      "position": "15-20%",
      "rating": "⭐⭐⭐⭐⭐",
      "score": 88,
      "reason": "投信+9.3M、年底作帳行情"
    }
  ]
}
```

---

### 二、盤中分析強制規範

#### ✅ 必須執行

**1. 讀取盤前追蹤記錄（第一步）**
```python
# 盤中分析開始前，必須執行：
tracking_file = f'data/tracking/tracking_{today}.json'
if not exists(tracking_file):
    print("⚠️ 警告：今日盤前分析未建立追蹤記錄")
    print("無法執行盤中分析（防止事後諸葛）")
    exit()

tracking = read_json(tracking_file)
recommended_stocks = [r['stock_code'] for r in tracking['recommendations']]
```

**2. 只分析盤前推薦股（強制限制）**
```markdown
✅ 正確：
盤前推薦：永豐金、元大金、國巨
盤中分析：
- 永豐金盤中+1.5%，量比2.0x → ✅可尾盤進場
- 元大金盤中+2.3%，量比1.6x → ✅可尾盤進場
- 國巨盤中+1.7%，量比1.2x → ⚠️量能不足

❌ 絕對禁止：
盤前沒推薦創意
盤中說「創意+9.84%，因為ASIC設計受惠AI」← 事後諸葛
盤中說「欣興+6.85%，ABF載板需求強勁」← 事後諸葛
```

**3. 給出尾盤策略（明確行動）**
```markdown
✅ 可尾盤進場（12:30-13:30）：
1. 永豐金：26.6-27.0元進場10-15%
2. 元大金：35.0-35.5元進場10-15%

⚠️ 已追高，不建議：
- 台積電：盤中+3.0%（已漲太多）
- 欣興：盤中+4.8%（已大漲）

❌ 避開：
- 華邦電：盤中-1.6%，法人對決風險
```

---

#### ❌ 絕對禁止

**禁止事後諸葛（任何形式）**：
```markdown
❌ 禁止案例1：
「創意今日大漲+9.84%，因為ASIC設計受惠AI」
→ 盤前沒推薦，盤中說漲 = 事後諸葛

❌ 禁止案例2：
「欣興爆量+6.85%，投信態度轉向」
→ 盤前沒推薦，盤中說爆量 = 事後諸葛

❌ 禁止案例3：
「如果盤前推薦欣興，現在可獲利+6.85%」
→ 事後假設 = 事後諸葛

✅ 正確做法：
只分析盤前推薦的6-8檔股票
完全不提盤前沒推薦的股票
```

---

### 三、盤後分析強制規範

#### ✅ 結構規範（必須遵守）

**必須明確分為兩部分**：
```markdown
## 一、今日驗證（20%）⚠️ 僅供檢討，不是建議

【明確標註此部分不是投資建議】

**盤前預測回顧**：
- ⭐⭐⭐⭐⭐ 永豐金27.0元
- ⭐⭐⭐⭐ 元大金35.0元
- ⭐⭐⭐ 國巨227元

**實際結果**：
- 永豐金：27.05元（+2.27%）✅ 成功
- 元大金：36.05元（+3.30%）✅ 成功
- 國巨：230.5元（+2.44%）✅ 成功

**準確率**：3/3 = 100%

⚠️ 以上僅供檢討學習，不是投資建議
⚠️ 不代表未來績效

---

## 二、明日預測（80%）✅ 可執行建議

【明確標註這是明日11/22的建議】

### ⭐⭐⭐⭐⭐ 強力推薦（85分以上）

1. 股票A(代號) - 總分：88分
   （完整五維度評分+進場策略）
```

---

#### ❌ 絕對禁止

**1. 禁止在檢討部分寫「應該推薦」**
```markdown
❌ 絕對禁止：
「盤前如果用新系統，應該推薦永豐金88分」
「如果推薦永豐金，可獲利+2.27%」
「盤前評估失誤，永豐金其實是好標的」

✅ 正確做法：
「盤前預測：永豐金27.0元 → 實際：27.05元（+2.27%）✅ 成功」
「準確率：3/3 = 100%」
```

**2. 禁止檢討和預測混在一起**
```markdown
❌ 絕對禁止：
在「今日驗證」章節寫明日推薦
在「明日預測」章節寫今日檢討

✅ 正確做法：
今日驗證（20%）：只寫成功/失敗、準確率
明日預測（80%）：只寫明日推薦股票
```

**3. 禁止模糊時間**
```markdown
❌ 絕對禁止：
「永豐金值得關注」（什麼時候？今天還是明天？）
「可考慮進場」（現在還是明天開盤？）

✅ 正確做法：
明確標註「明日11/22開盤27.0-27.5元進場」
```

---

### 四、追蹤機制強制規範

#### tracking.json 必須包含

```json
{
  "date": "2025-11-21",
  "market_context": {
    "us_market": "NASDAQ +0.8%",
    "major_news": ["輝達財報超預期", "台積電法說會"]
  },
  "recommendations": [
    {
      "stock_code": "2890",
      "stock_name": "永豐金",
      "recommend_price": 27.0,
      "current_price": 26.45,
      "target_price": 30.0,
      "stop_loss": 24.8,
      "position": "15-20%",
      "rating": "⭐⭐⭐⭐⭐",
      "score": 88,
      "五維度": {
        "法人數據": 27,
        "時事現況": 27,
        "產業邏輯": 14,
        "價格位置": 12,
        "技術面": 8
      },
      "reason": "投信+9.3M、年底作帳行情剛啟動",
      "status": "pending"
    }
  ],
  "avoid_stocks": [
    {
      "stock_code": "2344",
      "stock_name": "華邦電",
      "reason": "法人對決、記憶體產業弱",
      "score": 42
    }
  ]
}
```

---

### 五、違規後果

**如果違反以上規範**：

1. **用戶有權質疑**
   - 立即停止分析
   - 承認錯誤

2. **必須記錄**
   - 寫入 `docs/archive/plans/PREDICTION_ACCURACY_TRACKING.md`
   - 標註為「失誤案例」
   - 分析失誤原因

3. **檢討改進**
   - 為什麼會違規？
   - 如何防止再犯？
   - 更新規範文件

---

### 六、檢查清單（每次分析前必查）

**盤前分析**：
- [ ] 推薦至少3檔股票？
- [ ] 每檔都有五維度評分？
- [ ] 每檔都有明確價位+倉位+停損+目標？
- [ ] 建立了tracking.json？

**盤中分析**：
- [ ] 讀取了tracking.json？
- [ ] 只分析tracking中的股票？
- [ ] 沒有提到tracking外的股票？
- [ ] 給出了尾盤策略？

**盤後分析**：
- [ ] 明確分為「今日驗證（20%）」vs「明日預測（80%）」？
- [ ] 檢討部分只寫成功/失敗？
- [ ] 預測部分推薦至少3檔？
- [ ] 每檔都建立tracking.json？

---

## 🎯 雙軌評分系統（2025-11-27新增）

### 為什麼改用雙軌？

**舊問題（五維度混在一起）**：
```
時事好 + 法人買 → 88分 → 推薦
時事好 + 法人賣 → 65分 → 不推薦
時事差 + 法人買 → 70分 → 模糊

問題：時事和法人互相稀釋，看不出真正的驅動因素
```

**新方法（雙軌分開）**：
```
📰 時事軌（50分）          🏦 法人軌（50分）
├─ 國際面 (20分)           ├─ 投信 (20分)
├─ 產業催化 (20分)         ├─ 外資 (20分)
└─ 價格位置 (10分)         └─ 一致性 (10分)

兩條線分開評估 → 更清楚知道為什麼推薦
```

---

### 雙軌評分架構

```
┌──────────────────────────────────────────────────────────┐
│                    股票分析                              │
├────────────────────────┬─────────────────────────────────┤
│   📰 時事軌（50分）    │    🏦 法人軌（50分）            │
├────────────────────────┼─────────────────────────────────┤
│ • 國際面 (20分)        │ • 投信 (20分)                   │
│   - 美股/費半/輝達     │   - 買賣超張數                  │
│                        │   - 連續天數                    │
│ • 產業催化 (20分)      │                                 │
│   - 新聞/法說/訂單     │ • 外資 (20分)                   │
│                        │   - 買賣超張數                  │
│ • 價格位置 (10分)      │   - 連續天數                    │
│   - 是否追高           │                                 │
│                        │ • 一致性 (10分)                 │
│                        │   - 投信+外資同向加分           │
└────────────────────────┴─────────────────────────────────┘
```

---

### 📰 時事軌評分細則（50分）

**國際面（20分）**
| 條件 | 分數 |
|------|------|
| 費半 ≥+2% | 18-20 |
| 費半 +1~2% | 14-17 |
| 費半 0~1% | 10-13 |
| 費半 負 | 5-9 |
| 輝達大漲加分 | +2 |

**產業催化（20分）**
| 條件 | 分數 |
|------|------|
| 重大利多（法說、訂單、漲價） | 16-20 |
| 一般利多（產業趨勢） | 11-15 |
| 無明顯催化 | 6-10 |
| 利空 | 0-5 |

**價格位置（10分）**
| 條件 | 分數 |
|------|------|
| 近5日 <3% | 8-10 |
| 近5日 3-7% | 5-7 |
| 近5日 >7% | 0-4 |

---

### 🏦 法人軌評分細則（50分）

**投信（20分）**
| 條件 | 分數 |
|------|------|
| 買超 >10K 且連續≥3日 | 18-20 |
| 買超 >10K | 14-17 |
| 買超 5K-10K | 10-13 |
| 買超 <5K | 6-9 |
| 賣超 | 0-5 |

**外資（20分）**
| 條件 | 分數 |
|------|------|
| 買超 >10K 且連續≥3日 | 18-20 |
| 買超 >10K | 14-17 |
| 買超 5K-10K | 10-13 |
| 買超 <5K 或 0 | 6-9 |
| 賣超 | 0-5 |

**一致性（10分）**
| 條件 | 分數 |
|------|------|
| 投信+外資同買超 | 10 |
| 只有一方買超 | 5 |
| 激烈對決（一買一賣>10K） | 2 |
| 都賣超 | 0 |

---

### 判讀矩陣

```
┌──────────────────────────────────────────────────────────┐
│                    判讀矩陣                              │
├────────────────┬────────────────┬────────────────────────┤
│                │ 法人強 (≥35)   │ 法人弱 (<35)           │
├────────────────┼────────────────┼────────────────────────┤
│ 時事強 (≥35)  │ 🔥 雙強        │ ⚡ 時事驅動            │
│                │ 最佳機會       │ 適合當沖/短線          │
├────────────────┼────────────────┼────────────────────────┤
│ 時事弱 (<35)  │ 💰 法人驅動    │ ❌ 雙弱                │
│                │ 適合波段       │ 不推薦                 │
└────────────────┴────────────────┴────────────────────────┘
```

**類型說明**：
- 🔥 **雙強**：時事+法人都強 → 最佳機會，可重倉
- ⚡ **時事驅動**：產業催化強但法人弱 → 適合當沖/短線
- 💰 **法人驅動**：法人買超強但時事弱 → 適合波段1-3月
- ❌ **雙弱**：都弱 → 不推薦
- ⚠️ **對決型**：法人軌一致性<5分 → 風險高，小倉位

---

### 推薦輸出格式（新）

```markdown
### 永豐金(2890)

📰 時事軌：32/50
├─ 國際面：12/20（費半+2.76%）
├─ 產業催化：12/20（年底作帳，無特別催化）
└─ 價格位置：8/10（近5日+2%，未追高）

🏦 法人軌：45/50
├─ 投信：18/20（+7,475張，連續買超）
├─ 外資：17/20（+10,601張）
└─ 一致性：10/10（投信+外資同買）

📊 判讀：💰 法人驅動型（時事32 + 法人45）
→ 適合：波段操作 1-3月
→ 進場：27.0元，倉位15%，停損26.0元
```

---

### 操作建議對照表

| 類型 | 時事軌 | 法人軌 | 適合操作 | 倉位 | 停損 |
|------|--------|--------|----------|------|------|
| 🔥 雙強 | ≥35 | ≥35 | 波段+短線 | 15-20% | -5% |
| ⚡ 時事驅動 | ≥35 | <35 | 當沖/短線 | 10-15% | -3% |
| 💰 法人驅動 | <35 | ≥35 | 波段1-3月 | 15-20% | -8% |
| ⚠️ 對決型 | - | 一致性<5 | 小倉位觀察 | 5-10% | -3% |
| ❌ 雙弱 | <35 | <35 | 不推薦 | 0% | - |

---

### 詳細使用指南

完整評分標準、實戰案例 → `docs/FIVE_DIMENSIONS_SCORING.md`

---

## 🔥 雙層推薦系統（2025-11-25新增）

### 為什麼需要雙層系統？

**用戶反饋（2025/11/25）**：
```
用戶：「欣興真的獲利也不是你推薦的，我還想問為什麼推薦的都沒什麼用」

實際數據：
- 我的推薦：永豐金+0.94%、彰銀+1.00%（穩健但漲幅小）
- 用戶自選：欣興+9.50%（短線爆發）

問題診斷：
我只推薦「穩健型」（法人主導、1-3月+10%）
用戶也想要「爆發型」（產業催化、1-3天+10%）
```

**解決方案**：雙層推薦系統 = 穩健型 + 爆發型

---

### 雙層系統核心差異

| 類型 | 範例 | 漲幅 | 時間週期 | 主要驅動 | 權重分配 |
|------|------|------|----------|----------|----------|
| **穩健型** | 永豐金、彰銀 | +1-3% | 1-3個月 | 法人持續買超 | 法人30%、時事30% |
| **爆發型** | 欣興 | +10%+ | 1-3天 | 產業催化+突然爆量 | 時事35%、產業30% |

---

### 穩健型評分系統（原系統、保持不變）

**權重配置**：
```
法人數據：30%  ← 最重要（投信大買超>10K）
時事現況：30%
產業邏輯：20%
價格位置：10%
技術面：10%
```

**推薦門檻**：
```
≥85分 → 強烈推薦15-20% ⭐⭐⭐⭐⭐
75-84分 → 推薦10-15% ⭐⭐⭐⭐
65-74分 → 可考慮5-10% ⭐⭐⭐
<65分 → 不推薦
```

**目標**：1-3個月+10-20%收益、法人主導、風險低

---

### 爆發型評分系統（v2.0新增）

**權重配置**：
```
時事現況：35%  ← 最重要（產業催化劑、突發利多）
產業邏輯：30%  ← 第二重要（爆發邏輯強度）
技術面：15%    ← 量能異動（盤中爆量）
法人數據：15%  ← 降低權重（散戶也能推動）
價格位置：5%   ← 爆發股不在乎已漲5%
```

**推薦門檻**（比穩健型更嚴格）：
```
≥80分 → 強烈推薦10-15% ⭐⭐⭐⭐⭐ （風險高、倉位降低）
70-79分 → 推薦5-10% ⭐⭐⭐⭐
60-69分 → 可考慮3-5% ⭐⭐⭐ （試單）
<60分 → 不推薦
```

**目標**：1-3天+10%+收益、產業驅動、風險高

**關鍵差異**：
- **時事現況**：從30% → 35%（重大產業催化劑最重要）
- **產業邏輯**：從20% → 30%（爆發邏輯強度、不可替代性）
- **技術面**：從10% → 15%（盤中爆量+買盤%判斷散戶追價力道）
- **法人數據**：從30% → 15%（爆發型可接受法人數據較弱）
- **價格位置**：從10% → 5%（爆發型可接受小追高）

---

### 推薦數量與倉位建議

**推薦數量**：
```
穩健型：2-4檔（主力配置）
爆發型：1-2檔（彈性配置）
總計：3-6檔
```

**倉位分配**：
```
穩健型總倉位：40-60%（2-4檔 × 10-20%）
爆發型總倉位：10-30%（1-2檔 × 10-15%）
現金保留：20-40%（安全墊）
```

**風險控制**：
```
穩健型：
- 停損：-8%（較寬鬆）
- 時間：等1-3個月
- 法人反轉賣超才停損

爆發型：
- 停損：-3至-5%（快速停損）
- 時間：1-3天達標就獲利了結
- 產業催化劑失效立即停損
```

---

### tracking.json 格式調整

**必須新增 "type" 欄位**：

```json
{
  "date": "2025-11-26",
  "recommendations": [
    {
      "type": "stable",       ← 新增：穩健型
      "stock_code": "2890",
      "stock_name": "永豐金",
      "score": 88,
      "五維度": {
        "法人數據": 27,
        "時事現況": 27,
        "產業邏輯": 14,
        "價格位置": 12,
        "技術面": 8
      },
      "time_horizon": "1-3個月",   ← 新增：時間週期
      "target_return": "+6-8%",   ← 新增：目標收益
      ...
    },
    {
      "type": "explosive",    ← 新增：爆發型
      "stock_code": "3037",
      "stock_name": "欣興",
      "score": 84,
      "五維度": {
        "時事現況": 31,
        "產業邏輯": 28,
        "技術面": 13,
        "法人數據": 9,
        "價格位置": 3
      },
      "time_horizon": "1-3天",    ← 新增：時間週期
      "target_return": "+10%+",  ← 新增：目標收益
      ...
    }
  ]
}
```

---

### 盤前分析輸出格式（新）

```markdown
## 三、股票推薦

### 🟢 穩健型推薦（法人主導、1-3月、目標+10-20%）

#### ⭐⭐⭐⭐⭐ 強烈推薦（≥85分）

**永豐金(2890)** - 總分：88分

**產業分類**：金融 → 綜合型
**驅動因素**：年底作帳、銀行+證券綜合

**五維度評分（穩健型權重）**：
- 📊 法人數據：27/30分
- 🌍 時事現況：27/30分
- 🏭 產業邏輯：14/20分
- 💰 價格位置：12/10分
- 📈 技術面：8/10分

**推薦策略**：
- 📍 進場價：26.8-27.2元
- 💰 倉位：15-20%
- 🛑 停損：26.0元（-3%）
- 🎯 目標：28.5-29.0元（1-3月，+6-8%）
- ⏰ 時間週期：1-3個月

---

### 🔴 爆發型推薦（產業催化、1-3天、目標+10%+）

#### ⭐⭐⭐⭐⭐ 強烈推薦（≥80分）

**欣興(3037)** - 總分：84分

**產業分類**：半導體 → 載板/PCB
**驅動因素**：ABF載板供需、AI伺服器、CoWoS擴產
**催化劑**：輝達Blackwell爆單+台積電CoWoS擴產

**五維度評分（爆發型權重）**：
- 🌍 時事現況：31/35分（輝達利多+ABF缺貨）
- 🏭 產業邏輯：28/30分（龍頭+爆發邏輯）
- 📈 技術面：13/15分（盤中爆量+買盤61.8%）
- 📊 法人數據：9/15分（投信+266張）
- 💰 價格位置：3/5分（盤中+5%）

**推薦策略**：
- 📍 進場價：168-172元
- 💰 倉位：10-15%（⚠️ 風險高）
- 🛑 停損：165元（-3%，快速停損）
- 🎯 目標：185元（1-3天，+10%）
- ⏰ 時間週期：1-3天（短線）

**⚠️ 風險提示**：
- 爆發型股票波動大、需快速停損
- 建議分批進場
- 達標立即獲利了結
```

---

### 詳細使用指南

完整評分標準、範例案例、實戰應用 → `docs/FIVE_DIMENSIONS_SCORING.md` v2.0

---

## 🏭 產業分類規範（2025-11-25新增）

### 為什麼需要？

不同產業有不同的驅動因素，同一大產業下的細分類型表現可能完全不同。
例如：金融股中的「壽險型」受股市/匯率影響，「證券型」受成交量影響，「純銀行」受利差影響。

### 產業分類表

#### 半導體產業
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 晶圓代工 | 台積電(2330)、聯電(2303) | AI需求、先進製程、客戶訂單 |
| IC設計 | 聯發科(2454)、瑞昱(2379) | 手機/PC出貨、新品週期 |
| 封測 | 日月光(3711) | 封裝需求、CoWoS產能 |
| 記憶體 | 南亞科(2408)、華邦電(2344) | DRAM/NAND價格、庫存週期 |
| 載板/PCB | 欣興(3037)、景碩(3189) | ABF載板供需、AI伺服器 |
| 設備 | 弘塑(3131)、辛耘(3583) | 資本支出、擴產週期 |

#### 電子產業
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 被動元件 | 國巨(2327)、華新科(2492) | 漲價週期、庫存回補 |
| 連接器 | 鴻海(2317)、正崴(2392) | 蘋果訂單、電動車 |
| 伺服器/AI | 廣達(2382)、緯創(3231) | AI伺服器出貨、雲端資本支出 |
| 散熱 | 雙鴻(3324)、超眾(6230) | AI散熱需求 |

#### 傳產
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 塑化 | 南亞(1303)、台塑(1301) | 油價、景氣循環、中國需求 |
| 鋼鐵 | 中鋼(2002) | 鋼價、基建需求 |
| 航運 | 長榮(2603)、陽明(2609) | 運價、塞港、旺季 |
| 水泥 | 台泥(1101)、亞泥(1102) | 基建、房市 |

#### 金融產業
| 細分類型 | 代表股票 | 驅動因素 |
|---------|---------|---------|
| 純銀行 | 彰銀(2801)、華南金(2880)、第一金(2892) | 利差、放款成長、央行政策 |
| 壽險型 | 國泰金(2882)、富邦金(2881)、新光金(2888) | 股市、匯率、利率、避險成本 |
| 證券型 | 元大金(2885)、凱基金(2883) | 成交量、ETF規模、自營績效 |
| 綜合型 | 中信金(2891)、玉山金(2884)、永豐金(2890) | 銀行+證券綜合、分散風險 |

### 分析時產業分類必填

**tracking.json 必須包含**：
```json
{
  "stock_code": "2801",
  "stock_name": "彰銀",
  "industry": {
    "sector": "金融",
    "sub_type": "純銀行",
    "drivers": ["利差", "放款成長", "央行政策"]
  },
  ...
}
```

**分析報告必須標註**：
```markdown
### 彰銀(2801) ⭐⭐⭐⭐⭐ 總分：87分

**產業分類**：金融 → 純銀行
**驅動因素**：利差改善、央行升息受惠
```

### 產業分類的分析價值

1. **理解驅動因素**：同樣是金融股，壽險型和證券型的驅動因素完全不同
2. **產業輪動**：判斷資金是否在同一產業內輪動（如從壽險轉向證券）
3. **風險分散**：推薦股票時考慮是否過度集中於同一細分產業
4. **時事關聯**：將時事新聞與對應產業連結（如央行升息→利多純銀行）

---

## 🌐 全面客觀分析原則（2025-11-28新增）

### 為什麼需要？

**問題診斷**：
- ❌ 盤前只推薦3-8檔 → 遺漏真正的機會
- ❌ 盤中「只能分析tracking中的股票」→ 視野被人為限制
- ❌ 盤後只驗證推薦股 → 無法看到市場全貌
- ❌ tracking.json 與實際推薦不一致 → 追蹤失效

**解決方案**：全市場掃描 + 客觀記錄

---

### 盤前分析：全市場法人掃描（強制）

**Step 1: 查詢全市場法人數據**
```bash
# 必須查詢前一日法人買賣超
curl "https://www.twse.com.tw/rwd/en/fund/T86?date=YYYYMMDD&selectType=ALL&response=json"
```

**Step 2: 輸出法人買超/賣超 TOP15（強制）**
```markdown
## 📈 法人買超 TOP15（YYYY-MM-DD）

| 排名 | 代號 | 名稱 | 三大法人 | 投信 | 外資 | 解讀 |
|------|------|------|---------|------|------|------|
| 1 | 2303 | 聯電 | +16,866 | +8,234 | +8,109 | 投信+外資一致 |
| 2 | ... | ... | ... | ... | ... | ... |
（完整15檔）

## 📉 法人賣超 TOP15（YYYY-MM-DD）

| 排名 | 代號 | 名稱 | 三大法人 | 投信 | 外資 | 解讀 |
|------|------|------|---------|------|------|------|
| 1 | 2317 | 鴻海 | -7,243 | -207 | -6,587 | 三大同賣 |
（完整15檔）
```

**Step 3: 從 TOP15 中評分推薦**
```
從買超TOP15中，用五維度評分選出推薦股
- 不是「先選股再查法人」
- 而是「先看法人再評分」
- 確保客觀、不遺漏
```

---

### 盤中分析：全市場異動掃描（新規範）

**舊規範問題**：
```
❌ 「只能分析tracking中的股票」
→ 如果盤前漏掉，盤中就完全看不到
→ 這不是客觀，是人為限制視野
```

**新規範**：
```markdown
## 盤中異動 TOP10

| 排名 | 代號 | 名稱 | 漲跌% | 量比 | 盤前推薦 | 備註 |
|------|------|------|-------|------|---------|------|
| 1 | 3037 | 欣興 | +5.06% | 2.5x | ✅ 是 | 可執行 |
| 2 | 2454 | 聯發科 | +3.20% | 1.8x | ❌ 否 | 僅記錄、不追高 |
| 3 | ... | ... | ... | ... | ... | ... |

**說明**：
- ✅ 盤前推薦：可執行尾盤策略
- ❌ 非盤前推薦：僅客觀記錄，不建議追高
```

**關鍵改變**：
- 不再「只看tracking中的股票」
- 改為「全市場掃描，但明確標註哪些是盤前推薦」
- 盤前沒推薦的：僅記錄、不建議追高（防止事後諸葛）
- 盤前有推薦的：可執行尾盤策略

---

### 盤後分析：全市場收盤記錄（強制）

**必須輸出**：
```markdown
## 📊 今日漲幅 TOP10

| 排名 | 代號 | 名稱 | 漲跌% | 盤前推薦 | 法人 | 備註 |
|------|------|------|-------|---------|------|------|
| 1 | 3037 | 欣興 | +9.50% | ✅ 是 | +16,304 | 推薦成功 |
| 2 | 2454 | 聯發科 | +4.20% | ❌ 否 | +8,234 | 未推薦 |
（完整10檔）

## 📈 法人買超 TOP15（今日）

（完整15檔，用於明日盤前分析）
```

**目的**：
1. 客觀記錄市場表現
2. 驗證推薦準確率
3. 找出明日機會（法人今日買超 → 明日可能續漲）

---

### tracking.json 同步規範

**問題**：tracking.json 內容與實際盤前推薦不一致

**強制規範**：
```
盤前分析完成後，必須同步更新 tracking.json
- tracking.json 內容 = 盤前分析推薦股票
- 不能有「盤前推薦了A，但tracking記錄B」的情況
- 每日盤後驗證：tracking內容是否與盤前一致
```

**tracking.json 必須包含**：
```json
{
  "date": "2025-11-28",
  "sync_check": {
    "before_market_recommendations": ["2801", "2890", "2881"],
    "tracking_recommendations": ["2801", "2890", "2881"],
    "is_synced": true
  },
  "recommendations": [...]
}
```

---

### 檢查清單（每次分析必查）

**盤前分析**：
- [ ] 查詢了全市場法人數據？
- [ ] 輸出了買超TOP15 + 賣超TOP15？
- [ ] 從TOP15中評分推薦（不是主觀選股）？
- [ ] tracking.json 已同步更新？

**盤中分析**：
- [ ] 輸出了異動TOP10？
- [ ] 標註了「盤前推薦」vs「非盤前推薦」？
- [ ] 非盤前推薦股票只記錄、不建議追高？

**盤後分析**：
- [ ] 輸出了漲幅TOP10？
- [ ] 輸出了法人買超TOP15（明日用）？
- [ ] 驗證了tracking與盤前推薦是否一致？

---

## 核心規範速查

### 🎯 絕對禁止（歷史血淚教訓）

| 禁令 | 錯誤案例 | 用戶反饋 |
|------|---------|---------|
| **❌ 事後諸葛** | 盤中說「創意+9.84%」但盤前沒預測 | 「爆漲的你從來沒預估成功，那你說個屁哦」 |
| **❌ 追高推薦** | 推薦已漲+20%的旺宏、+16%華邦電 | 「你說的這幾隻都正在漲欸」 |
| **❌ 主觀選股** | 只給台積電、鴻海，遺漏聯電+16K | 用戶要求全市場掃描，我卻主觀篩選 |
| **❌ 過早判定** | 盤中預測當日收盤驗證 | 晟銘電11/11收-0.36%→11/12收+5.82% |

### ✅ 必須執行（強制規範）

#### 1. 法人數據查詢（第一步）
```python
# 當用戶問「法人數據」「法人動向」時
url = 'https://www.twse.com.tw/rwd/en/fund/T86?date=YYYYMMDD&selectType=ALL&response=json'

# 必須輸出：
📈 買超TOP15（依三大法人合計排序）
📉 賣超TOP15（依三大法人合計排序）

# 絕對禁止：
❌ 只查持股中的5-10檔
❌ 只查台積電、鴻海等熟悉股票
❌ 主觀認為「這些比較重要」
```

**輸出格式**：
```
代號   名稱    三大法人   投信    自營商   外資(推)   解讀
2303  聯電    +16,866   +8,234   +523    +8,109   半導體受惠AI
```

**分析重點**：
- 哪些「跌但法人買」（機會）
- 哪些「漲但法人賣」（陷阱）
- 產業輪動方向

#### 2. 股票推薦規範（五維度評分制）

**推薦流程（必須執行）**：

**Step 1: 五維度評分**
```
對每檔潛在推薦股票進行五維度評分：
1️⃣ 法人數據（30%）
2️⃣ 時事現況（30%）
3️⃣ 產業邏輯（20%）
4️⃣ 價格位置（10%）
5️⃣ 技術面（10%）

總分 = Σ(各維度分數 × 權重)
```

**Step 2: 對照推薦門檻**
```
≥85分 → 強烈推薦15-20% ⭐⭐⭐⭐⭐
75-84分 → 推薦10-15% ⭐⭐⭐⭐
65-74分 → 可考慮5-10% ⭐⭐⭐
55-64分 → 觀望優先3-5% ⭐⭐
<55分 → 不推薦 ❌
```

**Step 3: 輸出推薦（使用新格式）**

參考「五維度評分系統」章節的輸出格式

**❌ 絕對禁止推薦**（不論評分高低）：
1. **已大漲股票（近5日>10%）** - 讓用戶接最後一棒
2. **盤中已爆發** - 事後諸葛無意義
3. **單一維度極低分（<30分）** - 即使總分高也有致命風險

**⚠️ 不再絕對禁止（改為扣分）**：
1. **法人對決** - 不是一票否決，看主導方+產業邏輯
2. **外資0張** - 扣分但不絕對否決，看投信力道+產業邏輯
3. **投信<10K** - 扣分但不絕對否決，看外資+時事

**推薦時機檢查表**：
- [ ] 已完成五維度評分？（✅）只看單一維度？（❌）
- [ ] 總分≥65分？（✅）<65分還推薦？（❌）
- [ ] 股票「還沒大漲」（近5日<10%）？（✅）已大漲？（❌）
- [ ] 有明確產業邏輯？（✅）只有法人買超？（❌）
- [ ] 給出五維度分數+進場條件+目標+停損？（✅）模糊推薦？（❌）

#### 3. 三階段分析標準

**時間軸**：
```
09:00前  盤前分析 → 時事40% + 法人40% + 技術20% → 預測今日有機會股票
12:30    盤中分析 → intraday_scanner.py → 尾盤策略
14:30後  盤後分析 → 簡短驗證(20%) + 預測明日有機會股票(80%)
```

**核心原則**：
- **盤前**：全市場掃描、預測**所有有機會**的股票（不限數量）、明確價位+倉位+停損+目標
- **盤中**：執行intraday_scanner.py、只分析盤前預測股、給尾盤策略
- **盤後**：簡短驗證今日(20%) + **預測明日所有有機會股票(80%)**、明確價位+倉位

**進場策略規範**：
- ❌ 錯誤：「等回檔至XX元」（強勢股不回檔）
- ✅ 正確：「09:00開盤XX元進場5-10%、若回檔至YY元加碼至15-20%」
- ❌ 錯誤：「開盤進場」（沒給價位）
- ✅ 正確：「開盤52-54元進場10-15%、停損-8%、目標58-60元」

**品質檢查清單**：
- [ ] 盤前：全市場掃描？**所有有機會股票**？明確價位+倉位+停損+目標？
- [ ] 盤中：執行scanner？只分析盤前預測股？尾盤策略？
- [ ] 盤後：簡短驗證(1-2段)？**預測明日所有有機會股票**？明確價位+倉位？

**詳細規範**：參考 `docs/ANALYSIS_STANDARDS_V2.md`（615行完整版）

---

## 數據時效與關鍵教訓

### 時效性
- **法人數據**：每日14:30-15:00公布，盤中無法取得
- **Yahoo Finance**：盤中延遲15-20分鐘
- **盤中分析**：量比>3倍、爆量為有效指標

### 🚨 歷史教訓（必看）

**過度保守災難（2025/10/01）**：
- 推薦股漲1.10% vs 警告股漲5.79%
- 教訓：動能比安全重要

**全市場掃描（2025/10/08）**：
- 法人10/07買超 → 10/08全漲（100%準確）
- 教訓：跟緊法人、視野要全面

**主觀選股災難（2025/10/13）**：
- 只給台積電、鴻海，遺漏聯電+16,866張（法人買超第一名）
- 教訓：**絕不主觀選股**

**事後諸葛災難（2025/10/21）**：
- 盤中說「創意+9.84%」但盤前沒預測
- 用戶反饋：「爆漲的你從來沒預估成功，那你說個屁哦」
- 教訓：**絕不事後諸葛**

**追高推薦災難（2025/10/28）**：
- 推薦已漲+20%旺宏、+16%華邦電
- 用戶反饋：「你說的這幾隻都正在漲欸」
- 教訓：**絕不追高推薦**、找「法人在買但還沒漲」的股票

**一票否決災難（2025/11/20）** ⚠️ **重大教訓**：
- 法人對決100%不推薦 → 錯過12檔股票（92.3%都上漲）
- 用戶質疑：「跌不買、漲不買，什麼時候買？」
- 錯誤原因：只看法人數據、忽略時事+產業邏輯
- 教訓：**不能一票否決**、需要**五維度綜合評分**
- 改進方案：建立五維度評分系統

**核心結論**：
```
動能 > 安全
跟緊法人 > 主觀判斷
全面掃描 > 只看熟悉股票
提前佈局 > 事後諸葛
還沒漲 > 已經漲
綜合評分 > 一票否決（新增 2025/11/20）
```

---

## 盤中量能分析工具

### 🆕 新版v2（推薦使用）- intraday_analyzer_v2.py

**執行方式**：
```bash
python3 intraday_analyzer_v2.py
```

**核心特色**：
- ✅ 防止事後諸葛：只分析tracking.json中的盤前推薦股
- ✅ 五維度評分：綜合法人+時事+產業+價格+技術
- ✅ 明確策略：給出進場價、倉位、停損、目標
- ✅ 追高警告：盤中漲幅>3%自動標註不追高

**使用流程**：
1. 盤前分析完成 → 自動建立 `tracking_YYYY-MM-DD.json`
2. 12:30執行 `python3 intraday_analyzer_v2.py`
3. 讀取tracking檔案 → 只分析盤前推薦股票
4. 五維度評分 → 給出尾盤策略

**輸出範例**：
```
⭐⭐⭐⭐⭐ 強力推薦（85分以上）- 可尾盤進場
----------------------------------------
永豐金(2890) - 總分：88分
  盤前推薦價：27.0元
  盤中價位：26.8元（+1.5%）
  量比：2.0x

  五維度評分：
    📊 法人數據：27分（昨日投信+9.3K）
    🌍 時事現況：27分
    🏭 產業邏輯：14分
    💰 價格位置：12分（盤中+1.5%，小漲可買）
    📈 技術面：8分（量比2.0x）

  🎯 尾盤策略：
    進場價：26.6-27.0元
    倉位：15-20%
    停損：26.0元（-2%）
    目標：27.5元（+2%，尾盤）
```

**防止事後諸葛機制**：
- 若tracking.json不存在 → 無法執行，提示先做盤前分析
- 只分析tracking中的股票 → 絕不提tracking外的股票
- 完全避免「盤前沒推薦、盤中說漲」的事後諸葛

---

### 舊版（保留備用）- intraday_scanner.py

**為什麼需要？**
**問題**：盤前預測常常「已經在漲了」，錯過最佳進場時機
**解決**：12:30執行，找「法人正在佈局、但還沒大漲」的機會股

**⚠️ 限制**：
- 使用一票否決制（法人對決=觀望）
- 無五維度評分
- 無追蹤機制（可能事後諸葛）

### 核心邏輯
```
昨日法人買超 + 今日爆量(3x) + 小漲(<3%) = ✅ 法人吸貨中（機會）
昨日法人買超 + 今日爆量(3x) + 大漲(>5%) = ❌ 已大漲（太晚）
昨日法人賣超 + 今日爆量(3x) + 下跌 = ❌ 法人出貨（避開）
```

### 使用流程

**Step 1: 執行掃描**
```bash
python3 intraday_scanner.py
```

**Step 2: 解讀結果**
| 結果 | 判斷 | 行動 |
|------|------|------|
| ✅ 吸貨中（機會） | 法人佈局、還沒被發現 | 尾盤12:30-13:00進場 |
| ⚠️ 偏強（觀望） | 已漲一些 | 等回檔 |
| ❌ 已大漲（太晚） | 追高陷阱 | 不進場 |
| ⚠️ 法人對決 | 投信vs外資分歧 | 等盤後數據 |

**Step 3: 驗證數據（重要）**
```bash
# 驗證昨日法人數據
python3 check_institutional.py 2883 20251111

# 對照券商軟體股價量能
```

### 數據來源與限制
- **法人數據**：證交所API（前一日）
- **股價量能**：Yahoo Finance（延遲15-20分鐘）
- **掃描範圍**：約50檔主要標的
- **⚠️ 必須驗證**：不可盲目相信，務必對照券商軟體

### 注意事項
1. **絕不盲目跟單** - 必須對照券商軟體
2. **停損紀律** - 進場必設停損-8%
3. **資金控管** - 單檔不超過總資金20%

---

## 盤中量能分析邏輯

### 量能定義
- **爆量**：成交量 > 5日均量 3倍
- **大量**：成交量 > 5日均量 2倍
- **縮量**：成交量 < 5日均量 0.5倍

### 量價關係矩陣（推測法人意圖）

| 量能 | 價格 | 昨日法人 | 推測 | 策略 |
|------|------|----------|------|------|
| 爆量 | 大漲 | 買超 | ✅ 法人續買、主升段 | 尾盤可追 |
| 爆量 | 小漲/平 | 買超 | ✅ 法人吸貨中 | 尾盤可買 |
| 爆量 | 下跌 | 買超 | ⚠️ 法人接刀失敗 | 觀望 |
| 爆量 | 下跌 | 賣超 | ❌ 法人出貨 | 避開 |
| 縮量 | 上漲 | 買超 | ⚠️ 量價背離 | 不追 |
| 縮量 | 下跌 | 賣超 | ❌ 法人棄守 | 避開 |

### 盤中分析流程

**Step 1: 只看預測的6-10檔**（絕不事後諸葛）
```
盤前預測：華邦電、鴻海、國巨、聯電、台積電、南亞科
盤中只分析這6檔
絕不說「創意+9.84%」（因為盤前沒預測）
```

**Step 2: 量能異常偵測**
```
華邦電 (2344)
├─ 成交量：爆量5倍
├─ 價格：-2.27%
├─ 昨日法人：買超+569K
└─ 推測：法人接刀失敗 → 避開觀望
```

**Step 3: 尾盤策略輸出**
```
✅ 可買：國巨（法人續買）、鴻海（AI動能）
⚠️ 觀察：華邦電（等盤後法人數據）
❌ 避開：聯電（量能不足）
```

### 絕對禁止的盤中行為
1. **事後諸葛** - ❌「創意+9.84%，因為ASIC設計受惠AI」
2. **大量解釋** - ❌「華邦電失敗原因：記憶體復甦緩慢...」（簡單說「失敗」即可）
3. **追高建議** - ❌「創意可追1,650元」（盤前沒預測）

---

## 盤前時事分析

### 時事權重：40%
時事影響市場預期，必須納入分析

### 必查來源
**國際面**：
- 美股表現（那斯達克、費半指數）
- 重大數據（CPI、非農、Fed決議）
- 地緣政治（美中科技戰、台海局勢）

**產業面**：
- 法說會/財報（台積電、聯發科、鴻海）
- 產業新聞（AI訂單、記憶體價格、設備出貨）
- 客戶動態（蘋果、輝達、特斯拉）

### 分析原則
```
✅ 正確：費半+1.58%、輝達創高 → 利多台積電、聯發科 → 今日佈局這些標的
❌ 錯誤：只看法人數據、不看時事
❌ 錯誤：摘要新聞但沒給投資判斷
❌ 錯誤：看了時事但預測股票與時事無關
```

---

## 數據驗證與品質控制

| 類別 | 範例 | 標註 |
|------|------|------|
| ✅ **可驗證** | Yahoo Finance股價、證交所法人數據 | 註明來源時間 |
| ⚠️ **無法驗證** | 市場傳言、主觀觀察 | 明確標註警告 |
| ❌ **絕對禁止** | 編造法人數據、假冒官方來源 | 用戶質疑立即修正 |

---

## 參考文件

**核心規範**（必讀）：
- `CLAUDE.md` - 本文件（主規範，包含所有核心流程）

**詳細規範**（需要時參考）：
- `docs/FIVE_DIMENSIONS_SCORING.md` - 五維度評分系統完整版+實戰案例
- `docs/PREDICTION_ACCURACY_TRACKING.md` - 預測追蹤記錄

**範本文件**：
- `templates/before_market_template.md` - 盤前分析範本
- `templates/after_market_template.md` - 盤後分析範本
- `templates/weekly_report_template.md` - 週報範本

**輔助文件**（偶爾參考）：
- `docs/ENHANCED_SYSTEM_USAGE.md` - 追蹤系統使用指南
- `docs/MARKET_NEWS_CHECKLIST.md` - 時事檢查清單
- `docs/COMMAND_REFERENCE.md` - 完整指令參考

---

**最後更新**：2025-11-28
**版本**：v4.0（新增全面客觀分析原則）
**重大更新**：
- 🆕 **全面客觀分析原則**：盤前/中/後都必須輸出TOP榜單，確保客觀
- 🆕 **盤中新規範**：全市場異動TOP10，標註「盤前推薦」vs「非盤前推薦」
- 🆕 **tracking同步檢查**：確保tracking.json與盤前推薦一致
**歷史功能**：
- ✅ 雙軌評分系統（時事軌+法人軌）
- ✅ 雙層推薦系統（穩健型+爆發型）
- ✅ 個股追蹤、週報、產業分類

