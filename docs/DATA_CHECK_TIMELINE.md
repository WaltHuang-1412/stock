# 數據檢查時間軸 - 什麼時候檢查資料正確性

**建立日期**：2025-11-20
**目的**：明確所有數據檢查的時間點和責任歸屬

---

## 🎯 核心原則

### 誰負責檢查什麼？

```
┌─────────────────────────────────────┐
│  數據檢查責任分工                    │
└─────────────────────────────────────┘

AI（我）的責任：
- ✅ 分析前列出數據來源
- ✅ 執行check_institutional.py驗證
- ✅ 標註外資0張股票
- ✅ 提供驗證連結

用戶（你）的責任：
- ✅ 驗證數據來源日期正確
- ✅ 點擊連結對照TOP3股票
- ✅ 批准或拒絕分析
- ✅ 對照券商軟體

系統自動檢查：
- ✅ stock_tracker.py捕捉錯誤
- ✅ check_institutional.py驗證API數據
```

---

## 📅 完整檢查時間軸

### ⏰ 時間點1：盤前分析前（09:00前）

#### 誰檢查：AI + 用戶

**我（AI）必須做**：
```markdown
1️⃣ 列出數據來源（強制執行）

我即將執行盤前分析：

📊 數據來源：
- 法人數據：2025/11/19（證交所API）
  連結：https://www.twse.com.tw/rwd/en/fund/T86?date=20251119&selectType=ALL&response=json

- 美股數據：2025/11/19收盤（Yahoo Finance）
  NASDAQ：+0.6%、S&P500：+0.4%

- 台股即時：2025/11/20 08:30（預估開盤）

2️⃣ 執行check_institutional.py驗證推薦股票

推薦股票驗證：
- 南亞(1303)：
  python3 check_institutional.py 1303 20251119
  → 外資：+9,841張 ✅ (不是0張)
  → 投信：+8,234張 ✅ (>10K)
  → 三大法人：+18,075張 ✅

3️⃣ 標註外資0張股票

⚠️ 外資0張陷阱：
- 中信金(2891)：外資0張
- 元大金(2885)：外資0張
- 永豐金(2890)：外資0張
→ 這些股票不推薦

4️⃣ 等待批准

✋ 請驗證以上數據，確認後回覆「OK」
```

**你（用戶）必須做**：
```
□ 檢查日期正確（11/19是前一日）
□ 點擊證交所連結，對照TOP3股票數字
□ 執行check_institutional.py驗證1-2檔
□ Google搜尋NASDAQ確認方向
□ 檢查推薦邏輯合理

✅ 都通過 → 回覆「OK」
❌ 有問題 → 質疑我
```

**觸發條件**：
- ✅ 用戶說「盤前分析」
- ✅ 開始任何盤前分析工作

**檢查項目**：
| 項目 | AI檢查 | 用戶檢查 | 必須執行 |
|------|--------|---------|---------|
| 法人數據日期 | ✅ | ✅ | 是 |
| 數據來源連結 | ✅ | ✅ | 是 |
| 外資0張驗證 | ✅ | ✅ | 是 |
| 推薦股票驗證 | ✅ | ⚠️ | 是 |
| 美股數據 | ✅ | ⚠️ | 建議 |

**檢查失敗怎麼辦**：
```
用戶：「等等，日期錯了，應該是11/19不是11/18」

我：「立即修正！重新查詢11/19數據...」
（重新執行步驟1-4）
```

---

### ⏰ 時間點2：推薦每一檔股票時

#### 誰檢查：AI（強制）

**我（AI）必須做**：
```bash
# 推薦南亞前，必須執行
python3 check_institutional.py 1303 20251119

# 檢查輸出：
# - 外資不是0張？
# - 投信買超>10K？
# - 三大法人合計>15K？

# 確認無誤才推薦
```

**觸發條件**：
- ✅ **任何推薦股票前**（100%執行）
- ✅ 盤前分析推薦
- ✅ 盤中分析推薦
- ✅ 盤後分析預測明日

**檢查項目**：
- [ ] 外資是否0張？（是→不推薦）
- [ ] 投信買超是否>10K？（否→檢查是否有特殊理由）
- [ ] 法人是否對決？（是→不推薦）
- [ ] 數據與API一致？（否→以check_institutional.py為準）

**我不會做的事**：
❌ 跳過驗證直接推薦
❌ 只看API數據不用check_institutional.py
❌ 推薦外資0張股票

---

### ⏰ 時間點3：盤中分析前（12:30）

#### 誰檢查：系統自動 + AI

**系統自動檢查**（intraday_scanner.py）：
```python
# 程式會自動檢查：
- Yahoo Finance是否連接成功
- 股價數據是否可用
- 量比計算是否正常

# 若失敗會輸出警告：
⚠️ 無法獲取股價數據
⚠️ Yahoo Finance延遲，建議對照券商軟體
```

**我（AI）必須做**：
```markdown
執行intraday_scanner.py後：

1️⃣ 檢查輸出合理性
- 量比是否合理（不會>10x）
- 漲跌幅是否合理（不會單日>20%）
- 法人數據日期正確（昨日數據）

2️⃣ 標註警告
⚠️ Yahoo Finance延遲15-20分鐘，僅供參考
⚠️ 必須對照券商軟體驗證

3️⃣ 只分析盤前預測的股票
❌ 不事後諸葛
```

**你（用戶）必須做**：
```
□ 對照券商軟體驗證股價
□ 對照券商軟體驗證量能
□ 判斷機會股是否真的爆量
```

**觸發條件**：
- ✅ 用戶說「盤中分析」
- ✅ 執行intraday_scanner.py

**檢查項目**：
- [ ] 股價數據可用
- [ ] 量能數據合理
- [ ] 只分析盤前預測股
- [ ] 對照券商軟體

---

### ⏰ 時間點4：盤後分析前（14:30後）

#### 誰檢查：AI

**我（AI）必須做**：
```markdown
1️⃣ 確認法人數據已公布

現在時間：15:30
法人數據公布時間：14:30-15:00

✅ 數據已公布，可執行分析
或
⚠️ 數據尚未公布（14:45），建議15:00後再執行

2️⃣ 列出數據來源

📊 數據來源：
- 法人數據：2025/11/20（證交所API）
  連結：https://www.twse.com.tw/rwd/en/fund/T86?date=20251120&selectType=ALL&response=json

3️⃣ 執行stock_tracker.py更新追蹤

python3 scripts/stock_tracker.py

檢查輸出：
✅ 南亞(1303): 56.2元 (+7.05%) - 法人買超+3,421張

4️⃣ 驗證追蹤數據合理性
- 股價是否合理（對照昨收）
- 漲跌幅計算正確
- 法人數據已更新
```

**觸發條件**：
- ✅ 用戶說「盤後分析」
- ✅ 每日14:30後（最好15:00後）

**檢查項目**：
- [ ] 法人數據已公布（15:00後）
- [ ] stock_tracker.py執行成功
- [ ] 追蹤股票數據合理
- [ ] 預測明日股票已驗證

---

### ⏰ 時間點5：追蹤更新時（每日15:00後）

#### 誰檢查：系統自動

**系統自動檢查**（stock_tracker.py）：
```python
# 程式會自動捕捉錯誤：

def get_stock_price(stock_code):
    try:
        # 獲取股價
        ticker = f"{stock_code}.TW"
        stock = yf.Ticker(ticker)
        hist = stock.history(period="1d")

        if hist.empty:
            print(f"⚠️ {stock_code} 無法獲取股價數據")
            return None  # ✅ 自動處理錯誤

    except Exception as e:
        print(f"❌ {stock_code} 獲取股價失敗: {e}")
        return None  # ✅ 自動處理錯誤

# 法人數據也是類似處理
def get_institutional_data_safe(stock_code, date):
    try:
        # 獲取法人數據
        data = get_institutional_data(stock_code, date)
        if not data:
            print(f"⚠️ {stock_code} 法人數據不可用")
            return None  # ✅ 自動處理錯誤
    except Exception as e:
        print(f"❌ {stock_code} 獲取法人數據失敗: {e}")
        return None
```

**你（用戶）必須做**：
```
□ 查看輸出是否有⚠️或❌警告
□ 若有錯誤，對照券商軟體手動驗證
□ 檢查股價是否合理
```

**觸發條件**：
- ✅ 每日執行 `python3 scripts/stock_tracker.py`
- ✅ 自動檢查所有追蹤中股票

**檢查項目**：
- [ ] Yahoo Finance連接成功
- [ ] 證交所API連接成功
- [ ] 股價數據合理
- [ ] 法人數據已公布
- [ ] 漲跌幅計算正確

**檢查失敗怎麼辦**：
```
輸出：
⚠️ 南亞(1303) 無法獲取股價數據

你的行動：
1. 檢查網路連接
2. 對照券商軟體手動記錄股價
3. 稍後重新執行
```

---

### ⏰ 時間點6：週報製作前（週五15:00後）

#### 誰檢查：AI + 用戶

**我（AI）必須做**：
```markdown
1️⃣ 回顧本週所有分析

本週推薦股票：
- 11/18：南亞(1303)、台積電(2330)
- 11/19：無推薦
- 11/20：聯電(2303)

2️⃣ 檢查追蹤記錄

data/tracking/:
- tracking_2025-11-18.json（南亞、台積電）
- tracking_2025-11-20.json（聯電）

3️⃣ 驗證績效計算

南亞：推薦52.5元 → 週五收盤56.2元 → +7.0% ✅
台積電：推薦1405元 → 週五收盤1425元 → +1.4% ✅
聯電：推薦44.5元 → 週五收盤44.8元 → +0.7% ✅

準確率：3成功/3推薦 = 100%

4️⃣ 對照每日分析確認無遺漏
```

**你（用戶）必須做**：
```
□ 回顧本週盤前分析，確認推薦都已記錄
□ 對照追蹤記錄，確認績效計算正確
□ 手動驗證1-2檔股票週漲幅
□ 檢查週報統計合理
```

**觸發條件**：
- ✅ 週五製作週報
- ✅ 統計本週績效

**檢查項目**：
- [ ] 本週推薦都已記錄
- [ ] 成功/失敗分類正確
- [ ] 準確率計算正確
- [ ] 無遺漏股票

---

## 🚨 強制檢查點總覽

### 必須檢查（100%執行）

| 時間點 | 檢查項目 | 執行者 | 工具 |
|--------|---------|--------|------|
| 盤前分析前 | 數據來源日期 | AI | 列出來源 |
| 盤前分析前 | 推薦股票驗證 | AI | check_institutional.py |
| 盤前分析前 | 外資0張檢查 | AI | check_institutional.py |
| 盤前分析前 | 用戶批准 | 用戶 | 驗證連結 |
| 推薦每檔股票時 | 法人數據驗證 | AI | check_institutional.py |
| 盤後分析前 | 追蹤更新 | 系統 | stock_tracker.py |
| 追蹤更新時 | 錯誤捕捉 | 系統 | 自動try-catch |

---

### 建議檢查（強烈建議）

| 時間點 | 檢查項目 | 執行者 | 工具 |
|--------|---------|--------|------|
| 盤中分析時 | 對照券商軟體 | 用戶 | 券商軟體 |
| 盤後分析時 | 追蹤數據合理性 | 用戶 | 目視檢查 |
| 週報製作時 | 績效計算正確 | AI + 用戶 | 手動驗證 |

---

## 🔄 自動檢查 vs 手動檢查

### 自動檢查（系統執行）

**已實作**：
```python
# stock_tracker.py自動檢查
- ✅ Yahoo Finance連接失敗 → 捕捉錯誤
- ✅ 證交所API無數據 → 顯示警告
- ✅ 股價數據異常 → 返回None

# check_institutional.py自動驗證
- ✅ 外資0張 → 明確標註
- ✅ API數據錯誤 → 使用正確數據
```

**未來計劃**：
```python
# 自動驗證腳本（規劃中）
- ⏳ 追蹤記錄格式驗證
- ⏳ 價格邏輯檢查（目標價>推薦價）
- ⏳ 日期合理性檢查
- ⏳ 數據來源健康檢查
```

---

### 手動檢查（需人工執行）

**AI手動檢查**（我必須做）：
```
✅ 分析前列出數據來源
✅ 執行check_institutional.py驗證
✅ 標註外資0張股票
✅ 檢查推薦邏輯合理性
```

**用戶手動檢查**（你必須做）：
```
✅ 驗證數據日期正確（3秒）
✅ 點擊證交所連結對照（1分鐘）
✅ 批准或拒絕分析（立即）
✅ 對照券商軟體（建議）
```

---

## 📊 檢查流程圖

```
用戶說「盤前分析」
        ↓
┌────────────────────┐
│ AI：列出數據來源    │ ← 強制檢查點1
│ - 法人數據日期      │
│ - 美股數據         │
│ - 推薦範圍         │
└────────────────────┘
        ↓
┌────────────────────┐
│ AI：執行check_      │ ← 強制檢查點2
│ institutional.py   │
│ 驗證所有推薦股票    │
└────────────────────┘
        ↓
┌────────────────────┐
│ AI：提供驗證連結    │ ← 強制檢查點3
│ 等待用戶批准        │
└────────────────────┘
        ↓
┌────────────────────┐
│ 用戶：驗證數據      │ ← 強制檢查點4
│ (3-5分鐘)          │
└────────────────────┘
        ↓
    用戶回覆「OK」
        ↓
┌────────────────────┐
│ AI：撰寫完整分析    │
└────────────────────┘
```

---

## ✅ 檢查清單（列印使用）

### 盤前分析檢查

**AI檢查**（我必須做）：
```
□ 列出數據來源（法人日期、美股數據）
□ 執行check_institutional.py驗證推薦股票
□ 標註外資0張股票
□ 提供證交所連結
□ 等待用戶批准
```

**用戶檢查**（你必須做）：
```
□ 檢查日期正確（1秒）
□ 點擊連結對照TOP3（1分鐘）
□ 執行check_institutional.py驗證1檔（30秒）
□ Google NASDAQ確認方向（30秒）
□ 檢查推薦邏輯合理（1分鐘）
□ 回覆「OK」或「有問題」
```

---

### 盤後追蹤檢查

**系統自動檢查**：
```
✅ stock_tracker.py自動捕捉錯誤
✅ 無法獲取數據 → 顯示警告
```

**用戶檢查**（建議）：
```
□ 查看輸出有無⚠️警告
□ 股價是否合理（對照昨收）
□ 法人數據已更新
```

---

## 🎯 總結

### 什麼時候會檢查資料正確性？

**答案：5個時間點**

1️⃣ **盤前分析前**（強制）
   - AI列出數據來源
   - AI執行check_institutional.py
   - 用戶驗證批准

2️⃣ **推薦每檔股票時**（強制）
   - AI執行check_institutional.py
   - 驗證外資0張、法人對決

3️⃣ **盤中分析時**（自動+建議）
   - intraday_scanner.py自動檢查
   - 用戶對照券商軟體（建議）

4️⃣ **盤後分析時**（自動）
   - stock_tracker.py自動捕捉錯誤
   - 用戶檢查輸出合理性（建議）

5️⃣ **週報製作時**（手動）
   - AI回顧本週分析
   - 用戶驗證統計正確

---

### 誰負責什麼？

**AI（我）**：
- ✅ 列出數據來源（強制）
- ✅ 執行check_institutional.py（強制）
- ✅ 提供驗證連結（強制）
- ✅ 等待批准（強制）

**系統**：
- ✅ 自動捕捉錯誤（stock_tracker.py）
- ✅ 顯示警告（無法獲取數據時）

**用戶（你）**：
- ✅ 驗證數據日期（3秒）
- ✅ 點擊連結對照（1分鐘）
- ✅ 批准或拒絕（立即）
- ⚠️ 對照券商軟體（建議）

---

**系統已有多層檢查機制，但你的最終批准最重要！** ✅

---

**最後更新**：2025-11-20
**強制執行**：所有分析必須遵守
