# 系統可靠性檢查清單

**建立日期**：2025-11-20
**用途**：識別系統潛在失誤點、確保數據與時間正確性

---

## 🚨 潛在風險點評估

### 1. 數據來源可靠性

#### ⚠️ Yahoo Finance API（股價數據）

**已知問題**：
- 延遲15-20分鐘
- 偶爾無法連接（網路問題）
- 股票代碼需加.TW（台股）

**風險等級**：🟡 中等

**失誤案例**：
```python
# 錯誤：股票代碼忘記加.TW
ticker = "1303"  # ❌ 會失敗

# 正確：
ticker = "1303.TW"  # ✅
```

**防呆機制**：
```python
# stock_tracker.py 已實作
if not price_data:
    print(f"⚠️ {stock_code} 無法獲取股價數據")
    return None
```

**用戶檢查**：
- [ ] 對照券商軟體驗證股價
- [ ] 收盤後30分鐘再執行（避免數據不完整）

---

#### ⚠️ 證交所API（法人數據）

**已知問題**：
- 公布時間：14:30-15:00（**有時延遲到15:30**）
- 週末/假日無數據
- API格式偶爾改變
- **外資0張陷阱**（API顯示買超但實際0張）

**風險等級**：🔴 高

**失誤案例**：
```
2025/11/18 力積電：
- API顯示：外資+56,407張
- 實際：外資0張（check_institutional.py驗證）
- 11/19：外資大逃-25,414張
→ 若盤前推薦會虧損
```

**防呆機制**：
```bash
# 每次推薦前必須執行
python3 check_institutional.py 1303 20251120

# 驗證API數據是否正確
```

**用戶檢查**：
- [ ] **所有推薦股票都用check_institutional.py驗證**
- [ ] 外資0張 = 絕對不推薦
- [ ] 法人數據15:00後未公布 → 等待或延後分析

---

### 2. 時間戳記問題

#### ⚠️ 推薦時間 vs 數據時間不匹配

**問題場景**：
```
錯誤流程：
09:00 盤前分析，推薦南亞52.5元
→ 但實際開盤已經54元（已漲+2.9%）
→ 用戶買在54元、不是52.5元
→ 追蹤記錄顯示推薦價52.5元 ❌ 錯誤基準
```

**風險等級**：🔴 高

**防呆機制**：
```markdown
## 推薦格式必須明確標註時間

### 南亞(1303)
- **推薦時間**：2025-11-20 08:30（盤前）
- **昨收價**：51.5元
- **預估開盤**：52-54元
- **進場策略**：
  - 開盤52-54元進場10-15%
  - 若回檔至50-51元加碼至20%
  - **若開盤>55元不追高**

→ 追蹤記錄：recommend_price = 53（開盤預估中間值）
```

**用戶檢查**：
- [ ] 推薦時明確標註「預估開盤價」
- [ ] 給出「若開盤>XX元不追高」條件
- [ ] 追蹤記錄使用實際進場價（不是昨收價）

---

#### ⚠️ 法人數據日期混亂

**問題場景**：
```
2025/11/20 盤前分析：
- 使用11/19法人數據？（正確）
- 還是11/18法人數據？（錯誤）

盤後分析：
- 14:30前無11/20數據 → 只能用11/19數據
- 15:00後有11/20數據 → 應更新使用11/20數據
```

**風險等級**：🟡 中等

**防呆機制**（已實作）：
```markdown
# 分析前強制驗證流程（CLAUDE.md第81-170行）

📊 數據來源：
- 法人數據：2025/11/19（證交所API）
- 美股數據：2025/11/19收盤（Yahoo Finance）
- 台股即時：2025/11/20 08:30（預估開盤）

✋ 請確認以上數據來源和日期
```

**用戶檢查**：
- [ ] 每次分析前確認數據日期
- [ ] 盤前分析：用前一日法人數據
- [ ] 盤後分析：等15:00後再執行（確保數據已公布）

---

### 3. 個股追蹤系統特定風險

#### ⚠️ 追蹤天數計算錯誤（週末/假日）

**問題場景**：
```
推薦日：2025/11/20（週三）
追蹤7日：
- Day 1: 11/21（四）
- Day 2: 11/22（五）
- Day 3: 11/23（六）❌ 週六無交易
- Day 4: 11/24（日）❌ 週日無交易
- Day 5: 11/25（一）
- Day 6: 11/26（二）
- Day 7: 11/27（三）

問題：實際只追蹤5個交易日、不是7個交易日
```

**風險等級**：🟡 中等

**目前處理**：
```python
# stock_tracker.py 目前用「自然日」計算
days_tracked = (today_date - recommend_date).days

# ⚠️ 包含週末/假日
```

**改進方案**（建議）：
```python
# 改用「交易日」計算
def count_trading_days(start_date, end_date):
    """計算交易日數（排除週末/假日）"""
    # TODO: 整合台股交易日曆
    pass
```

**用戶檢查**：
- [ ] 目前追蹤7自然日（含週末）
- [ ] 若週五推薦 → 實際追蹤到下週五（5個交易日）
- [ ] **手動檢查7日是否包含足夠交易日**

---

#### ⚠️ 手動建立追蹤記錄時輸入錯誤

**問題場景**：
```json
{
  "stock_code": "1303",
  "recommend_price": 52.5,  // 輸入錯誤：實際開盤54元
  "target_price": 58.0,     // 計算錯誤：應該60元
  "stop_loss": 48.3         // 計算錯誤：52.5*0.92=48.3 ✅
}
```

**風險等級**：🟡 中等

**防呆機制**（建議增加）：
```python
# TODO: 追蹤記錄驗證工具
def validate_tracking_record(record):
    """驗證追蹤記錄合理性"""
    price = record['recommend_price']
    target = record['target_price']
    stop = record['stop_loss']

    # 檢查目標價>推薦價
    if target <= price:
        print(f"⚠️ 目標價{target}應大於推薦價{price}")

    # 檢查停損價約-8%
    expected_stop = price * 0.92
    if abs(stop - expected_stop) > price * 0.02:
        print(f"⚠️ 停損價{stop}偏離-8%標準（預期{expected_stop:.1f}）")
```

**用戶檢查**：
- [ ] 推薦價 = 實際進場價（不是昨收價）
- [ ] 目標價 > 推薦價
- [ ] 停損價 ≈ 推薦價 * 0.92（-8%）

---

### 4. 週報統計準確性

#### ⚠️ 本週推薦股票遺漏

**問題場景**：
```
本週推薦：
- 11/18：南亞、台積電
- 11/19：無推薦
- 11/20：聯電

週報統計：
- 只記錄南亞、台積電 ❌
- 遺漏聯電
```

**風險等級**：🟡 中等

**防呆機制**（建議）：
```bash
# 週報前先執行
grep -r "推薦" data/2025-11-18/before_market_analysis.md
grep -r "推薦" data/2025-11-19/before_market_analysis.md
grep -r "推薦" data/2025-11-20/before_market_analysis.md

# 確認所有推薦都已記錄
```

**用戶檢查**：
- [ ] 週報前回顧本週所有盤前分析
- [ ] 對照tracking/目錄確認有無遺漏
- [ ] 手動驗證推薦總數

---

### 5. 美股時間差問題

#### ⚠️ 美股財報公布時間混亂

**問題場景**：
```
輝達財報：
- 美國時間：11/19盤後公布
- 台灣時間：11/20早上05:00（台股盤前）

正確流程：
- 11/20盤前分析：可納入輝達財報 ✅

錯誤流程：
- 11/19盤後分析：納入輝達財報 ❌（還沒公布）
```

**風險等級**：🟡 中等

**防呆機制**（已實作）：
```markdown
# MARKET_NEWS_CHECKLIST.md

執行WebSearch確認時間：
- "NVIDIA earnings November 2025"
- 確認是「美國時間11/19」還是「台灣時間11/20」
```

**用戶檢查**：
- [ ] 美股財報：確認台灣時間是否已公布
- [ ] Fed決議：通常台灣時間凌晨03:00
- [ ] CPI數據：台灣時間晚上21:30

---

## ✅ 推薦的防呆檢查流程

### 盤前分析前（09:00前）

**必須執行**：
```bash
# 1. 確認今天日期
date

# 2. 確認法人數據日期
# 應該是前一日（例：11/20盤前用11/19數據）

# 3. 執行時事檢查
# 參考MARKET_NEWS_CHECKLIST.md

# 4. 列出數據來源等待批准
# 參考CLAUDE.md第81-170行
```

**檢查清單**：
- [ ] 法人數據日期正確？
- [ ] 美股數據是前一日收盤？
- [ ] 重大時事已查詢？（輝達財報、Fed等）
- [ ] 已列出數據來源等待批准？

---

### 推薦股票時（建立追蹤記錄）

**必須執行**：
```bash
# 驗證法人數據
python3 check_institutional.py 1303 20251119

# 確認：
# - 外資是否0張？
# - 投信買超數字正確？
# - 三大法人合計正確？
```

**檢查清單**：
- [ ] 已用check_institutional.py驗證？
- [ ] 外資不是0張？
- [ ] 推薦價 = 預估開盤價（不是昨收價）？
- [ ] 目標價 > 推薦價？
- [ ] 停損價 ≈ 推薦價*0.92？
- [ ] 推薦理由明確（法人數據+產業邏輯）？

---

### 盤後分析前（14:30後）

**必須執行**：
```bash
# 1. 確認法人數據已公布（15:00後較保險）
curl "https://www.twse.com.tw/rwd/en/fund/T86?date=20251120&selectType=ALL&response=json"

# 2. 執行追蹤更新
python3 scripts/stock_tracker.py

# 3. 檢查追蹤更新結果
```

**檢查清單**：
- [ ] 法人數據已公布？（15:00後）
- [ ] stock_tracker.py執行成功？
- [ ] 追蹤股票價格正確？
- [ ] 法人數據已更新？

---

### 週報製作前（週五15:00後）

**必須執行**：
```bash
# 1. 回顧本週所有盤前分析
ls data/2025-11-**/before_market_analysis.md

# 2. 檢查追蹤記錄
ls data/tracking/tracking_2025-11-*.json

# 3. 統計本週推薦
grep -r "推薦" data/2025-11-**/before_market_analysis.md
```

**檢查清單**：
- [ ] 本週所有推薦股票已記錄？
- [ ] 成功/失敗案例已分類？
- [ ] 準確率計算正確？
- [ ] 法人動向總結完整？

---

## 🔧 建議改進項目

### 短期（1週內）

**1. 追蹤記錄驗證工具**
```python
# scripts/validate_tracking.py
def validate_all_tracking_records():
    """驗證所有追蹤記錄合理性"""
    # 檢查價格邏輯
    # 檢查日期正確
    # 檢查JSON格式
```

**2. 自動建立追蹤記錄**
```python
# 盤前分析時自動執行
def create_tracking_record(stock_code, stock_name, price, ...):
    """自動建立追蹤記錄，減少人為錯誤"""
```

---

### 中期（1個月內）

**3. 交易日計算函數**
```python
def count_trading_days(start, end):
    """正確計算交易日（排除週末/假日）"""
    # 整合台股交易日曆
```

**4. 數據來源健康檢查**
```python
def health_check():
    """每日執行，檢查數據來源是否正常"""
    # Yahoo Finance連接測試
    # 證交所API測試
    # 法人數據完整性檢查
```

---

### 長期（3個月內）

**5. 完整測試套件**
```python
# tests/test_stock_tracker.py
def test_tracking_system():
    """測試追蹤系統各種邊界情況"""
    # 週末推薦
    # 假日推薦
    # 數據缺失
    # API失敗
```

**6. 異常警報機制**
```python
def alert_if_anomaly():
    """發現異常立即警報"""
    # 法人數據異常（外資0張但API顯示買超）
    # 股價異常（開盤價偏離預估>10%）
    # 追蹤失敗（無法獲取數據）
```

---

## 📊 風險等級總結

| 風險項目 | 風險等級 | 發生機率 | 影響程度 | 優先處理 |
|---------|---------|---------|---------|---------|
| Yahoo Finance延遲/失敗 | 🟡 中 | 20% | 中 | ⏳ 中期 |
| 證交所API外資0張陷阱 | 🔴 高 | 10% | 高 | ✅ 已防呆 |
| 推薦價格記錄錯誤 | 🟡 中 | 30% | 中 | 🔧 短期改進 |
| 法人數據日期混亂 | 🟡 中 | 15% | 中 | ✅ 已防呆 |
| 追蹤天數計算錯誤 | 🟡 中 | 40% | 低 | ⏳ 中期 |
| 美股時間差混亂 | 🟡 中 | 10% | 低 | ✅ 已防呆 |
| 週報統計遺漏 | 🟡 中 | 20% | 中 | 📋 檢查清單 |
| 忘記執行tracker | 🟢 低 | 50% | 低 | 📅 提醒機制 |

**整體風險等級**：🟡 **中等**

**結論**：
- ✅ 高風險項目已有防呆機制（外資0張、數據日期）
- ⚠️ 中風險項目需人工檢查（推薦價格、統計遺漏）
- 🔧 建議1週內增加驗證工具

---

## ✅ 用戶最小化錯誤指南

### 每次分析必做

1. **執行前確認日期**
   ```bash
   date
   # 確認今天是11/20還是11/21
   ```

2. **驗證法人數據**
   ```bash
   python3 check_institutional.py 1303 20251119
   # 所有推薦股票都驗證
   ```

3. **對照券商軟體**
   - 股價是否正確？
   - 法人數據是否一致？

### 推薦股票必做

1. **明確標註時間與價格**
   ```markdown
   推薦時間：2025-11-20 08:30（盤前）
   昨收價：51.5元
   預估開盤：52-54元
   若開盤>55元不追高
   ```

2. **檢查價格邏輯**
   - 目標價 > 推薦價 ✅
   - 停損價 ≈ 推薦價*0.92 ✅

### 每日盤後必做

1. **執行追蹤更新**
   ```bash
   python3 scripts/stock_tracker.py
   ```

2. **檢查輸出合理性**
   - 股價是否正確？
   - 漲跌幅計算正確？
   - 法人數據已更新？

---

**最後更新**：2025-11-20
**下次檢討**：發現任何錯誤立即更新本文件
